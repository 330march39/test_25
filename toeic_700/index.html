<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TOEIC 700 Booster Pro</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e32' }
                    },
                    animation: {
                        'bounce-short': 'bounce 0.5s ease-in-out 1',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-in-right': 'slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'progress': 'progress 1s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        progress: {
                            '0%': { width: '0%' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            touch-action: manipulation;
        }
        
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .selectable-text {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }

        .glass-panel {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        .gold-text {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 2px 4px rgba(217, 119, 6, 0.1);
        }

        .btn-press { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.1s, box-shadow 0.1s; }
        .btn-press:active { transform: scale(0.96); opacity: 0.9; }

        .theme-transition {
            transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;
        }

        /* Circle Progress for Result */
        .circular-chart {
            display: block;
            margin: 0 auto;
            max-width: 80%;
            max-height: 250px;
        }
        .circle-bg {
            fill: none;
            stroke: #eee;
            stroke-width: 3.8;
        }
        .dark .circle-bg {
            stroke: #334155;
        }
        .circle {
            fill: none;
            stroke-width: 2.8;
            stroke-linecap: round;
            animation: progress 1.5s ease-out forwards;
        }
        .percentage {
            fill: #666;
            font-family: sans-serif;
            font-weight: bold;
            font-size: 0.5em;
            text-anchor: middle;
        }
        .dark .percentage { fill: #fff; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-slate-800 dark:text-slate-100 theme-transition h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, createContext, useContext } = React;

        // ==========================================
        // AUDIO SYSTEM
        // ==========================================
        const SoundContext = createContext();
        const SoundProvider = ({ children, enabled }) => {
            const audioCtxRef = useRef(null);
            const playTone = (freq, type, duration, vol = 0.1) => {
                if (!enabled) return;
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!audioCtxRef.current) audioCtxRef.current = new AudioContext();
                    const ctx = audioCtxRef.current;
                    if (ctx.state === 'suspended') ctx.resume();
                    
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, ctx.currentTime);
                    gain.gain.setValueAtTime(vol, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start();
                    osc.stop(ctx.currentTime + duration);
                } catch(e) { console.error(e); }
            };

            const playSFX = (type) => {
                if (!enabled) return;
                if (navigator.vibrate) {
                    if (type === 'wrong') navigator.vibrate(200);
                    if (type === 'correct') navigator.vibrate(50);
                    if (type === 'click') navigator.vibrate(10);
                }
                switch (type) {
                    case 'correct':
                        playTone(600, 'sine', 0.1, 0.1);
                        setTimeout(() => playTone(1200, 'sine', 0.2, 0.1), 50);
                        break;
                    case 'wrong':
                        playTone(150, 'sawtooth', 0.3, 0.15);
                        setTimeout(() => playTone(100, 'sawtooth', 0.3, 0.15), 100);
                        break;
                    case 'click':
                        playTone(800, 'triangle', 0.05, 0.03);
                        break;
                    case 'complete':
                        playTone(400, 'sine', 0.1);
                        setTimeout(() => playTone(500, 'sine', 0.1), 100);
                        setTimeout(() => playTone(600, 'sine', 0.1), 200);
                        setTimeout(() => playTone(800, 'sine', 0.4), 300);
                        break;
                    default: break;
                }
            };
            return <SoundContext.Provider value={playSFX}>{children}</SoundContext.Provider>;
        };

        // ==========================================
        // DATA
        // ==========================================
        // (Simplified data set for brevity, same structure as before)
        const VOCAB_DATA = [
            { id: 'v1', level: 600, word: "significant", meaning: "かなりの、重要な", type: "vocab", choices: ["一時的な", "微細な", "疑わしい"] },
            { id: 'v2', level: 600, word: "appointment", meaning: "約束、予約、任命", type: "vocab", choices: ["失望", "許可", "評価"] },
            { id: 'v3', level: 730, word: "tentative", meaning: "仮の、暫定的な", type: "vocab", choices: ["断定的な", "永久の", "高価な"] },
            { id: 'v4', level: 730, word: "comply", meaning: "（規則などに）従う", type: "vocab", choices: ["不満を言う", "完了する", "比較する"] },
            { id: 'v5', level: 860, word: "imminent", meaning: "差し迫った", type: "vocab", choices: ["無関係な", "巨大な", "不変の"] },
            { id: 'v6', level: 860, word: "lucrative", meaning: "儲かる、利益の上がる", type: "vocab", choices: ["不運な", "創造的な", "緩やかな"] },
            { id: 'v7', level: 600, word: "inventory", meaning: "在庫、棚卸し", type: "vocab", choices: ["投資", "招待状", "発明"] },
            { id: 'v8', level: 730, word: "reimburse", meaning: "払い戻す", type: "vocab", choices: ["再利用する", "強化する", "輸入する"] },
            { id: 'v9', level: 600, word: "proposal", meaning: "提案", type: "vocab", choices: ["処分", "目的", "反対"] },
            { id: 'v10', level: 730, word: "itinerary", meaning: "旅程表", type: "vocab", choices: ["日記", "入り口", "要約"] },
            { id: 'v11', level: 860, word: "consecutive", meaning: "連続した", type: "vocab", choices: ["建設的な", "保守的な", "結果的な"] },
            { id: 'v12', level: 900, word: "scrutinize", meaning: "綿密に調べる", type: "vocab", choices: ["要約する", "拡大する", "配布する"] }
        ];

        const READING_DATA = [
             { 
                id: 'r1', type: 'reading',
                question: "Ms. Tanaka _______ the budget proposal before the meeting started.", 
                choices: ["reviewed", "reviewing", "reviews", "review"], 
                correct: 0, 
                explanation: "「before...」の節が過去形なので、主節も過去の話。単数主語Ms. Tanakaに対する過去形の動詞reviewedが正解。" 
            },
            { 
                id: 'r2', type: 'reading',
                question: "The new software is _______ easier to use than the old one.", 
                choices: ["significantly", "significant", "significance", "signify"], 
                correct: 0, 
                explanation: "比較級easierを修飾できるのは副詞のみ。significantly（かなり）が正解。" 
            }
        ];

        const LISTENING_DATA = [
            {
                id: 'l1', type: 'listening',
                script: "Where did you put the monthly report?",
                options: ["It's on your desk.", "At 3 o'clock.", "Yes, I did."],
                correct: 0,
                explanation: "Where（場所）を聞いているので、場所（on your desk）を示しているAが正解。"
            },
            {
                id: 'l2', type: 'listening',
                script: "Why hasn't the shipment arrived yet?",
                options: ["No, I haven't.", "Because of the heavy snow.", "Usually by truck."],
                correct: 1,
                explanation: "Why（理由）を聞いているので、原因（heavy snow）を説明しているBが正解。"
            }
        ];

        // ==========================================
        // UTILS
        // ==========================================
        const speak = (text) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                // Try to find a good voice
                const voices = window.speechSynthesis.getVoices();
                const enVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Samantha')) || 
                                voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) ||
                                voices.find(v => v.lang === 'en-US');
                if (enVoice) utterance.voice = enVoice;
                utterance.rate = 0.9; // Slightly slower for clarity
                window.speechSynthesis.speak(utterance);
            }
        };

        const shuffleArray = (array) => {
            return array.map(value => ({ value, sort: Math.random() }))
                        .sort((a, b) => a.sort - b.sort)
                        .map(({ value }) => value);
        };

        // ==========================================
        // COMPONENTS
        // ==========================================

        const Icon = ({ name, size = 24, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;

        const Button = ({ children, onClick, className = "", variant = "primary", disabled = false, fullWidth = false }) => {
            const playSFX = useContext(SoundContext);
            
            const baseClass = `relative px-4 py-3.5 rounded-2xl font-bold flex items-center justify-center gap-2 btn-press no-select disabled:opacity-50 disabled:pointer-events-none transition-all duration-300 ${fullWidth ? 'w-full' : ''}`;
            
            const variants = {
                primary: "bg-yellow-500 hover:bg-yellow-400 text-slate-900 shadow-lg shadow-yellow-500/20 border border-yellow-400",
                secondary: "bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600",
                glass: "glass-panel border border-white/20 dark:border-slate-600 text-slate-800 dark:text-white hover:bg-white/40 dark:hover:bg-slate-700/50",
                ghost: "text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800",
                danger: "bg-red-500 text-white shadow-lg shadow-red-500/20"
            };

            const handleClick = (e) => {
                if (!disabled) {
                    playSFX('click');
                    if (onClick) onClick(e);
                }
            };

            return (
                <button onClick={handleClick} className={`${baseClass} ${variants[variant]} ${className}`} disabled={disabled}>
                    {children}
                </button>
            );
        };

        const Toggle = ({ checked, onChange }) => (
            <div 
                className={`w-14 h-8 flex items-center bg-gray-300 dark:bg-slate-700 rounded-full p-1 cursor-pointer transition-all duration-300 border border-transparent ${checked ? 'bg-yellow-500 dark:bg-yellow-500 border-yellow-400' : ''}`}
                onClick={onChange}
            >
                <div className={`bg-white w-6 h-6 rounded-full shadow-md transform transition-transform duration-300 ease-spring ${checked ? 'translate-x-6' : ''}`}></div>
            </div>
        );

        const Header = ({ title, sub, leftIcon, onLeftClick, rightAction }) => (
            <div className="flex items-center justify-between p-4 glass-panel sticky top-0 z-30 border-b border-gray-200/50 dark:border-slate-800/50 no-select transition-all">
                <div className="flex items-center gap-3">
                    {leftIcon && (
                        <button onClick={onLeftClick} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700/50 transition">
                            <Icon name={leftIcon} className="w-6 h-6 text-slate-600 dark:text-slate-300" />
                        </button>
                    )}
                    <div>
                        <h1 className="text-lg font-bold text-slate-800 dark:text-slate-100 leading-tight tracking-tight">{title}</h1>
                        {sub && <p className="text-xs text-slate-500 dark:text-slate-400 font-medium">{sub}</p>}
                    </div>
                </div>
                {rightAction && <div>{rightAction}</div>}
            </div>
        );

        // ==========================================
        // COUNTDOWN WIDGET
        // ==========================================
        const CountdownWidget = () => {
            const [timeLeft, setTimeLeft] = useState(null);
            const TARGET_DATE = new Date("2026-01-23T00:00:00+09:00"); // JST

            useEffect(() => {
                const calculateTime = () => {
                    const now = new Date();
                    const diff = TARGET_DATE - now;

                    if (diff <= 0) {
                        return null;
                    }

                    return {
                        days: Math.floor(diff / (1000 * 60 * 60 * 24)),
                        hours: Math.floor((diff / (1000 * 60 * 60)) % 24),
                        minutes: Math.floor((diff / 1000 / 60) % 60),
                    };
                };

                setTimeLeft(calculateTime());
                const timer = setInterval(() => {
                    setTimeLeft(calculateTime());
                }, 60000); // Update every minute is enough for this UI

                return () => clearInterval(timer);
            }, []);

            if (!timeLeft) return null;

            return (
                <div className="mx-4 mb-6 mt-2 relative group animate-slide-up">
                    <div className="absolute inset-0 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-2xl blur opacity-20 group-hover:opacity-30 transition duration-500"></div>
                    <div className="relative glass-panel bg-white/80 dark:bg-slate-800/80 p-4 rounded-2xl border border-yellow-500/30 flex items-center justify-between shadow-lg">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 rounded-full bg-yellow-100 dark:bg-yellow-900/30 flex items-center justify-center text-yellow-600 dark:text-yellow-500">
                                <Icon name="flag" size={20} />
                            </div>
                            <div>
                                <p className="text-xs font-bold text-yellow-600 dark:text-yellow-500 uppercase tracking-wide">TOEIC Exam Day</p>
                                <p className="text-sm text-slate-500 dark:text-slate-400">2026.01.23 (金)</p>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-2xl font-black text-slate-800 dark:text-white leading-none font-mono">
                                {timeLeft.days}<span className="text-xs font-sans font-normal ml-1">日</span>
                            </div>
                            <div className="text-xs text-slate-500 dark:text-slate-400 font-mono">
                                {timeLeft.hours}H {timeLeft.minutes}M
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // COURSE SELECTION
        // ==========================================
        const CourseSelection = ({ type, onSelect, onBack }) => {
            const getCourses = () => {
                if (type === 'vocab') {
                    return [
                        { id: 'all', title: '全レベル総合', sub: 'ランダムに出題', icon: 'layers', color: 'text-blue-500', bg: 'bg-blue-100 dark:bg-blue-900/30' },
                        { id: 'weak', title: '苦手克服', sub: '未習得の単語のみ', icon: 'target', color: 'text-red-500', bg: 'bg-red-100 dark:bg-red-900/30' },
                        { id: '600', title: 'Level 600', sub: '基礎・必須レベル', icon: 'zap', color: 'text-green-500', bg: 'bg-green-100 dark:bg-green-900/30' },
                        { id: '730', title: 'Level 730', sub: 'ビジネス標準', icon: 'briefcase', color: 'text-yellow-500', bg: 'bg-yellow-100 dark:bg-yellow-900/30' },
                        { id: '860', title: 'Level 860+', sub: 'ハイスコア・難関', icon: 'award', color: 'text-purple-500', bg: 'bg-purple-100 dark:bg-purple-900/30' },
                    ];
                } else if (type === 'reading') {
                    return [
                        { id: 'all', title: 'Part 5 演習', sub: '全範囲からランダム', icon: 'book-open', color: 'text-blue-500', bg: 'bg-blue-100 dark:bg-blue-900/30' },
                    ];
                } else {
                    return [
                        { id: 'all', title: 'Part 2 応答', sub: '全範囲からランダム', icon: 'headphones', color: 'text-green-500', bg: 'bg-green-100 dark:bg-green-900/30' },
                    ];
                }
            };

            const courses = getCourses();

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-slate-900 animate-slide-in-right">
                    <Header title="コース選択" sub="学習モードを選んでください" leftIcon="arrow-left" onLeftClick={onBack} />
                    <div className="p-4 space-y-3 overflow-y-auto pb-20">
                        {courses.map((course, idx) => (
                            <button 
                                key={course.id}
                                onClick={() => onSelect(course.id)}
                                className="w-full bg-white dark:bg-slate-800 p-4 rounded-2xl text-left border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-lg transition-all btn-press flex items-center gap-4 group"
                                style={{ animationDelay: `${idx * 50}ms` }}
                            >
                                <div className={`w-14 h-14 rounded-2xl flex items-center justify-center ${course.bg} group-hover:scale-110 transition-transform duration-300`}>
                                    <Icon name={course.icon} className={course.color} size={26} />
                                </div>
                                <div className="flex-1">
                                    <h3 className="font-bold text-lg text-slate-800 dark:text-slate-100">{course.title}</h3>
                                    <p className="text-xs text-slate-500">{course.sub}</p>
                                </div>
                                <div className="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-700 flex items-center justify-center">
                                    <Icon name="chevron-right" className="text-slate-400" size={18} />
                                </div>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // ==========================================
        // RESULT SCREEN
        // ==========================================
        const ResultScreen = ({ score, total, onRetry, onHome }) => {
            const percentage = Math.round((score / total) * 100);
            const radius = 36;
            const circumference = 2 * Math.PI * radius;
            const dashoffset = circumference - (percentage / 100) * circumference;

            let rank = 'C';
            let message = "Keep Going!";
            let color = "#94a3b8"; // slate

            if (percentage >= 100) { rank = 'S'; message = "Perfect!!"; color = "#eab308"; } // yellow
            else if (percentage >= 80) { rank = 'A'; message = "Excellent!"; color = "#22c55e"; } // green
            else if (percentage >= 60) { rank = 'B'; message = "Good Job!"; color = "#3b82f6"; } // blue

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-slate-900 animate-fade-in relative overflow-hidden">
                    {/* Confetti-like background elements */}
                    {percentage >= 80 && (
                        <>
                            <div className="absolute top-10 left-10 w-4 h-4 bg-yellow-400 rounded-full animate-bounce opacity-50"></div>
                            <div className="absolute top-20 right-20 w-3 h-3 bg-blue-400 rounded-full animate-pulse opacity-50"></div>
                            <div className="absolute bottom-40 left-1/3 w-6 h-6 bg-green-400 rounded-full animate-bounce opacity-50" style={{ animationDelay: '0.5s' }}></div>
                        </>
                    )}

                    <div className="flex-1 flex flex-col items-center justify-center p-6 z-10">
                        <div className="mb-2 text-sm font-bold tracking-widest text-slate-400 uppercase animate-slide-up">Result</div>
                        <h2 className={`text-4xl font-black mb-8 animate-pop ${percentage >= 80 ? 'gold-text' : 'text-slate-800 dark:text-white'}`}>
                            {message}
                        </h2>

                        <div className="relative w-64 h-64 mb-8 animate-pop">
                             <svg viewBox="0 0 100 100" className="circular-chart transform -rotate-90 drop-shadow-2xl">
                                <path className="circle-bg" d="M50 10 a 40 40 0 0 1 0 80 a 40 40 0 0 1 0 -80" />
                                <path 
                                    className="circle" 
                                    strokeDasharray={`${circumference}, ${circumference}`} 
                                    strokeDashoffset={dashoffset}
                                    stroke={color}
                                    d="M50 10 a 40 40 0 0 1 0 80 a 40 40 0 0 1 0 -80" 
                                    style={{ '--to-offset': dashoffset }}
                                />
                            </svg>
                            <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-800 dark:text-white">
                                <span className="text-6xl font-black tracking-tighter">{score}</span>
                                <span className="text-sm font-medium text-slate-500 uppercase tracking-widest">/ {total} Score</span>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4 w-full max-w-sm mb-8 animate-slide-up" style={{ animationDelay: '0.2s' }}>
                            <div className="glass-panel p-4 rounded-2xl text-center border border-slate-200 dark:border-slate-700">
                                <p className="text-xs text-slate-500 mb-1">RANK</p>
                                <p className="text-2xl font-black" style={{ color: color }}>{rank}</p>
                            </div>
                            <div className="glass-panel p-4 rounded-2xl text-center border border-slate-200 dark:border-slate-700">
                                <p className="text-xs text-slate-500 mb-1">ACCURACY</p>
                                <p className="text-2xl font-black text-slate-800 dark:text-white">{percentage}%</p>
                            </div>
                        </div>

                        <div className="w-full max-w-sm space-y-3 animate-slide-up" style={{ animationDelay: '0.4s' }}>
                            <Button onClick={onRetry} variant="primary" fullWidth>
                                <Icon name="rotate-ccw" size={18} /> もう一度挑戦
                            </Button>
                            <Button onClick={onHome} variant="secondary" fullWidth>
                                <Icon name="home" size={18} /> ホームへ戻る
                            </Button>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // QUIZ SESSION
        // ==========================================
        const QuizSession = ({ rawData, mode, filterId, isDrillMode, onFinish }) => {
            const playSFX = useContext(SoundContext);
            const [gameState, setGameState] = useState('playing'); // playing, result
            const [currentIndex, setCurrentIndex] = useState(0);
            const [selected, setSelected] = useState(null);
            const [isCorrect, setIsCorrect] = useState(null);
            const [streak, setStreak] = useState(0);
            const [score, setScore] = useState(0);
            const [showExplanation, setShowExplanation] = useState(false);
            const [isLocked, setIsLocked] = useState(false);
            const [timeLeft, setTimeLeft] = useState(0);

            // Filter data
            const sessionData = useMemo(() => {
                let filtered = [...rawData];
                const savedProgress = JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}');

                if (mode === 'vocab') {
                    if (filterId === 'weak') {
                        filtered = filtered.filter(item => {
                            const p = savedProgress[item.id];
                            return !p || !p.mastered;
                        });
                        if (filtered.length === 0) filtered = [...rawData];
                    } else if (filterId === '600') {
                        filtered = filtered.filter(item => item.level === 600);
                    } else if (filterId === '730') {
                        filtered = filtered.filter(item => item.level === 730);
                    } else if (filterId === '860') {
                        filtered = filtered.filter(item => item.level >= 860);
                    }
                }
                
                const limit = 10; // Fixed number of questions for demo
                return shuffleArray(filtered).slice(0, limit);
            }, [rawData, mode, filterId]);

            const currentItem = sessionData[currentIndex];
            const maxTime = mode === 'reading' ? 20 : mode === 'listening' ? 15 : 10;

            useEffect(() => {
                if (gameState === 'playing') setTimeLeft(maxTime);
            }, [currentIndex, maxTime, gameState]);

            const choices = useMemo(() => {
                if (!currentItem) return [];
                if (mode === 'vocab') return shuffleArray([...currentItem.choices, currentItem.meaning]);
                if (mode === 'reading') return currentItem.choices;
                return currentItem.options;
            }, [currentItem, mode]);

            useEffect(() => {
                if (gameState !== 'playing' || showExplanation || !currentItem) return;
                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            clearInterval(timer);
                            handleTimeUp();
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, [currentIndex, showExplanation, gameState]);

            // Auto-speak for listening
            useEffect(() => {
                if (mode === 'listening' && currentItem && !showExplanation && gameState === 'playing') {
                    const t = setTimeout(() => speak(currentItem.script), 600);
                    return () => clearTimeout(t);
                }
            }, [currentItem, showExplanation, mode, gameState]);

            const handleTimeUp = () => {
                playSFX('wrong');
                setIsCorrect(false);
                setShowExplanation(true);
            };

            const handleAnswer = (choice, index) => {
                if (isLocked || showExplanation) return;
                setIsLocked(true);
                setSelected(index);
                
                let correct = false;
                if (mode === 'vocab') correct = choice === currentItem.meaning;
                else correct = index === currentItem.correct;

                setIsCorrect(correct);
                playSFX(correct ? 'correct' : 'wrong');

                if (correct) setScore(s => s + 1);

                // Update Storage
                const savedData = JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}');
                const itemData = savedData[currentItem.id] || { streak: 0, mastered: false };

                if (correct) {
                    setStreak(s => s + 1);
                    itemData.streak += 1;
                    const threshold = isDrillMode ? 2 : 1;
                    if (itemData.streak >= threshold) itemData.mastered = true;
                } else {
                    setStreak(0);
                    itemData.streak = 0;
                }
                savedData[currentItem.id] = itemData;
                localStorage.setItem('toeic_progress_v3', JSON.stringify(savedData));

                setTimeout(() => {
                    if (correct) {
                        if (mode === 'vocab') nextQuestion();
                        else setShowExplanation(true);
                    } else {
                        setShowExplanation(true);
                    }
                    setIsLocked(false);
                }, correct && mode === 'vocab' ? 800 : 500);
            };

            const nextQuestion = () => {
                if (currentIndex >= sessionData.length - 1) {
                    playSFX('complete');
                    setGameState('result');
                } else {
                    setCurrentIndex(prev => prev + 1);
                    setSelected(null);
                    setIsCorrect(null);
                    setShowExplanation(false);
                    setTimeLeft(maxTime);
                    setIsLocked(false);
                }
            };

            const handleRetry = () => {
                setGameState('playing');
                setCurrentIndex(0);
                setScore(0);
                setStreak(0);
                setSelected(null);
                setIsCorrect(null);
                setShowExplanation(false);
            };

            if (gameState === 'result') {
                return <ResultScreen score={score} total={sessionData.length} onRetry={handleRetry} onHome={() => onFinish(streak)} />;
            }

            if (!currentItem) return <div className="h-full flex items-center justify-center text-slate-500">No Data Available</div>;

            const timerWidth = (timeLeft / maxTime) * 100;
            const timerColor = timeLeft <= 3 ? "bg-red-500" : "bg-blue-500";

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-slate-900 transition-colors">
                    <Header 
                        title={mode === 'vocab' ? '単語テスト' : mode === 'listening' ? 'リスニング' : 'リーディング'} 
                        sub={`${currentIndex + 1} / ${sessionData.length} • Combo: ${streak}`} 
                        leftIcon="x"
                        onLeftClick={() => onFinish(streak)}
                    />

                    {/* Progress Bar */}
                    <div className="w-full h-1.5 bg-gray-200 dark:bg-slate-800 overflow-hidden">
                        <div 
                            className={`h-full ${timerColor} transition-all duration-1000 ease-linear shadow-[0_0_10px_rgba(59,130,246,0.5)]`} 
                            style={{ width: `${timerWidth}%` }}
                        ></div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 pb-32">
                        <div className="my-6">
                            {mode === 'vocab' && (
                                <div className="text-center animate-pop">
                                    <span className="inline-block px-3 py-1 mb-4 text-xs font-bold text-slate-800 bg-yellow-400 rounded-full no-select shadow-sm">
                                        LEVEL {currentItem.level}
                                    </span>
                                    <h2 className="text-4xl font-extrabold text-slate-800 dark:text-white mb-2 tracking-wide selectable-text drop-shadow-sm">
                                        {currentItem.word}
                                    </h2>
                                    {isDrillMode && (
                                        <div className="text-xs text-slate-500 mt-2 flex items-center justify-center gap-1">
                                            <Icon name="dumbbell" size={14} />
                                            <span>Spartan: {JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}')[currentItem.id]?.streak || 0}/2</span>
                                        </div>
                                    )}
                                </div>
                            )}

                            {mode === 'reading' && (
                                <div className="glass-panel p-6 rounded-2xl border border-gray-200 dark:border-slate-700 shadow-sm animate-pop">
                                    <p className="text-lg leading-relaxed font-medium text-slate-800 dark:text-slate-100 selectable-text">
                                        {currentItem.question}
                                    </p>
                                </div>
                            )}

                            {mode === 'listening' && (
                                <div className="flex flex-col items-center justify-center py-8 animate-pop">
                                    <button 
                                        onClick={() => speak(currentItem.script)}
                                        className="w-24 h-24 rounded-full bg-gray-100 dark:bg-slate-800 border-4 border-yellow-500 flex items-center justify-center shadow-[0_0_30px_rgba(234,179,8,0.3)] btn-press hover:scale-105 transition-transform"
                                    >
                                        <Icon name="volume-2" className="w-10 h-10 text-yellow-600 dark:text-yellow-500" />
                                    </button>
                                    <p className="mt-4 text-sm text-slate-500 animate-pulse-slow">タップして再生</p>
                                </div>
                            )}
                        </div>

                        <div className="space-y-3">
                            // QuizSession コンポーネントの choices.map の中身
{choices.map((choice, idx) => {
    // ボタン自体のクラス（アニメーション関連を削除し、純粋なボタンスタイルのみにする）
    let btnClass = "w-full p-4 rounded-xl text-left font-medium text-lg transition-transform duration-200 border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700 shadow-sm";
    
    // 選択状態のスタイルロジック
    if (selected !== null) {
        if (mode === 'vocab') {
            if (choice === currentItem.meaning) btnClass = "w-full p-4 rounded-xl text-left font-bold border-2 border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 shadow-md"; // scale削除
            else if (idx === selected) btnClass = "w-full p-4 rounded-xl text-left border-2 border-red-500 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400"; // shakeは親でやるか、ここでは控えめに
            else btnClass += " opacity-40 blur-[1px]";
        } else {
            // ... (Reading/Listeningのロジックも同様に transform系クラス scale などを外す) ...
            if (idx === currentItem.correct) btnClass = "w-full p-4 rounded-xl text-left font-bold border-2 border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 shadow-md";
            else if (idx === selected) btnClass = "w-full p-4 rounded-xl text-left border-2 border-red-500 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400";
            else btnClass += " opacity-40 blur-[1px]";
        }
    }

    return (
        // ★修正点: アニメーション専用のラッパーdivを作る
        <div 
            key={idx} 
            className="animate-slide-up" 
            style={{ animationDelay: `${idx * 60}ms` }} // 遅延を少し短くしてキビキビさせる
        >
            <button 
                onClick={() => handleAnswer(choice, idx)} 
                disabled={selected !== null} 
                className={`${btnClass} btn-press flex items-center`} // btn-pressはここで適用
            >
                <span className="inline-flex items-center justify-center min-w-[28px] h-7 rounded-lg bg-gray-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 text-xs font-bold mr-3 shadow-inner">
                    {String.fromCharCode(65 + idx)}
                </span>
                <span className="selectable-text text-sm md:text-base leading-relaxed">{choice}</span>
            </button>
        </div>
    );
})}
                        </div>
                    </div>

                    {showExplanation && (
<div 
    className="fixed bottom-0 left-0 w-full glass-panel bg-white/95 dark:bg-slate-800/95 border-t border-gray-200 dark:border-slate-600 z-50 animate-slide-up shadow-[0_-10px_40px_rgba(0,0,0,0.2)] rounded-t-3xl"
    style={{ padding: '1.5rem', paddingBottom: 'calc(1.5rem + env(safe-area-inset-bottom))' }} 
>                            <div className="max-w-md mx-auto">
                                <div className="flex items-center gap-3 mb-4">
                                    {isCorrect ? (
                                        <div className="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center shrink-0 shadow-lg shadow-green-500/30 animate-pop"><Icon name="check" className="text-white w-6 h-6" /></div>
                                    ) : (
                                        <div className="w-10 h-10 rounded-full bg-red-500 flex items-center justify-center shrink-0 shadow-lg shadow-red-500/30 animate-pop"><Icon name="x" className="text-white w-6 h-6" /></div>
                                    )}
                                    <h3 className={`text-2xl font-black ${isCorrect ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                                        {isCorrect ? 'Correct!' : 'Wrong...'}
                                    </h3>
                                </div>
                                {mode !== 'vocab' && (
                                    <div className="mb-6 p-4 rounded-xl bg-gray-50 dark:bg-slate-700/50 border border-gray-100 dark:border-slate-600">
                                        <span className="block text-xs text-slate-400 uppercase font-bold mb-2 tracking-wider">解説</span>
                                        <p className="text-sm leading-relaxed text-slate-700 dark:text-slate-300 selectable-text">{currentItem.explanation}</p>
                                    </div>
                                )}
                                {mode === 'listening' && (
                                    <div className="mb-6 p-3 bg-white dark:bg-slate-900 rounded-xl text-sm text-slate-600 dark:text-slate-400 italic border border-gray-200 dark:border-slate-700 shadow-inner">
                                        "{currentItem.script}"
                                    </div>
                                )}
                                // 解説表示エリアのボタン部分
<Button 
    onClick={nextQuestion} 
    className="w-full text-lg h-14" 
    variant="primary"  // ★ここを "primary" 固定に変更
>
    Next Question <Icon name="arrow-right" size={20} />
</Button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // SETTINGS SCREEN
        // ==========================================
        const Settings = ({ settings, updateSettings, onBack, resetData }) => {
            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-slate-900 animate-slide-in-right">
                    <Header title="設定" leftIcon="arrow-left" onLeftClick={onBack} />
                    <div className="p-4 space-y-6">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-gray-200 dark:border-slate-700">
                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">表示とサウンド</h3>
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400"><Icon name={settings.theme === 'dark' ? 'moon' : 'sun'} /></div>
                                    <div><p className="font-bold text-slate-800 dark:text-slate-100">ダークモード</p><p className="text-xs text-slate-500">目に優しい暗色テーマ</p></div>
                                </div>
                                <Toggle checked={settings.theme === 'dark'} onChange={() => updateSettings('theme', settings.theme === 'dark' ? 'light' : 'dark')} />
                            </div>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg text-green-600 dark:text-green-400"><Icon name={settings.sound ? 'volume-2' : 'volume-x'} /></div>
                                    <div><p className="font-bold text-slate-800 dark:text-slate-100">効果音</p><p className="text-xs text-slate-500">操作音と正誤判定音</p></div>
                                </div>
                                <Toggle checked={settings.sound} onChange={() => updateSettings('sound', !settings.sound)} />
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-gray-200 dark:border-slate-700">
                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">学習設定</h3>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg text-purple-600 dark:text-purple-400"><Icon name="dumbbell" /></div>
                                    <div><p className="font-bold text-slate-800 dark:text-slate-100">特訓モード</p><p className="text-xs text-slate-500">2回連続正解で「習得済み」</p></div>
                                </div>
                                <Toggle checked={settings.spartan} onChange={() => updateSettings('spartan', !settings.spartan)} />
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-gray-200 dark:border-slate-700">
                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">データ管理</h3>
                            <Button variant="danger" className="w-full" onClick={resetData}>
                                <Icon name="trash-2" size={18} /> 学習データをリセット
                            </Button>
                        </div>
                        <div className="text-center text-xs text-slate-400 pt-8 pb-4">TOEIC 700 Booster Pro v3.1</div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // HOME SCREEN
        // ==========================================
        const Home = ({ onStart, onSettings }) => {
            const [progress, setProgress] = useState({ mastered: 0, total: VOCAB_DATA.length });

            useEffect(() => {
                const saved = JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}');
                const masteredCount = Object.values(saved).filter(i => i.mastered).length;
                setProgress({ mastered: masteredCount, total: VOCAB_DATA.length });
            }, []);

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-slate-900 text-slate-800 dark:text-white p-6 pb-24 transition-colors animate-fade-in">
                    <div className="flex justify-between items-center mb-8 pt-2">
                        <div className="flex items-center gap-2">
                             <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-600 flex items-center justify-center text-white font-black text-xs shadow-lg shadow-orange-500/20 transform rotate-3">Pro</div>
                             <span className="font-bold text-xl tracking-tight">Booster</span>
                        </div>
                        <button onClick={onSettings} className="p-3 rounded-full bg-white dark:bg-slate-800 shadow-sm border border-gray-200 dark:border-slate-700 btn-press">
                            <Icon name="settings" className="w-5 h-5 text-slate-600 dark:text-slate-400" />
                        </button>
                    </div>

                    {/* COUNTDOWN COMPONENT */}
                    <CountdownWidget />

                    <div className="flex justify-between items-end mb-6 mx-2">
                        <div>
                            <p className="text-sm text-slate-500 dark:text-slate-400 mb-1 font-medium">Weekly Goal</p>
                            <h1 className="text-3xl font-black font-mono gold-text tracking-tighter">7 DAYS</h1>
                        </div>
                        <div className="text-right">
                            <div className="inline-flex items-center gap-1 bg-yellow-100 dark:bg-yellow-900/30 px-2 py-1 rounded-md border border-yellow-200 dark:border-yellow-500/20">
                                <span className="text-xs font-bold text-yellow-700 dark:text-yellow-500">TARGET SCORE</span>
                            </div>
                            <div className="flex items-baseline justify-end gap-1 mt-1">
                                <span className="text-2xl font-black text-slate-800 dark:text-white">700</span>
                                <span className="text-xs text-slate-500 font-bold">PTS</span>
                            </div>
                        </div>
                    </div>

                    <div className="glass-panel p-6 rounded-3xl mb-8 relative overflow-hidden border border-white dark:border-slate-700 shadow-xl bg-white/60 dark:bg-slate-800/60">
                        <div className="absolute -top-4 -right-4 p-4 opacity-5 dark:opacity-10 pointer-events-none transform rotate-12">
                            <Icon name="award" size={120} className="text-yellow-500" />
                        </div>
                        <div className="relative z-10">
                            <h2 className="text-xs font-bold text-slate-600 dark:text-slate-300 mb-3 uppercase tracking-wider flex items-center gap-2">
                                <Icon name="bar-chart-2" size={14} /> Vocabulary Mastery
                            </h2>
                            <div className="flex items-end gap-2 mb-3">
                                <span className="text-5xl font-black text-slate-800 dark:text-white tracking-tighter">{Math.round((progress.mastered / progress.total) * 100)}%</span>
                                <span className="text-slate-500 dark:text-slate-400 mb-2 text-sm font-bold">{progress.mastered} <span className="font-normal text-xs">/ {progress.total} Words</span></span>
                            </div>
                            <div className="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-3 mb-2 overflow-hidden shadow-inner">
                                <div className="bg-gradient-to-r from-yellow-400 to-orange-500 h-3 rounded-full transition-all duration-1000 ease-out" style={{ width: `${(progress.mastered / progress.total) * 100}%` }}></div>
                            </div>
                        </div>
                    </div>

                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider ml-1">Training Modules</h3>
                    <div className="grid grid-cols-2 gap-4">
                        <button onClick={() => onStart('vocab')} className="bg-white dark:bg-slate-800 p-5 rounded-2xl text-left border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 btn-press group">
                            <div className="bg-yellow-100 dark:bg-yellow-900/30 w-12 h-12 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                                <Icon name="book-open" className="text-yellow-600 dark:text-yellow-500" />
                            </div>
                            <h3 className="font-bold text-lg mb-1 text-slate-800 dark:text-slate-100">重要単語</h3>
                            <p className="text-xs text-slate-500 font-medium">高速マスター</p>
                        </button>
                        <button onClick={() => onStart('reading')} className="bg-white dark:bg-slate-800 p-5 rounded-2xl text-left border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 btn-press group">
                            <div className="bg-blue-100 dark:bg-blue-900/30 w-12 h-12 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                                <Icon name="glasses" className="text-blue-600 dark:text-blue-500" />
                            </div>
                            <h3 className="font-bold text-lg mb-1 text-slate-800 dark:text-slate-100">Reading</h3>
                            <p className="text-xs text-slate-500 font-medium">Part 5 文法</p>
                        </button>
                        <button onClick={() => onStart('listening')} className="col-span-2 bg-white dark:bg-slate-800 p-5 rounded-2xl text-left border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 btn-press group relative overflow-hidden">
                            <div className="absolute right-0 top-0 w-32 h-full bg-gradient-to-l from-green-50 dark:from-green-900/10 to-transparent"></div>
                            <div className="flex items-center justify-between relative z-10">
                                <div>
                                    <div className="bg-green-100 dark:bg-green-900/30 w-12 h-12 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                                        <Icon name="headphones" className="text-green-600 dark:text-green-500" />
                                    </div>
                                    <h3 className="font-bold text-lg mb-1 text-slate-800 dark:text-slate-100">Listening</h3>
                                    <p className="text-xs text-slate-500 font-medium">Part 2 応答問題 (AI Audio)</p>
                                </div>
                                <div className="bg-slate-100 dark:bg-slate-700 w-12 h-12 rounded-full flex items-center justify-center shadow-inner group-hover:bg-green-500 group-hover:text-white transition-colors duration-300">
                                    <Icon name="play" className="w-5 h-5 ml-1" />
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            );
        };

        // ==========================================
        // MAIN APP CONTAINER
        // ==========================================
        const App = () => {
            const [view, setView] = useState('home'); // home, settings, course_select_*, quiz_*
            const [activeMode, setActiveMode] = useState(null); 
            const [courseFilter, setCourseFilter] = useState('all'); 
            
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('toeic_settings_v3');
                return saved ? JSON.parse(saved) : { theme: 'dark', sound: true, spartan: false };
            });

            useEffect(() => {
                if (settings.theme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                localStorage.setItem('toeic_settings_v3', JSON.stringify(settings));
            }, [settings]);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            const updateSettings = (key, value) => setSettings(prev => ({ ...prev, [key]: value }));
            const resetData = () => {
                if(confirm("学習データをすべてリセットしますか？この操作は取り消せません。")) {
                    localStorage.removeItem('toeic_progress_v3');
                    window.location.reload();
                }
            };

            const handleStartPreSelect = (mode) => {
                setActiveMode(mode);
                setView('course_select');
            };

            const handleCourseSelect = (filterId) => {
                setCourseFilter(filterId);
                setView('quiz');
            };

            const getDataForMode = () => {
                if (activeMode === 'vocab') return VOCAB_DATA;
                if (activeMode === 'reading') return READING_DATA;
                if (activeMode === 'listening') return LISTENING_DATA;
                return [];
            };

            // App コンポーネント内の return 部分を以下のように書き換えてください
return (
    <SoundProvider enabled={settings.sound}>
        {/* overflow-hidden を overflow-y-auto に変更し、スクロール可能にします */}
        <div className="max-w-md mx-auto h-full bg-gray-50 dark:bg-slate-900 shadow-2xl relative overflow-y-auto overflow-x-hidden">
            {view === 'home' && <Home onStart={handleStartPreSelect} onSettings={() => setView('settings')} />}
            
            {/* その他のコンポーネント表示ロジックはそのまま... */}
            {view === 'settings' && (
                <Settings settings={settings} updateSettings={updateSettings} onBack={() => setView('home')} resetData={resetData} />
            )}

            {view === 'course_select' && (
                <CourseSelection type={activeMode} onSelect={handleCourseSelect} onBack={() => setView('home')} />
            )}

            {view === 'quiz' && (
                <QuizSession 
                    rawData={getDataForMode()} 
                    mode={activeMode} 
                    filterId={courseFilter}
                    isDrillMode={settings.spartan} 
                    onFinish={() => setView('home')} 
                />
            )}
        </div>
    </SoundProvider>
);
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
