<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TOEIC 700</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ†</text></svg>">
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e32' }
                    },
                    animation: {
                        'bounce-short': 'bounce 0.5s ease-in-out 1',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'slide-in-right': 'slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'progress': 'progress 1s ease-out forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        slideInRight: {
                            '0%': { transform: 'translateX(20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' }
                        },
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        },
                        progress: {
                            '0%': { width: '0%' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            touch-action: manipulation;
        }
        
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .selectable-text {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }

        .glass-panel {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        .gold-text {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 2px 4px rgba(217, 119, 6, 0.1);
        }

        .btn-press { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.1s, box-shadow 0.1s; }
        .btn-press:active { transform: scale(0.96); opacity: 0.9; }

        .theme-transition {
            transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;
        }

        /* Circle Progress for Result */
        .circular-chart {
            display: block;
            margin: 0 auto;
            max-width: 80%;
            max-height: 250px;
        }
        .circle-bg {
            fill: none;
            stroke: #eee;
            stroke-width: 3.8;
        }
        .dark .circle-bg {
            stroke: #334155;
        }
        .circle {
            fill: none;
            stroke-width: 2.8;
            stroke-linecap: round;
            animation: progress 1.5s ease-out forwards;
        }
        .percentage {
            fill: #666;
            font-family: sans-serif;
            font-weight: bold;
            font-size: 0.5em;
            text-anchor: middle;
        }
        .dark .percentage { fill: #fff; }

    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-slate-800 dark:text-slate-100 theme-transition h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, createContext, useContext } = React;

        // ==========================================
        // AUDIO SYSTEM
        // ==========================================
        const SoundContext = createContext();
        const SoundProvider = ({ children, enabled }) => {
            const audioCtxRef = useRef(null);
            const playTone = (freq, type, duration, vol = 0.1) => {
                if (!enabled) return;
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (!audioCtxRef.current) audioCtxRef.current = new AudioContext();
                    const ctx = audioCtxRef.current;
                    if (ctx.state === 'suspended') ctx.resume();
                    
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = type;
                    osc.frequency.setValueAtTime(freq, ctx.currentTime);
                    gain.gain.setValueAtTime(vol, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.start();
                    osc.stop(ctx.currentTime + duration);
                } catch(e) { console.error(e); }
            };

            const playSFX = (type) => {
                if (!enabled) return;
                if (navigator.vibrate) {
                    if (type === 'wrong') navigator.vibrate(200);
                    if (type === 'correct') navigator.vibrate(50);
                    if (type === 'click') navigator.vibrate(10);
                }
                switch (type) {
                    case 'correct':
                        playTone(600, 'sine', 0.1, 0.1);
                        setTimeout(() => playTone(1200, 'sine', 0.2, 0.1), 50);
                        break;
                    case 'wrong':
                        playTone(150, 'sawtooth', 0.3, 0.15);
                        setTimeout(() => playTone(100, 'sawtooth', 0.3, 0.15), 100);
                        break;
                    case 'click':
                        playTone(800, 'triangle', 0.05, 0.03);
                        break;
                    case 'complete':
                        playTone(400, 'sine', 0.1);
                        setTimeout(() => playTone(500, 'sine', 0.1), 100);
                        setTimeout(() => playTone(600, 'sine', 0.1), 200);
                        setTimeout(() => playTone(800, 'sine', 0.4), 300);
                        break;
                    default: break;
                }
            };
            return <SoundContext.Provider value={playSFX}>{children}</SoundContext.Provider>;
        };

        // ==========================================
        // DATA
        // ==========================================
        // (Simplified data set for brevity, same structure as before)
        const VOCAB_DATA = [
            { id: 'v1', level: 600, word: "significant", meaning: "ã‹ãªã‚Šã®ã€é‡è¦ãª", type: "vocab", choices: ["ä¸€æ™‚çš„ãª", "å¾®ç´°ãª", "ç–‘ã‚ã—ã„"] },
            { id: 'v2', level: 600, word: "appointment", meaning: "ç´„æŸã€äºˆç´„ã€ä»»å‘½", type: "vocab", choices: ["å¤±æœ›", "è¨±å¯", "è©•ä¾¡"] },
            { id: 'v3', level: 730, word: "tentative", meaning: "ä»®ã®ã€æš«å®šçš„ãª", type: "vocab", choices: ["æ–­å®šçš„ãª", "æ°¸ä¹…ã®", "é«˜ä¾¡ãª"] },
            { id: 'v4', level: 730, word: "comply", meaning: "ï¼ˆè¦å‰‡ãªã©ã«ï¼‰å¾“ã†", type: "vocab", choices: ["ä¸æº€ã‚’è¨€ã†", "å®Œäº†ã™ã‚‹", "æ¯”è¼ƒã™ã‚‹"] },
            { id: 'v5', level: 860, word: "imminent", meaning: "å·®ã—è¿«ã£ãŸ", type: "vocab", choices: ["ç„¡é–¢ä¿‚ãª", "å·¨å¤§ãª", "ä¸å¤‰ã®"] },
            { id: 'v6', level: 860, word: "lucrative", meaning: "å„²ã‹ã‚‹ã€åˆ©ç›Šã®ä¸ŠãŒã‚‹", type: "vocab", choices: ["ä¸é‹ãª", "å‰µé€ çš„ãª", "ç·©ã‚„ã‹ãª"] },
            { id: 'v7', level: 600, word: "inventory", meaning: "åœ¨åº«ã€æ£šå¸ã—", type: "vocab", choices: ["æŠ•è³‡", "æ‹›å¾…çŠ¶", "ç™ºæ˜"] },
            { id: 'v8', level: 730, word: "reimburse", meaning: "æ‰•ã„æˆ»ã™", type: "vocab", choices: ["å†åˆ©ç”¨ã™ã‚‹", "å¼·åŒ–ã™ã‚‹", "è¼¸å…¥ã™ã‚‹"] },
            { id: 'v9', level: 600, word: "proposal", meaning: "ææ¡ˆ", type: "vocab", choices: ["å‡¦åˆ†", "ç›®çš„", "åå¯¾"] },
            { id: 'v10', level: 730, word: "itinerary", meaning: "æ—…ç¨‹è¡¨", type: "vocab", choices: ["æ—¥è¨˜", "å…¥ã‚Šå£", "è¦ç´„"] },
            { id: 'v11', level: 860, word: "consecutive", meaning: "é€£ç¶šã—ãŸ", type: "vocab", choices: ["å»ºè¨­çš„ãª", "ä¿å®ˆçš„ãª", "çµæœçš„ãª"] },
            { id: 'v12', level: 900, word: "scrutinize", meaning: "ç¶¿å¯†ã«èª¿ã¹ã‚‹", type: "vocab", choices: ["è¦ç´„ã™ã‚‹", "æ‹¡å¤§ã™ã‚‹", "é…å¸ƒã™ã‚‹"] }
        ];

        // ==========================================
// NEW TOEIC DATA (FROM PDF)
// ==========================================

// ãƒªã‚¹ãƒ‹ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (Part 1 - 4)
const LISTENING_QUESTION_DATA = [
    // --- Part 1: Photographs ---
    {
        id: 'p1-1', part: 1, type: 'listening', contextType: 'image',
        // ãƒ€ãƒŸãƒ¼ç”»åƒURL (å®Ÿéš›ã®å®Ÿè£…ã§ã¯é©åˆ‡ãªç”»åƒã‚’é…ç½®)
        imageUrl: "https://placehold.co/600x400/3b82f6/white?text=Man+at+Computer",
        script: "(A) The man's walking around the room. (B) The man's examining the jacket. (C) The man's looking at the map. (D) The man's sitting in front of a computer.",
        question: "å†™çœŸã®æå†™ã¨ã—ã¦æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚",
        options: ["(A)", "(B)", "(C)", "(D)"],
        correct: 3,
        explanation: "ç”·æ€§ãŒã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®å‰ã«åº§ã£ã¦ä½œæ¥­ã‚’ã—ã¦ã„ã‚‹æ§˜å­ã‚’æå†™ã—ã¦ã„ã‚‹(D)ãŒæ­£è§£ã€‚(A)walkingã¯workingã¨ã®éŸ³ã®ã²ã£ã‹ã‘ã€‚"
    },
    {
        id: 'p1-2', part: 1, type: 'listening', contextType: 'image',
        imageUrl: "https://placehold.co/600x400/22c55e/white?text=Construction+Site",
        script: "(A) The women are wearing their protective gloves. (B) The women are touching the wall. (C) The women are forming a circle. (D) The women are working at the construction site.",
        question: "å†™çœŸã®æå†™ã¨ã—ã¦æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚",
        options: ["(A)", "(B)", "(C)", "(D)"],
        correct: 3,
        explanation: "ãƒ˜ãƒ«ãƒ¡ãƒƒãƒˆã‚„å·¥å…·ãŒè¦‹ãˆã‚‹ãŸã‚ã€å»ºè¨­ç¾å ´(construction site)ã§åƒã„ã¦ã„ã‚‹(D)ãŒæ­£è§£ã€‚"
    },

    // --- Part 2: Question-Response ---
    {
        id: 'p2-1', part: 2, type: 'listening', contextType: 'dialogue',
        script: "Will you be visiting the client tomorrow afternoon?",
        question: "è³ªå•ã«å¯¾ã™ã‚‹é©åˆ‡ãªå¿œç­”ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚",
        options: [
            "(A) Yes, it was yesterday.",
            "(B) I have an appointment at three P.M.",
            "(C) We haven't received any invitation yet."
        ],
        correct: 1,
        explanation: "ã€Œæ˜æ—¥ã®åˆå¾Œã€é¡§å®¢ã‚’è¨ªå•ã—ã¾ã™ã‹ï¼Ÿã€ã¨ã„ã†äºˆå®šã®è³ªå•ã«å¯¾ã—ã€ã€Œ3æ™‚ã«ç´„æŸãŒã‚ã‚‹ã€ã¨ç­”ãˆã¦ã„ã‚‹(B)ãŒæ­£è§£ã€‚"
    },
    {
        id: 'p2-2', part: 2, type: 'listening', contextType: 'dialogue',
        script: "Why hasn't the shipment arrived yet?",
        question: "è³ªå•ã«å¯¾ã™ã‚‹é©åˆ‡ãªå¿œç­”ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚",
        options: [
            "(A) No, I haven't.",
            "(B) Because of the heavy snow.",
            "(C) Usually by truck."
        ],
        correct: 1,
        explanation: "é…é€ãŒé…ã‚Œã¦ã„ã‚‹ç†ç”±(Why)ã‚’èã„ã¦ã„ã‚‹ã®ã§ã€åŸå› (Because...)ã‚’è¿°ã¹ã¦ã„ã‚‹(B)ãŒæ­£è§£ã€‚"
    },

    // --- Part 3: Conversations ---
    {
        id: 'p3-1', part: 3, type: 'listening', contextType: 'conversation',
        contextTitle: "Office: Copier Problem",
        script: `W: There seems to be something wrong with this copier. The red light is blinking.
M: Is it broken again? That's the third time this week.
W: I've got to make fifty copies by noon, so I'll use the one on the 3rd floor.
M: Let me see... maybe it's a paper jam. We'd better call a repairman.`,
        question: "What are the speakers talking about?",
        options: ["Lights", "A copy machine", "Planes", "Breakfast"],
        correct: 1,
        explanation: "ã‚³ãƒ”ãƒ¼æ©Ÿ(copier)ã®èª¿å­ãŒæ‚ªã„ã“ã¨ã«ã¤ã„ã¦è©±ã—ã¦ã„ã¾ã™ã€‚"
    },
    {
        id: 'p3-2', part: 3, type: 'listening', contextType: 'conversation',
        // åŒã˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å…±æœ‰
        script: `(Refer to previous conversation about the copier...)
M: ...We'd better call a repairman.`,
        question: "What will the man probably do next?",
        options: ["Go to a different floor", "Call a technician", "Complain to his boss", "Spend hours at his desk"],
        correct: 1,
        explanation: "ç”·æ€§ã¯æœ€å¾Œã« repairmanï¼ˆä¿®ç†å·¥ï¼‰ã‚’å‘¼ã¶ã¨è¨€ã£ã¦ã„ã‚‹ãŸã‚ã€(B) Call a technician ãŒæ­£è§£ã€‚"
    },

    // --- Part 4: Talks ---
    {
        id: 'p4-1', part: 4, type: 'listening', contextType: 'monologue',
        contextTitle: "Announcement: Starlight Cruise",
        script: "Welcome to the Starlight Cruise. Our ship cruises the West River... The tour includes a four-course meal, open bar, and live musical entertainment.",
        question: "What is included in the cruise?",
        options: ["Four meals", "Films", "A musical performance", "Fireworks"],
        correct: 2,
        explanation: "ã‚¢ãƒŠã‚¦ãƒ³ã‚¹å†…ã§ 'live musical entertainment' ãŒå«ã¾ã‚Œã‚‹ã¨è¿°ã¹ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚"
    }
];

// ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (Part 5 - 7)
const READING_QUESTION_DATA = [
    // --- Part 5: Incomplete Sentences ---
    {
        id: 'p5-1', part: 5, type: 'reading', contextType: 'sentence',
        question: "Harvey Daveson Auto Bike Co. is now working towards _______ to a problem that has emerged recently.",
        options: ["a cause", "an explanation", "a result", "a solution"],
        correct: 3,
        explanation: "æ–‡è„ˆå•é¡Œã€‚ã€Œå•é¡Œã¸ã®è§£æ±ºç­–(solution to a problem)ã€ã«å–ã‚Šçµ„ã‚“ã§ã„ã‚‹ã¨ã™ã‚‹ã®ãŒè‡ªç„¶ã€‚(D)ãŒæ­£è§£ã€‚"
    },
    {
        id: 'p5-2', part: 5, type: 'reading', contextType: 'sentence',
        question: "Please _______ all the blanks on the order form to ensure prompt shipment.",
        options: ["fall on", "feel for", "fill in", "find out"],
        correct: 2,
        explanation: "ç†Ÿèªå•é¡Œã€‚fill inï¼ˆè¨˜å…¥ã™ã‚‹ï¼‰ãŒæ–‡è„ˆï¼ˆæ³¨æ–‡æ›¸ã®ç©ºæ¬„ï¼‰ã«åˆã„ã¾ã™ã€‚"
    },

    // --- Part 6: Text Completion ---
    {
        id: 'p6-1', part: 6, type: 'reading', contextType: 'long_text',
        contextTitle: "Memo: Acquisition",
        passage: "To: All employees\nFrom: James White\nRe: Acquisition by Ito Industries\n\nAs you already know, White Corporation _______ by Ito Industries and is now part of the Ito Group.",
        question: "Choose the best word for the blank.",
        options: ["have taken over", "have been taken over", "took over", "has been taken over"],
        correct: 3,
        explanation: "å—å‹•æ…‹ã®æ–‡è„ˆã€‚White Corporationï¼ˆå˜æ•°ï¼‰ãŒä¸»èªãªã®ã§ã€has been taken over (D)ãŒæ­£è§£ã€‚"
    },

    // --- Part 7: Reading Comprehension ---
    {
        id: 'p7-1', part: 7, type: 'reading', contextType: 'long_text',
        contextTitle: "Web Page: Richmond Hotel",
        passage: `The Richmond Hotel for both business and pleasure.
Located in the business district of Columbus.
Only 30 minutes from downtown Kensington and 25 minutes from Patterson International Airport.
All rooms are equipped with: Alarm clock radio, Coffee maker, Cable TV, Free Wi-Fi.`,
        question: "Where is the establishment situated?",
        options: ["In the center of the city", "Next to the airport", "In downtown Kensington", "In the business district"],
        correct: 3,
        explanation: "æœ¬æ–‡ã« 'located in the business district of Columbus' ã¨æ˜è¨˜ã•ã‚Œã¦ã„ã¾ã™ã€‚"
    },
    {
        id: 'p7-2', part: 7, type: 'reading', contextType: 'long_text',
        contextTitle: "Web Page: Richmond Hotel",
        passage: `(Refer to the Richmond Hotel advertisement above...)
All rooms are equipped with: Alarm clock radio, Coffee maker, Cable TV, Free Wi-Fi, Microwave, Fridge.`,
        question: "What can be found in the rooms?",
        options: ["A computer", "A dishwasher", "An oven", "A microwave"],
        correct: 3,
        explanation: "è¨­å‚™ãƒªã‚¹ãƒˆã« 'Microwave' ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚(C) An oven ã¯é›»å­ãƒ¬ãƒ³ã‚¸(microwave oven)ã®ä¸€ç¨®ã¨è€ƒãˆã‚‰ã‚Œã‚‹ãŸã‚ã€è¨­å•ã«ã‚ˆã£ã¦ã¯æ­£è§£ã«ãªã‚Šå¾—ã¾ã™ãŒã€ã“ã“ã§ã¯é¸æŠè‚¢ã«åˆã‚ã›ã¦èª¿æ•´ã€‚"
    }
];

        // ==========================================
        // UTILS
        // ==========================================
        const speak = (text) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                // Try to find a good voice
                const voices = window.speechSynthesis.getVoices();
                const enVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Samantha')) || 
                                voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) ||
                                voices.find(v => v.lang === 'en-US');
                if (enVoice) utterance.voice = enVoice;
                utterance.rate = 0.9; // Slightly slower for clarity
                window.speechSynthesis.speak(utterance);
            }
        };

        const shuffleArray = (array) => {
            return array.map(value => ({ value, sort: Math.random() }))
                        .sort((a, b) => a.sort - b.sort)
                        .map(({ value }) => value);
        };

        // ==========================================
        // COMPONENTS
        // ==========================================

        const Icon = ({ name, size = 24, className }) => {
    const ref = useRef(null);

    useEffect(() => {
        if (window.lucide && ref.current) {
            window.lucide.createIcons({
                root: ref.current,
                nameAttr: 'data-lucide',
            });
        }
    }, [name]);

    return (
        <span
            ref={ref}
            // ä¿®æ­£ç‚¹: 
            // - inline-flex: ã‚¢ã‚¤ã‚³ãƒ³ã®ç®±ã‚’ä½œã‚‹
            // - items-center justify-center: ä¸­èº«ã®SVGã‚’ã©çœŸã‚“ä¸­ã«
            // - leading-none: è¡Œã®é«˜ã•ã«ã‚ˆã‚‹ä¸‹ã®ä½™ç™½ã‚’å‰Šé™¤
            // - align-middle: ãƒ†ã‚­ã‚¹ãƒˆã®æ¨ªã«ä¸¦ã‚“ã æ™‚ã®ä½ç½®ã‚ºãƒ¬é˜²æ­¢
            // - shrink-0: ç‹­ã„å ´æ‰€ã§ã‚‚æ½°ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
            className={`inline-flex items-center justify-center leading-none align-middle shrink-0 ${className || ''}`}
            style={{ width: size, height: size }}
        >
            <i 
                data-lucide={name} 
                width={size} 
                height={size} 
                // SVGè‡ªä½“ã‚‚è¦ªè¦ç´ ã„ã£ã±ã„ã«åºƒã’ã‚‹
                style={{ display: 'block' }} 
            ></i>
        </span>
    );
};

        const Button = ({ children, onClick, className = "", variant = "primary", disabled = false, fullWidth = false }) => {
            const playSFX = useContext(SoundContext);
            
            const baseClass = `relative px-4 py-3.5 rounded-2xl font-bold flex items-center justify-center gap-2 btn-press no-select disabled:opacity-50 disabled:pointer-events-none transition-all duration-300 ${fullWidth ? 'w-full' : ''}`;
            
            const variants = {
                primary: "bg-yellow-500 hover:bg-yellow-400 text-slate-900 shadow-lg shadow-yellow-500/20 border border-yellow-400",
                secondary: "bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600",
                glass: "glass-panel border border-white/20 dark:border-slate-600 text-slate-800 dark:text-white hover:bg-white/40 dark:hover:bg-slate-700/50",
                ghost: "text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800",
                danger: "bg-red-500 text-white shadow-lg shadow-red-500/20"
            };

            const handleClick = (e) => {
                if (!disabled) {
                    playSFX('click');
                    if (onClick) onClick(e);
                }
            };

            return (
                <button onClick={handleClick} className={`${baseClass} ${variants[variant]} ${className}`} disabled={disabled}>
                    {children}
                </button>
            );
        };

        const Toggle = ({ checked, onChange }) => (
    <div 
        // èƒŒæ™¯è‰²ï¼ˆbg-gray-300ãªã©ï¼‰ã‚’æ¡ä»¶åˆ†å²ã®ä¸­ã«ç§»å‹•ã•ã›ã€ç«¶åˆã‚’é˜²ãã¾ã™
        className={`w-14 h-8 flex items-center rounded-full p-1 cursor-pointer transition-all duration-300 border ${checked ? 'bg-yellow-500 border-yellow-400' : 'bg-gray-300 dark:bg-slate-700 border-transparent'}`}
        onClick={onChange}
    >
        <div className={`bg-white w-6 h-6 rounded-full shadow-md transform transition-transform duration-300 ease-spring ${checked ? 'translate-x-6' : ''}`}></div>
    </div>
);

        const Header = ({ title, sub, leftIcon, onLeftClick, rightAction }) => (
            <div className="flex items-center justify-between p-4 glass-panel sticky top-0 z-30 border-b border-gray-200/50 dark:border-slate-800/50 no-select transition-all">
                <div className="flex items-center gap-3">
                    {leftIcon && (
                        <button onClick={onLeftClick} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700/50 transition">
                            <Icon name={leftIcon} className="w-6 h-6 text-slate-600 dark:text-slate-300" />
                        </button>
                    )}
                    <div>
                        <h1 className="text-lg font-bold text-slate-800 dark:text-slate-100 leading-tight tracking-tight">{title}</h1>
                        {sub && <p className="text-xs text-slate-500 dark:text-slate-400 font-medium">{sub}</p>}
                    </div>
                </div>
                {rightAction && <div>{rightAction}</div>}
            </div>
        );

        // ==========================================
        // COUNTDOWN WIDGET
        // ==========================================
        // ç§’è¡¨ç¤ºã‚’ãªãã—ã€æ—¥ã¨æ™‚é–“ã‚’å¼·èª¿ã—ãŸæ–°ã—ã„ CountdownWidget
// ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã§ã‚·ãƒ³ãƒ—ãƒ«ãªæ–°ã—ã„ CountdownWidget
const CountdownWidget = () => {
    const [timeLeft, setTimeLeft] = useState(null);
    const TARGET_DATE = new Date("2026-01-23T14:00:00+09:00"); 

    useEffect(() => {
        const calculateTime = () => {
            const now = new Date();
            const diff = TARGET_DATE - now;
            if (diff <= 0) return null;
            return {
                days: Math.floor(diff / (1000 * 60 * 60 * 24)),
                hours: Math.floor((diff / (1000 * 60 * 60)) % 24),
            };
        };
        setTimeLeft(calculateTime());
        const timer = setInterval(() => setTimeLeft(calculateTime()), 60000); 
        return () => clearInterval(timer);
    }, []);

    if (!timeLeft) return null;

    return (
        // é’ã„èƒŒæ™¯ã‚„å¤§ããªä½™ç™½ã‚’å‰Šé™¤ã—ã€ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªã‚«ãƒ¼ãƒ‰ã«å¤‰æ›´
        <div className="mb-8 animate-slide-up relative z-10">
            <div className="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-gray-200 dark:border-slate-700 shadow-sm flex items-center justify-between">
                
                {/* å·¦å´: è©¦é¨“æ—¥æƒ…å ± */}
                <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-full bg-indigo-50 dark:bg-indigo-900/20 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-500">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
                    </div>
                    <div>
                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">TOEIC å½“æ—¥ã¾ã§</p>
                        <p className="text-sm font-bold text-slate-700 dark:text-slate-200 font-mono">2026.01.23</p>
                    </div>
                </div>

                {/* å³å´: æ®‹ã‚Šæ™‚é–“ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºï¼‰ */}
                <div className="text-right">
                    <div className="flex items-baseline justify-end gap-1">
                        <span className="text-2xl font-black text-slate-800 dark:text-white font-mono tracking-tight">
                            {timeLeft.days}
                        </span>
                        <span className="text-xs font-bold text-slate-400 mr-2">days</span>
                        
                        <span className="text-xl font-bold text-slate-800 dark:text-white font-mono tracking-tight">
                            {timeLeft.hours}
                        </span>
                        <span className="text-xs font-bold text-slate-400">hr</span>
                    </div>
                </div>
            </div>
        </div>
    );
};

        // ==========================================
        // COURSE SELECTION
        // ==========================================
        const CourseSelection = ({ type, onSelect, onBack }) => {
            const getCourses = () => {
                if (type === 'vocab') {
                    return [
                        { id: 'all', title: 'å…¨ãƒ¬ãƒ™ãƒ«ç·åˆ', sub: 'ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œ', icon: 'layers', color: 'text-blue-500', bg: 'bg-blue-100 dark:bg-blue-900/30' },
                        { id: 'weak', title: 'è‹¦æ‰‹å…‹æœ', sub: 'æœªç¿’å¾—ã®å˜èªã®ã¿', icon: 'target', color: 'text-red-500', bg: 'bg-red-100 dark:bg-red-900/30' },
                        { id: '600', title: 'Level 600', sub: 'åŸºç¤ãƒ»å¿…é ˆãƒ¬ãƒ™ãƒ«', icon: 'zap', color: 'text-green-500', bg: 'bg-green-100 dark:bg-green-900/30' },
                        { id: '730', title: 'Level 730', sub: 'ãƒ“ã‚¸ãƒã‚¹æ¨™æº–', icon: 'briefcase', color: 'text-yellow-500', bg: 'bg-yellow-100 dark:bg-yellow-900/30' },
                        { id: '860', title: 'Level 860+', sub: 'ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒ»é›£é–¢', icon: 'award', color: 'text-purple-500', bg: 'bg-purple-100 dark:bg-purple-900/30' },
                    ];
                } else if (type === 'listening') {
            return [
                { id: 'all_listening', title: 'ãƒªã‚¹ãƒ‹ãƒ³ã‚°ç·åˆ', sub: 'Part 1 - 4 ãƒ©ãƒ³ãƒ€ãƒ ', icon: 'headphones', color: 'text-indigo-500', bg: 'bg-indigo-100 dark:bg-indigo-900/30' },
                { id: 'part1', title: 'Part 1: å†™çœŸæå†™', sub: 'ç”»åƒã‚’è¦‹ã¦ç­”ãˆã‚‹', icon: 'image', color: 'text-pink-500', bg: 'bg-pink-100 dark:bg-pink-900/30' },
                { id: 'part2', title: 'Part 2: å¿œç­”å•é¡Œ', sub: 'è³ªå•ã¸ã®å¿œç­”ã‚’é¸ã¶', icon: 'message-circle', color: 'text-green-500', bg: 'bg-green-100 dark:bg-green-900/30' },
                { id: 'part3', title: 'Part 3: ä¼šè©±å•é¡Œ', sub: 'è¤‡æ•°äººã®ä¼šè©±ã‚’èã', icon: 'users', color: 'text-blue-500', bg: 'bg-blue-100 dark:bg-blue-900/30' },
                { id: 'part4', title: 'Part 4: èª¬æ˜æ–‡', sub: 'ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ç­‰ã‚’èã', icon: 'radio', color: 'text-orange-500', bg: 'bg-orange-100 dark:bg-orange-900/30' },
            ];
        } else if (type === 'reading') {
            return [
                { id: 'all_reading', title: 'ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç·åˆ', sub: 'Part 5 - 7 ãƒ©ãƒ³ãƒ€ãƒ ', icon: 'book-open', color: 'text-teal-500', bg: 'bg-teal-100 dark:bg-teal-900/30' },
                { id: 'part5', title: 'Part 5: çŸ­æ–‡ç©´åŸ‹ã‚', sub: 'æ–‡æ³•ãƒ»èªå½™åŠ›', icon: 'edit-3', color: 'text-yellow-500', bg: 'bg-yellow-100 dark:bg-yellow-900/30' },
                { id: 'part6', title: 'Part 6: é•·æ–‡ç©´åŸ‹ã‚', sub: 'æ–‡è„ˆç†è§£', icon: 'file-text', color: 'text-cyan-500', bg: 'bg-cyan-100 dark:bg-cyan-900/30' },
                { id: 'part7', title: 'Part 7: èª­è§£å•é¡Œ', sub: 'é•·æ–‡èª­è§£', icon: 'book', color: 'text-purple-500', bg: 'bg-purple-100 dark:bg-purple-900/30' },
            ];
        }
        return [];
            };

            const courses = getCourses();
    const sectionTitle = type === 'vocab' ? 'é‡è¦èªå¥' : type === 'listening' ? 'ãƒªã‚¹ãƒ‹ãƒ³ã‚° (Part 1-4)' : 'ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚° (Part 5-7)';

            return (
        <div className="flex flex-col h-full bg-gray-50 dark:bg-slate-900 animate-slide-in-right">
            <Header title={sectionTitle} sub="ã‚³ãƒ¼ã‚¹ã‚’é¸ã‚“ã§ãã ã•ã„" leftIcon="arrow-left" onLeftClick={onBack} />
            <div className="p-4 space-y-3 overflow-y-auto pb-20">
                {courses.map((course, idx) => (
                    <button key={course.id} onClick={() => onSelect(course.id)} className="w-full bg-white dark:bg-slate-800 p-4 rounded-2xl text-left border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-lg transition-all btn-press flex items-center gap-4 group" style={{ animationDelay: `${idx * 50}ms` }}>
                        <div className={`w-14 h-14 rounded-2xl flex items-center justify-center ${course.bg} group-hover:scale-110 transition-transform duration-300`}>
                            <Icon name={course.icon} className={course.color} size={26} />
                        </div>
                        <div className="flex-1">
                            <h3 className="font-bold text-lg text-slate-800 dark:text-slate-100">{course.title}</h3>
                            <p className="text-xs text-slate-500">{course.sub}</p>
                        </div>
                        <div className="w-8 h-8 rounded-full bg-gray-100 dark:bg-slate-700 flex items-center justify-center">
                            <Icon name="chevron-right" className="text-slate-400" size={18} />
                        </div>
                    </button>
                ))}
            </div>
        </div>
    );
};

        // ==========================================
// RESULT SCREEN (æ¼”å‡ºãªã—ãƒ»ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ)
// ==========================================
const ResultScreen = ({ score, total, onRetry, onHome }) => {
    // 0é™¤ç®—å¯¾ç­–
    const percentage = total > 0 ? Math.round((score / total) * 100) : 0;
    
    const radius = 40;
    const circumference = 2 * Math.PI * radius;
    const strokeDashoffset = circumference - (percentage / 100) * circumference;

    let rank = 'C';
    let message = "Keep Going!";
    let color = "#94a3b8"; // slate

    if (percentage === 100) { rank = 'S'; message = "Perfect!!"; color = "#eab308"; }
    else if (percentage >= 80) { rank = 'A'; message = "Excellent!"; color = "#22c55e"; }
    else if (percentage >= 60) { rank = 'B'; message = "Good Job!"; color = "#3b82f6"; }

    return (
        <div className="flex flex-col h-full bg-gray-50 dark:bg-slate-900 animate-fade-in relative overflow-hidden">
            {/* ã‚¯ãƒ©ãƒƒã‚«ãƒ¼æ¼”å‡ºã®å‘¼ã³å‡ºã—ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ */}

            <div className="flex-1 flex flex-col items-center justify-center p-6 z-10">
                <div className="mb-2 text-sm font-bold tracking-widest text-slate-400 uppercase animate-slide-up">Result</div>
                <h2 className={`text-4xl font-black mb-8 animate-pop ${percentage === 100 ? 'gold-text' : 'text-slate-800 dark:text-white'}`}>
                    {message}
                </h2>

                <div className="relative w-64 h-64 mb-8 animate-pop">
                    <svg viewBox="0 0 100 100" className="w-full h-full transform -rotate-90 drop-shadow-xl">
                        <circle
                            cx="50" cy="50" r={radius}
                            fill="none"
                            stroke="currentColor"
                            strokeWidth="8"
                            className="text-gray-200 dark:text-slate-700"
                        />
                        <circle
                            cx="50" cy="50" r={radius}
                            fill="none"
                            stroke={color}
                            strokeWidth="8"
                            strokeLinecap="round"
                            strokeDasharray={circumference}
                            strokeDashoffset={strokeDashoffset}
                            className="transition-all duration-1000 ease-out"
                        />
                    </svg>
                    
                    <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-800 dark:text-white">
                        <div className="flex items-baseline justify-center">
                            <span className="text-6xl font-black tracking-tighter leading-none">
                                {percentage}
                            </span>
                            <span className="text-xl font-bold ml-1">%</span>
                        </div>
                        <span className="text-sm font-medium text-slate-500 uppercase tracking-widest mt-1">Accuracy</span>
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-4 w-full max-w-sm mb-8 animate-slide-up" style={{ animationDelay: '0.2s' }}>
                    <div className="glass-panel p-4 rounded-2xl text-center border border-slate-200 dark:border-slate-700">
                        <p className="text-xs text-slate-500 mb-1">RANK</p>
                        <p className="text-2xl font-black" style={{ color: color }}>{rank}</p>
                    </div>
                    
                    <div className="glass-panel p-4 rounded-2xl text-center border border-slate-200 dark:border-slate-700">
                        <p className="text-xs text-slate-500 mb-1">CORRECT</p>
                        <p className="text-2xl font-black text-slate-800 dark:text-white">
                            {score} <span className="text-base text-slate-400 font-bold">/ {total}</span>
                        </p>
                    </div>
                </div>

                <div className="w-full max-w-sm space-y-3 animate-slide-up" style={{ animationDelay: '0.4s' }}>
                    <Button onClick={onRetry} variant="primary" fullWidth>
                        <Icon name="rotate-ccw" size={18} /> ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦
                    </Button>
                    <Button onClick={onHome} variant="secondary" fullWidth>
                        <Icon name="home" size={18} /> ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹
                    </Button>
                </div>
            </div>
        </div>
    );
};
        // ==========================================
// QUIZ SESSION (ä¿®æ­£ç‰ˆ v2)
// ==========================================
const QuizSession = ({ rawData, mode, filterId, isDrillMode, onFinish }) => {
    const playSFX = useContext(SoundContext);
    const [gameState, setGameState] = useState('loading'); 
    const [sessionData, setSessionData] = useState([]);
    const [currentIndex, setCurrentIndex] = useState(0);
    const [selected, setSelected] = useState(null);
    const [isCorrect, setIsCorrect] = useState(null);
    const [sessionStreak, setSessionStreak] = useState(0); 
    const [score, setScore] = useState(0);
    const [showExplanation, setShowExplanation] = useState(false);
    const [isLocked, setIsLocked] = useState(false);
    const [timeLeft, setTimeLeft] = useState(0);
    
    // ãƒªãƒˆãƒ©ã‚¤ã‚’ç¢ºå®Ÿã«æ¤œçŸ¥ã™ã‚‹ãŸã‚ã®ãƒˆãƒªã‚¬ãƒ¼
    const [retryCount, setRetryCount] = useState(0);

    // å•é¡Œãƒ‡ãƒ¼ã‚¿ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ãƒ­ãƒ¼ãƒ‰
    useEffect(() => {
        // ãƒ­ãƒ¼ãƒ‰é–‹å§‹æ™‚ã«gameStateã‚’loadingã«ã™ã‚‹
        setGameState('loading');

        let filtered = [...rawData];
        const savedProgress = JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}');

        // 1. ã‚«ãƒ†ã‚´ãƒªã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        if (mode === 'vocab') {
            if (filterId === 'weak') {
                filtered = filtered.filter(item => {
                    const p = savedProgress[item.id];
                    return !p || !p.mastered;
                });
            } else if (filterId === '600') filtered = filtered.filter(item => item.level === 600);
            else if (filterId === '730') filtered = filtered.filter(item => item.level === 730);
            else if (filterId === '860') filtered = filtered.filter(item => item.level >= 860);
        } else if (mode === 'listening') {
            if (filterId === 'part1') filtered = filtered.filter(i => i.part === 1);
            else if (filterId === 'part2') filtered = filtered.filter(i => i.part === 2);
            else if (filterId === 'part3') filtered = filtered.filter(i => i.part === 3);
            else if (filterId === 'part4') filtered = filtered.filter(i => i.part === 4);
        } else if (mode === 'reading') {
            if (filterId === 'part5') filtered = filtered.filter(i => i.part === 5);
            else if (filterId === 'part6') filtered = filtered.filter(i => i.part === 6);
            else if (filterId === 'part7') filtered = filtered.filter(i => i.part === 7);
        }

        // 2. ç‰¹è¨“ãƒ¢ãƒ¼ãƒ‰ï¼ˆSpartanï¼‰ã®å ´åˆã€ç¿’å¾—æ¸ˆã¿ã‚’é™¤å¤–ã™ã‚‹
        if (isDrillMode) {
            filtered = filtered.filter(item => {
                const p = savedProgress[item.id];
                return !p || !p.mastered;
            });
        }

        // ã™ã¹ã¦ç¿’å¾—æ¸ˆã¿ã‹ã©ã†ã‹ã®åˆ¤å®š
        if (filtered.length === 0) {
            let originalScope = [...rawData];
             if (mode === 'vocab') {
                if (filterId === '600') originalScope = originalScope.filter(item => item.level === 600);
                else if (filterId === '730') originalScope = originalScope.filter(item => item.level === 730);
                else if (filterId === '860') originalScope = originalScope.filter(item => item.level >= 860);
            } else if (mode === 'listening' && filterId.startsWith('part')) {
                 originalScope = originalScope.filter(i => i.part === parseInt(filterId.replace('part','')));
            } else if (mode === 'reading' && filterId.startsWith('part')) {
                 originalScope = originalScope.filter(i => i.part === parseInt(filterId.replace('part','')));
            }

            if (originalScope.length > 0) {
                setGameState('mastered');
                return;
            } else {
                alert("å‡ºé¡Œã§ãã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                onFinish(0);
                return;
            }
        }

        // ãƒ©ãƒ³ãƒ€ãƒ ã«10å•å‡ºé¡Œ
        setSessionData(shuffleArray(filtered).slice(0, 10));
        
        // å°‘ã—é…å»¶ã•ã›ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã
        setTimeout(() => setGameState('playing'), 100);

    }, [rawData, mode, filterId, isDrillMode, retryCount]); // retryCountã‚’ä¾å­˜é…åˆ—ã«è¿½åŠ 

    const currentItem = sessionData[currentIndex];

    // ç¾åœ¨ã®å•é¡Œã®ç¿’å¾—çŠ¶æ³ã‚’å–å¾—
    const currentItemStreak = useMemo(() => {
        if (!currentItem) return 0;
        const savedProgress = JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}');
        return savedProgress[currentItem.id]?.streak || 0;
    }, [currentItem, isCorrect]); // æ­£è§£åˆ¤å®šå¾Œã«æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ä¾å­˜é–¢ä¿‚è¿½åŠ 
    
    // åˆ¶é™æ™‚é–“ã®è¨­å®š
    const getMaxTime = () => {
        if (mode === 'vocab') return 10;
        if (mode === 'reading') {
            if (currentItem?.part === 7) return 60;
            return 20;
        }
        return 15;
    };
    const maxTime = getMaxTime();

    // ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
    useEffect(() => {
        if (gameState === 'playing') setTimeLeft(maxTime);
    }, [currentIndex, maxTime, gameState]);

    // é¸æŠè‚¢ã®æº–å‚™
    const choices = useMemo(() => {
        if (!currentItem) return [];
        if (mode === 'vocab') return shuffleArray([...currentItem.choices, currentItem.meaning]);
        return currentItem.options || currentItem.choices; 
    }, [currentItem, mode]);

    // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
    useEffect(() => {
        if (gameState !== 'playing' || showExplanation || !currentItem) return;
        const timer = setInterval(() => {
            setTimeLeft(prev => {
                if (prev <= 1) {
                    clearInterval(timer);
                    handleTimeUp();
                    return 0;
                }
                return prev - 1;
            });
        }, 1000);
        return () => clearInterval(timer);
    }, [currentIndex, showExplanation, gameState]);

    const handleTimeUp = () => {
        playSFX('wrong');
        setIsCorrect(false);
        setShowExplanation(true);
        updateProgress(false);
    };

    const updateProgress = (isAnswerCorrect) => {
        const savedData = JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}');
        const itemData = savedData[currentItem.id] || { streak: 0, mastered: false };

        if (isAnswerCorrect) {
            itemData.streak += 1; 
            const threshold = isDrillMode ? 2 : 1; 
            if (itemData.streak >= threshold) {
                itemData.mastered = true;
            }
        } else {
            itemData.streak = 0;
        }

        savedData[currentItem.id] = itemData;
        localStorage.setItem('toeic_progress_v3', JSON.stringify(savedData));
    };

    const handleAnswer = (choice, index) => {
        if (isLocked || showExplanation) return;
        setIsLocked(true);
        setSelected(index);
        
        let correct = false;
        if (mode === 'vocab') {
            correct = (choice === currentItem.meaning);
        } else {
            correct = (index === currentItem.correct);
        }

        setIsCorrect(correct);
        playSFX(correct ? 'correct' : 'wrong');

        if (correct) {
            setScore(s => s + 1);
            setSessionStreak(s => s + 1);
        } else {
            setSessionStreak(0);
        }

        updateProgress(correct);

        setTimeout(() => {
            if (correct) {
                if (mode === 'vocab') nextQuestion();
                else setShowExplanation(true);
            } else {
                setShowExplanation(true);
            }
            setIsLocked(false);
        }, correct && mode === 'vocab' ? 800 : 500);
    };

    const nextQuestion = () => {
        if (currentIndex >= sessionData.length - 1) {
            playSFX('complete');
            setGameState('result');
        } else {
            setCurrentIndex(prev => prev + 1);
            setSelected(null);
            setIsCorrect(null);
            setShowExplanation(false);
            setTimeLeft(maxTime);
            setIsLocked(false);
        }
    };

    const handleResetCourse = () => {
        if(!confirm("ã“ã®ã‚³ãƒ¼ã‚¹ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã€æœ€åˆã‹ã‚‰ç‰¹è¨“ã—ç›´ã—ã¾ã™ã‹ï¼Ÿ")) return;
        const savedData = JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}');
        let targetItems = [...rawData];
        
        // ç°¡æ˜“çš„ãªçµã‚Šè¾¼ã¿ï¼ˆå®Ÿéš›ã¯useEffectã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ãŒæœ›ã¾ã—ã„ï¼‰
        if (mode === 'vocab' && filterId === '600') targetItems = targetItems.filter(i => i.level === 600);
        // ... ä»–æ¡ä»¶çœç•¥ ...

        targetItems.forEach(item => {
            if (savedData[item.id]) savedData[item.id] = { streak: 0, mastered: false };
        });

        localStorage.setItem('toeic_progress_v3', JSON.stringify(savedData));
        alert("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼");
        onFinish(0); 
    };

    // ãƒªãƒˆãƒ©ã‚¤å‡¦ç†ä¿®æ­£ï¼šã‚«ã‚¦ãƒ³ã‚¿ã‚’å¢—ã‚„ã—ã¦useEffectã‚’å†ç™ºç«ã•ã›ã‚‹
    const handleRetry = () => {
        setScore(0);
        setSessionStreak(0);
        setCurrentIndex(0);
        setSelected(null);
        setIsCorrect(null);
        setShowExplanation(false);
        setIsLocked(false);
        
        // ã“ã‚Œã§useEffectãŒèµ°ã‚Šã€ãƒ‡ãƒ¼ã‚¿å†å–å¾— -> gameState='playing' ã«ãªã‚‹
        setRetryCount(prev => prev + 1);
    };

    // --- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---

    if (gameState === 'mastered') {
        return (
            <div className="h-full flex flex-col items-center justify-center p-6 bg-gray-50 dark:bg-slate-900 animate-pop">
                <div className="bg-white dark:bg-slate-800 p-8 rounded-3xl shadow-xl text-center border border-gray-200 dark:border-slate-700 max-w-sm w-full">
                    <div className="w-20 h-20 bg-yellow-100 dark:bg-yellow-900/30 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl">
                        ğŸ†
                    </div>
                    <h2 className="text-2xl font-black text-slate-800 dark:text-white mb-2">COURSE MASTERED!</h2>
                    <p className="text-slate-500 dark:text-slate-400 mb-8">
                        ã“ã®ã‚³ãƒ¼ã‚¹ã®å•é¡Œã¯ã™ã¹ã¦ç¿’å¾—æ¸ˆã¿ã§ã™ã€‚<br/>
                        ãƒªã‚»ãƒƒãƒˆã—ã¦å¾©ç¿’ã—ã¾ã™ã‹ï¼Ÿ
                    </p>
                    <div className="space-y-3">
                        <Button onClick={handleResetCourse} variant="primary" fullWidth>
                            <Icon name="rotate-ccw" size={20} /> ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚„ã‚Šç›´ã™
                        </Button>
                        {/* ä¿®æ­£å¾Œ: é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã«å¤‰æ›´ */}
                        <Button onClick={() => onFinish(0)} variant="secondary" fullWidth>
                            <Icon name="x" size={20} /> é–‰ã˜ã‚‹
                        </Button>
                    </div>
                </div>
            </div>
        );
    }

    if (gameState === 'result') {
        return <ResultScreen score={score} total={sessionData.length} onRetry={handleRetry} onHome={() => onFinish(sessionStreak)} />;
    }

    if (!currentItem || gameState !== 'playing') {
        return (
            <div className="h-full flex flex-col items-center justify-center bg-gray-50 dark:bg-slate-900">
                <Icon name="loader-2" className="animate-spin text-yellow-500 mb-2" size={32} />
                <span className="text-slate-500 text-sm font-bold animate-pulse">Loading...</span>
            </div>
        );
    }

    const timerWidth = (timeLeft / maxTime) * 100;
    const timerColor = timeLeft <= 5 ? "bg-red-500" : "bg-blue-500";

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆï¼ˆã“ã“ã«ãƒ»ãƒ»ã‚’è¡¨ç¤ºï¼‰
    const headerSub = (
        <div className="flex items-center gap-3">
            <span>{currentIndex + 1} / {sessionData.length}</span>
            
            {/* ç‰¹è¨“ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿ãƒ‰ãƒƒãƒˆã‚’è¡¨ç¤º */}
            {isDrillMode && (
                <>
                    <span className="w-px h-3 bg-slate-300 dark:bg-slate-600"></span>
                    <div className="flex items-center gap-1.5">
                        {/* 2ã¤ã®ä¸¸ã‚’è¡¨ç¤ºã€‚currentItemStreakãŒ1ä»¥ä¸Šãªã‚‰1ã¤ç›®ç‚¹ç¯ã€2ä»¥ä¸Šãªã‚‰2ã¤ç›®ç‚¹ç¯ */}
                        <div className={`w-2.5 h-2.5 rounded-full border border-slate-300 dark:border-slate-500 transition-all duration-300 ${currentItemStreak >= 1 ? 'bg-yellow-500 border-yellow-500 shadow-[0_0_8px_rgba(234,179,8,0.6)]' : 'bg-transparent'}`}></div>
                        <div className={`w-2.5 h-2.5 rounded-full border border-slate-300 dark:border-slate-500 transition-all duration-300 ${currentItemStreak >= 2 ? 'bg-yellow-500 border-yellow-500 shadow-[0_0_8px_rgba(234,179,8,0.6)]' : 'bg-transparent'}`}></div>
                    </div>
                </>
            )}
        </div>
    );

    return (
        <div className="flex flex-col h-full bg-gray-50 dark:bg-slate-900 transition-colors">
            <Header 
                title={mode === 'vocab' ? 'å˜èªãƒ†ã‚¹ãƒˆ' : `Part ${currentItem.part || '?'}`} 
                sub={headerSub} 
                leftIcon="x"
                onLeftClick={() => onFinish(sessionStreak)}
            />

            {/* Progress Bar */}
            <div className="w-full h-1.5 bg-gray-200 dark:bg-slate-800 overflow-hidden">
                <div 
                    className={`h-full ${timerColor} transition-all duration-1000 ease-linear shadow-[0_0_10px_rgba(59,130,246,0.5)]`} 
                    style={{ width: `${timerWidth}%` }}
                ></div>
            </div>

            <div className={`flex-1 overflow-y-auto p-4 transition-all duration-300 ${showExplanation ? 'pb-[450px]' : 'pb-32'}`}>
                
                {/* --- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ --- */}
                <div className="mb-6 space-y-4">
                    
                    {/* 1. Vocabãƒ¢ãƒ¼ãƒ‰: å˜èªã‚’å¤§ããè¡¨ç¤º */}
                    {mode === 'vocab' && (
                        <div className="text-center animate-pop my-8">
                            <span className="inline-block px-3 py-1 mb-4 text-xs font-bold text-slate-800 bg-yellow-400 rounded-full no-select shadow-sm">
                                LEVEL {currentItem.level}
                            </span>
                            <h2 className="text-4xl font-extrabold text-slate-800 dark:text-white mb-2 tracking-wide selectable-text drop-shadow-sm">
                                {currentItem.word}
                            </h2>
                            {/* ã“ã“ã«ã‚ã£ãŸãƒ‰ãƒƒãƒˆè¡¨ç¤ºã¯å‰Šé™¤ã—ã¾ã—ãŸ */}
                        </div>
                    )}

                    {/* 2. Part 1: ç”»åƒè¡¨ç¤º */}
                    {currentItem.contextType === 'image' && currentItem.imageUrl && (
                        <div className="rounded-2xl overflow-hidden shadow-lg border border-gray-200 dark:border-slate-700 animate-pop">
                            <img src={currentItem.imageUrl} alt="Question Context" className="w-full h-auto object-cover" />
                        </div>
                    )}

                    {/* 3. Part 6/7: é•·æ–‡è¡¨ç¤º */}
                    {currentItem.contextType === 'long_text' && (
                        <div className="glass-panel p-5 rounded-2xl border border-gray-200 dark:border-slate-700 shadow-sm animate-pop max-h-64 overflow-y-auto">
                            {currentItem.contextTitle && (
                                <h3 className="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider sticky top-0 bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm py-1">
                                    {currentItem.contextTitle}
                                </h3>
                            )}
                            <p className="text-sm leading-relaxed text-slate-700 dark:text-slate-300 whitespace-pre-wrap font-serif">
                                {currentItem.passage}
                            </p>
                        </div>
                    )}

                    {/* 4. ãƒªã‚¹ãƒ‹ãƒ³ã‚°å…±é€š: å†ç”Ÿãƒœã‚¿ãƒ³ */}
                    {mode === 'listening' && (
                        <div className="flex flex-col items-center justify-center py-4 animate-pop">
                            <button 
                                onClick={() => speak(currentItem.script)}
                                className="w-20 h-20 rounded-full bg-yellow-100 dark:bg-yellow-900/30 border-4 border-yellow-500 flex items-center justify-center shadow-lg btn-press hover:scale-105 transition-transform"
                            >
                                <Icon name="volume-2" className="w-8 h-8 text-yellow-600 dark:text-yellow-500" />
                            </button>
                            <p className="mt-2 text-xs text-slate-500 animate-pulse-slow">Tap to Listen</p>
                            
                            {(showExplanation || currentItem.part >= 3) && (
                                <details className="w-full mt-4 group">
                                    <summary className="text-xs text-center text-slate-400 cursor-pointer hover:text-yellow-500 transition list-none select-none">
                                        <span className="border-b border-dashed border-slate-400 pb-0.5">ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¡¨ç¤º/éè¡¨ç¤º</span>
                                    </summary>
                                    <div className="mt-3 p-4 bg-white dark:bg-slate-800 rounded-xl text-xs text-slate-600 dark:text-slate-400 whitespace-pre-wrap border border-gray-200 dark:border-slate-700 shadow-inner text-left">
                                        {currentItem.script}
                                    </div>
                                </details>
                            )}
                        </div>
                    )}

                    {/* 5. å•é¡Œæ–‡ã®è¡¨ç¤º (Vocabä»¥å¤–) */}
                    {mode !== 'vocab' && currentItem.question && (
                        <div className="glass-panel p-4 rounded-xl border border-blue-100 dark:border-slate-700 bg-blue-50/50 dark:bg-slate-800/50 shadow-sm animate-pop">
                            <p className="text-lg font-medium text-slate-800 dark:text-slate-100 leading-relaxed">
                                <span className="text-blue-500 font-bold mr-2">Q.</span>
                                {currentItem.question}
                            </p>
                        </div>
                    )}
                </div>

                {/* --- é¸æŠè‚¢ã‚¨ãƒªã‚¢ --- */}
                <div className="space-y-3">
                    {choices.map((choice, idx) => {
                        let isAnsCorrect = false;
                        if (mode === 'vocab') isAnsCorrect = (choice === currentItem.meaning);
                        else isAnsCorrect = (idx === currentItem.correct);

                        let btnClass = "w-full p-4 rounded-xl text-left font-medium text-lg transition-all border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-sm hover:bg-gray-50 dark:hover:bg-slate-700";
                        
                        if (selected !== null) {
                            if (mode === 'vocab') {
                                if (choice === currentItem.meaning) btnClass = "w-full p-4 rounded-xl text-left font-bold border-2 border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 shadow-md";
                                else if (idx === selected) btnClass = "w-full p-4 rounded-xl text-left border-2 border-red-500 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400";
                                else btnClass += " opacity-40 blur-[1px]";
                            } else {
                                if (idx === currentItem.correct) btnClass = "w-full p-4 rounded-xl text-left font-bold border-2 border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 shadow-md";
                                else if (idx === selected) btnClass = "w-full p-4 rounded-xl text-left border-2 border-red-500 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400";
                                else btnClass += " opacity-40 blur-[1px]";
                            }
                        }

                        return (
                            <div 
                                key={idx} 
                                className="animate-slide-up" 
                                style={{ 
                                    animationDelay: `${idx * 40}ms`,
                                    transform: 'translateZ(0)'
                                }}
                            >
                                <button 
                                    onClick={() => handleAnswer(choice, idx)} 
                                    disabled={selected !== null} 
                                    className={`${btnClass} btn-press flex items-center`}
                                >
                                    <span className="inline-flex items-center justify-center min-w-[28px] h-7 rounded-lg bg-gray-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 text-xs font-bold mr-3 shadow-inner">
                                        {String.fromCharCode(65 + idx)}
                                    </span>
                                    <span className="selectable-text text-sm md:text-base leading-relaxed">{choice}</span>
                                </button>
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* --- è§£èª¬ãƒ¢ãƒ¼ãƒ€ãƒ« --- */}
            {showExplanation && (
                <div 
                    className="fixed bottom-0 left-0 w-full glass-panel bg-white/95 dark:bg-slate-800/95 border-t border-gray-200 dark:border-slate-600 z-50 animate-slide-up shadow-[0_-10px_40px_rgba(0,0,0,0.2)] rounded-t-3xl"
                    style={{ padding: '1.5rem', paddingBottom: 'calc(1.5rem + env(safe-area-inset-bottom))' }} 
                >
                    <div className="max-w-md mx-auto">
                        <div className="flex items-center gap-3 mb-4">
                            {isCorrect ? (
                                <div className="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center shrink-0 shadow-lg shadow-green-500/30 animate-pop"><Icon name="check" className="text-white w-6 h-6" /></div>
                            ) : (
                                <div className="w-10 h-10 rounded-full bg-red-500 flex items-center justify-center shrink-0 shadow-lg shadow-red-500/30 animate-pop"><Icon name="x" className="text-white w-6 h-6" /></div>
                            )}
                            <h3 className={`text-2xl font-black ${isCorrect ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                                {isCorrect ? 'Correct!' : 'Wrong...'}
                            </h3>
                        </div>
                        
                        {mode !== 'vocab' && currentItem.explanation && (
                            <div className="mb-6 p-4 rounded-xl bg-gray-50 dark:bg-slate-700/50 border border-gray-100 dark:border-slate-600 max-h-40 overflow-y-auto">
                                <span className="block text-xs text-slate-400 uppercase font-bold mb-2 tracking-wider">è§£èª¬</span>
                                <p className="text-sm leading-relaxed text-slate-700 dark:text-slate-300 selectable-text">{currentItem.explanation}</p>
                            </div>
                        )}
                        
                        <Button 
                            onClick={nextQuestion} 
                            className="w-full text-lg h-14" 
                            variant="primary"
                        >
                            Next Question <Icon name="arrow-right" size={20} />
                        </Button>
                    </div>
                </div>
            )}
        </div>
    );
};

        // ==========================================
        // SETTINGS SCREEN
        // ==========================================
        const Settings = ({ settings, updateSettings, onBack, resetData }) => {
            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-slate-900 animate-slide-in-right">
                    <Header title="è¨­å®š" leftIcon="arrow-left" onLeftClick={onBack} />
                    <div className="p-4 space-y-6">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-gray-200 dark:border-slate-700">
                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">è¡¨ç¤ºã¨ã‚µã‚¦ãƒ³ãƒ‰</h3>
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400"><Icon name={settings.theme === 'dark' ? 'moon' : 'sun'} /></div>
                                    <div><p className="font-bold text-slate-800 dark:text-slate-100">ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</p><p className="text-xs text-slate-500">ç›®ã«å„ªã—ã„æš—è‰²ãƒ†ãƒ¼ãƒ</p></div>
                                </div>
                                <Toggle checked={settings.theme === 'dark'} onChange={() => updateSettings('theme', settings.theme === 'dark' ? 'light' : 'dark')} />
                            </div>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg text-green-600 dark:text-green-400"><Icon name={settings.sound ? 'volume-2' : 'volume-x'} /></div>
                                    <div><p className="font-bold text-slate-800 dark:text-slate-100">åŠ¹æœéŸ³</p><p className="text-xs text-slate-500">æ“ä½œéŸ³ã¨æ­£èª¤åˆ¤å®šéŸ³</p></div>
                                </div>
                                <Toggle checked={settings.sound} onChange={() => updateSettings('sound', !settings.sound)} />
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-gray-200 dark:border-slate-700">
                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">å­¦ç¿’è¨­å®š</h3>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg text-purple-600 dark:text-purple-400"><Icon name="dumbbell" /></div>
                                    <div><p className="font-bold text-slate-800 dark:text-slate-100">ç‰¹è¨“ãƒ¢ãƒ¼ãƒ‰</p><p className="text-xs text-slate-500">2å›é€£ç¶šæ­£è§£ã§ã€Œç¿’å¾—æ¸ˆã¿ã€</p></div>
                                </div>
                                <Toggle checked={settings.spartan} onChange={() => updateSettings('spartan', !settings.spartan)} />
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-gray-200 dark:border-slate-700">
                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                            <Button variant="danger" className="w-full" onClick={resetData}>
                                <Icon name="trash-2" size={18} /> å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                            </Button>
                        </div>
                        <div className="text-center text-xs text-slate-400 pt-8 pb-4">TOEIC 700  ver 3.1</div>
                    </div>
                </div>
            );
        };

        // ==========================================
// HOME SCREEN (ä¿®æ­£ç‰ˆ v2)
// ==========================================
const Home = ({ onStart, onSettings }) => {
    const [progress, setProgress] = useState({ mastered: 0, total: 0 }); // åˆæœŸå€¤ã‚’0ã«

    useEffect(() => {
        // 1. å…¨å˜èªã®ç·æ•°ã‚’å–å¾—
        const totalVocab = VOCAB_DATA.length;

        // 2. ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®å­¦ç¿’è¨˜éŒ²ã‚’å–å¾—
        const saved = JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}');
        
        // 3. VOCAB_DATA ã«å­˜åœ¨ã™ã‚‹IDã ã‘ã‚’å¯¾è±¡ã«ã€mastered ã‹ã©ã†ã‹ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        const masteredCount = VOCAB_DATA.reduce((count, item) => {
            const itemData = saved[item.id];
            // ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã€ã‹ã¤ mastered ãƒ•ãƒ©ã‚°ãŒ true ãªã‚‰ã‚«ã‚¦ãƒ³ãƒˆ
            if (itemData && itemData.mastered) {
                return count + 1;
            }
            return count;
        }, 0);
        
        setProgress({ mastered: masteredCount, total: totalVocab });
    }, []);

    // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸è¨ˆç®—
    const percentage = progress.total > 0 ? Math.round((progress.mastered / progress.total) * 100) : 0;

    return (
        // ... (returnå†…ã® JSX ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ãªã—ã§ãã®ã¾ã¾ä½¿ãˆã¾ã™) ...
        <div className="min-h-screen bg-gray-50 dark:bg-slate-900 text-slate-800 dark:text-white p-6 pb-24 transition-colors animate-fade-in">
            <div className="flex justify-between items-center mb-6 pt-2 relative z-20">
                <div className="flex items-center gap-2">
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-600 flex items-center justify-center text-white font-black text-xs shadow-lg shadow-orange-500/20 transform rotate-3">
                    700
                </div>
                <span className="font-bold text-xl tracking-tight text-slate-800 dark:text-white">TOEIC 700</span>
            </div>
                <button onClick={onSettings} className="p-3 rounded-full bg-white dark:bg-slate-800 shadow-sm border border-gray-200 dark:border-slate-700 btn-press">
                    <Icon name="settings" className="w-5 h-5 text-slate-600 dark:text-slate-400" />
                </button>
            </div>

            {/* COUNTDOWN COMPONENT */}
            <CountdownWidget />

            <div className="flex justify-between items-end mb-6 mx-2">
                <div>
                    <p className="text-sm text-slate-500 dark:text-slate-400 mb-1 font-medium">Weekly Goal</p>
                    <h1 className="text-3xl font-black font-mono gold-text tracking-tighter">7 DAYS</h1>
                </div>
                <div className="text-right">
                    <div className="inline-flex items-center gap-1 bg-yellow-100 dark:bg-yellow-900/30 px-2 py-1 rounded-md border border-yellow-200 dark:border-yellow-500/20">
                        <span className="text-xs font-bold text-yellow-700 dark:text-yellow-500">TARGET SCORE</span>
                    </div>
                    <div className="flex items-baseline justify-end gap-1 mt-1">
                        <span className="text-2xl font-black text-slate-800 dark:text-white">700</span>
                        <span className="text-xs text-slate-500 font-bold">P</span>
                    </div>
                </div>
            </div>

            {/* --- VOCABULARY MASTERY CARD --- */}
            <div className="glass-panel p-6 rounded-3xl mb-8 relative overflow-hidden border border-white dark:border-slate-700 shadow-xl bg-white/60 dark:bg-slate-800/60">
                <div className="absolute -top-4 -right-4 p-4 opacity-5 dark:opacity-10 pointer-events-none transform rotate-12">
                    <Icon name="award" size={120} className="text-yellow-500" />
                </div>
                <div className="relative z-10">
                    <div className="flex justify-between items-center mb-3">
                        <h2 className="text-xs font-bold text-slate-600 dark:text-slate-300 uppercase tracking-wider flex items-center gap-2">
                            <Icon name="bar-chart-2" size={14} /> Vocabulary Mastery
                        </h2>
                        <span className="bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2 py-0.5 rounded text-[10px] font-bold">
                            {percentage}% Completed
                        </span>
                    </div>
                    
                    <div className="flex items-end gap-2 mb-3">
                        <span className="text-5xl font-black text-slate-800 dark:text-white tracking-tighter">{progress.mastered}</span>
                        <span className="text-slate-500 dark:text-slate-400 mb-2 text-sm font-bold">
                             <span className="text-slate-300 mx-1">/</span> {progress.total} Words
                        </span>
                    </div>
                    
                    <div className="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-4 mb-2 overflow-hidden shadow-inner relative">
                        {/* èƒŒæ™¯ã®ã‚¹ãƒˆãƒ©ã‚¤ãƒ—ï¼ˆè£…é£¾ï¼‰ */}
                        <div className="absolute inset-0 opacity-10 bg-[length:10px_10px] bg-[linear-gradient(45deg,rgba(0,0,0,.1)_25%,transparent_25%,transparent_50%,rgba(0,0,0,.1)_50%,rgba(0,0,0,.1)_75%,transparent_75%,transparent)]"></div>
                        
                        <div 
                            className="bg-gradient-to-r from-yellow-400 to-orange-500 h-full rounded-full transition-all duration-1000 ease-out relative" 
                            style={{ width: `${percentage}%` }}
                        >
                            {/* ã‚­ãƒ©ãƒƒã¨å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */}
                            <div className="absolute top-0 right-0 bottom-0 w-1 bg-white/50 blur-[2px]"></div>
                        </div>
                    </div>
                    <p className="text-[10px] text-slate-400 text-right">
                        ç‰¹è¨“ãƒ¢ãƒ¼ãƒ‰ã§2å›é€£ç¶šæ­£è§£ã™ã‚‹ã¨ã‚«ã‚¦ãƒ³ãƒˆã•ã‚Œã¾ã™
                    </p>
                </div>
            </div>

            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider ml-1">Training Modules</h3>
            <div className="grid grid-cols-2 gap-4">
                <button onClick={() => onStart('vocab')} className="bg-white dark:bg-slate-800 p-5 rounded-2xl text-left border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 btn-press group">
                    <div className="bg-yellow-100 dark:bg-yellow-900/30 w-12 h-12 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                        <Icon name="book-open" className="text-yellow-600 dark:text-yellow-500" />
                    </div>
                    <h3 className="font-bold text-lg mb-1 text-slate-800 dark:text-slate-100">é‡è¦å˜èª</h3>
                    <p className="text-xs text-slate-500 font-medium">é«˜é€Ÿãƒã‚¹ã‚¿ãƒ¼</p>
                </button>
                <button onClick={() => onStart('reading')} className="bg-white dark:bg-slate-800 p-5 rounded-2xl text-left border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 btn-press group">
                    <div className="bg-blue-100 dark:bg-blue-900/30 w-12 h-12 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                        <Icon name="glasses" className="text-blue-600 dark:text-blue-500" />
                    </div>
                    <h3 className="font-bold text-lg mb-1 text-slate-800 dark:text-slate-100">Reading</h3>
                    <p className="text-xs text-slate-500 font-medium">Part 5.6.7</p>
                </button>
                <button onClick={() => onStart('listening')} className="col-span-2 bg-white dark:bg-slate-800 p-5 rounded-2xl text-left border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all duration-300 btn-press group relative overflow-hidden">
                    <div className="absolute right-0 top-0 w-32 h-full bg-gradient-to-l from-green-50 dark:from-green-900/10 to-transparent"></div>
                    <div className="flex items-center justify-between relative z-10">
                        <div>
                            <div className="bg-green-100 dark:bg-green-900/30 w-12 h-12 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                                <Icon name="headphones" className="text-green-600 dark:text-green-500" />
                            </div>
                            <h3 className="font-bold text-lg mb-1 text-slate-800 dark:text-slate-100">Listening</h3>
                            <p className="text-xs text-slate-500 font-medium">Part 1.2.3.4</p>
                        </div>
                        <div className="bg-slate-100 dark:bg-slate-700 w-12 h-12 rounded-full flex items-center justify-center shadow-inner group-hover:bg-green-500 group-hover:text-white transition-colors duration-300">
                            <Icon name="play" className="w-5 h-5 ml-1" />
                        </div>
                    </div>
                </button>
            </div>
        </div>
    );
};

        // ==========================================
        // MAIN APP CONTAINER
        // ==========================================
        const App = () => {
            const [view, setView] = useState('home'); // home, settings, course_select_*, quiz_*
            const [activeMode, setActiveMode] = useState(null); 
            const [courseFilter, setCourseFilter] = useState('all'); 
            
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('toeic_settings_v3');
                return saved ? JSON.parse(saved) : { theme: 'dark', sound: true, spartan: false };
            });

            useEffect(() => {
                if (settings.theme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                localStorage.setItem('toeic_settings_v3', JSON.stringify(settings));
            }, [settings]);

            

            const updateSettings = (key, value) => setSettings(prev => ({ ...prev, [key]: value }));
            const resetData = () => {
                if(confirm("å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) {
                    localStorage.removeItem('toeic_progress_v3');
                    window.location.reload();
                }
            };

            const handleStartPreSelect = (mode) => {
                setActiveMode(mode);
                setView('course_select');
            };

            const handleCourseSelect = (filterId) => {
                setCourseFilter(filterId);
                setView('quiz');
            };

            const getDataForMode = () => {
                if (activeMode === 'vocab') return VOCAB_DATA;
                if (activeMode === 'reading') return READING_QUESTION_DATA;
                if (activeMode === 'listening') return LISTENING_QUESTION_DATA;
                return [];
            };

            // App ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã® return éƒ¨åˆ†ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã¦ãã ã•ã„
return (
    <SoundProvider enabled={settings.sound}>
        {/* overflow-hidden ã‚’ overflow-y-auto ã«å¤‰æ›´ã—ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã—ã¾ã™ */}
        <div className="max-w-md mx-auto h-full bg-gray-50 dark:bg-slate-900 shadow-2xl relative overflow-y-auto overflow-x-hidden">
            {view === 'home' && <Home onStart={handleStartPreSelect} onSettings={() => setView('settings')} />}
            
            {/* ãã®ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã¯ãã®ã¾ã¾... */}
            {view === 'settings' && (
                <Settings settings={settings} updateSettings={updateSettings} onBack={() => setView('home')} resetData={resetData} />
            )}

            {view === 'course_select' && (
                <CourseSelection type={activeMode} onSelect={handleCourseSelect} onBack={() => setView('home')} />
            )}

            {view === 'quiz' && (
                <QuizSession 
                    rawData={getDataForMode()} 
                    mode={activeMode} 
                    filterId={courseFilter}
                    isDrillMode={settings.spartan} 
                    onFinish={() => setView('home')} 
                />
            )}
        </div>
    </SoundProvider>
);
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
