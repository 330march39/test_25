<!DOCTYPE html>
<html lang="ja" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TOEIC 700 Booster v3</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e32' }
                    },
                    animation: {
                        'bounce-short': 'bounce 0.5s ease-in-out 1',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out'
                    },
                    keyframes: {
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            touch-action: manipulation;
        }
        
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .selectable-text {
            -webkit-user-select: text;
            user-select: text;
            cursor: text;
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        .glass-panel {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .gold-text {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-press { transition: transform 0.1s, opacity 0.1s; }
        .btn-press:active { transform: scale(0.96); opacity: 0.9; }

        .theme-transition {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-slate-900 text-slate-800 dark:text-slate-100 theme-transition h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, createContext, useContext } = React;

        // ==========================================
        // AUDIO SYSTEM
        // ==========================================
        const SoundContext = createContext();
        const SoundProvider = ({ children, enabled }) => {
            const audioCtxRef = useRef(null);
            const playTone = (freq, type, duration, vol = 0.1) => {
                if (!enabled) return;
                if (!audioCtxRef.current) audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
                const ctx = audioCtxRef.current;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, ctx.currentTime);
                gain.gain.setValueAtTime(vol, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + duration);
            };

            const playSFX = (type) => {
                if (!enabled) return;
                if (navigator.vibrate) {
                    if (type === 'wrong') navigator.vibrate(200);
                    if (type === 'correct') navigator.vibrate(50);
                    if (type === 'click') navigator.vibrate(10);
                }
                switch (type) {
                    case 'correct':
                        playTone(600, 'sine', 0.1, 0.1);
                        setTimeout(() => playTone(1200, 'sine', 0.2, 0.1), 50);
                        break;
                    case 'wrong':
                        playTone(150, 'sawtooth', 0.3, 0.15);
                        setTimeout(() => playTone(100, 'sawtooth', 0.3, 0.15), 100);
                        break;
                    case 'click':
                        playTone(800, 'triangle', 0.05, 0.05);
                        break;
                    case 'complete':
                        playTone(400, 'sine', 0.1);
                        setTimeout(() => playTone(500, 'sine', 0.1), 100);
                        setTimeout(() => playTone(600, 'sine', 0.1), 200);
                        setTimeout(() => playTone(800, 'sine', 0.4), 300);
                        break;
                    default: break;
                }
            };
            return <SoundContext.Provider value={playSFX}>{children}</SoundContext.Provider>;
        };

        // ==========================================
        // DATA (Expanded for TOEIC Prep)
        // ==========================================
        const VOCAB_DATA = [
            // Level 600 (Basic Business)
            { id: 'v1', level: 600, word: "significant", meaning: "かなりの、重要な", type: "vocab", choices: ["一時的な", "微細な", "疑わしい"] },
            { id: 'v2', level: 600, word: "appointment", meaning: "約束、予約、任命", type: "vocab", choices: ["失望", "許可", "評価"] },
            { id: 'v7', level: 600, word: "inventory", meaning: "在庫、棚卸し", type: "vocab", choices: ["投資", "招待状", "発明"] },
            { id: 'v9', level: 600, word: "proposal", meaning: "提案", type: "vocab", choices: ["処分", "目的", "反対"] },
            { id: 'v13', level: 600, word: "annual", meaning: "毎年の、年次の", type: "vocab", choices: ["手動の", "緊急の", "地域の"] },
            { id: 'v14', level: 600, word: "branch", meaning: "支店、枝", type: "vocab", choices: ["ブランド", "橋", "朝食"] },
            { id: 'v15', level: 600, word: "budget", meaning: "予算", type: "vocab", choices: ["橋", "バケツ", "バッジ"] },
            { id: 'v16', level: 600, word: "vehicle", meaning: "乗り物、車両", type: "vocab", choices: ["野菜", "価値", "会場"] },
            { id: 'v17', level: 600, word: "notify", meaning: "知らせる、通知する", type: "vocab", choices: ["気づく", "否定する", "注意する"] },

            // Level 730 (Standard Business)
            { id: 'v3', level: 730, word: "tentative", meaning: "仮の、暫定的な", type: "vocab", choices: ["断定的な", "永久の", "高価な"] },
            { id: 'v4', level: 730, word: "comply", meaning: "（規則などに）従う", type: "vocab", choices: ["不満を言う", "完了する", "比較する"] },
            { id: 'v8', level: 730, word: "reimburse", meaning: "払い戻す", type: "vocab", choices: ["再利用する", "強化する", "輸入する"] },
            { id: 'v10', level: 730, word: "itinerary", meaning: "旅程表", type: "vocab", choices: ["日記", "入り口", "要約"] },
            { id: 'v18', level: 730, word: "agenda", meaning: "議題、協議事項", type: "vocab", choices: ["代理店", "同意", "代理人"] },
            { id: 'v19', level: 730, word: "colleague", meaning: "同僚", type: "vocab", choices: ["大学", "収集", "衝突"] },
            { id: 'v20', level: 730, word: "submit", meaning: "提出する", type: "vocab", choices: ["認める", "購読する", "置換する"] },
            { id: 'v21', level: 730, word: "modify", meaning: "修正する、変更する", type: "vocab", choices: ["拡大する", "維持する", "測定する"] },
            { id: 'v22', level: 730, word: "revise", meaning: "改訂する", type: "vocab", choices: ["考案する", "復活させる", "逆転させる"] },

            // Level 860 (Advanced)
            { id: 'v5', level: 860, word: "imminent", meaning: "差し迫った", type: "vocab", choices: ["無関係な", "巨大な", "不変の"] },
            { id: 'v6', level: 860, word: "lucrative", meaning: "儲かる、利益の上がる", type: "vocab", choices: ["不運な", "創造的な", "緩やかな"] },
            { id: 'v11', level: 860, word: "consecutive", meaning: "連続した", type: "vocab", choices: ["建設的な", "保守的な", "結果的な"] },
            { id: 'v23', level: 860, word: "mandatory", meaning: "義務的な、必須の", type: "vocab", choices: ["任意の", "主要な", "月例の"] },
            { id: 'v24', level: 860, word: "comprehensive", meaning: "包括的な、総合的な", type: "vocab", choices: ["競争力のある", "理解できる", "妥協した"] },
            { id: 'v25', level: 860, word: "subsequently", meaning: "その後、続いて", type: "vocab", choices: ["結果として", "頻繁に", "実質的に"] },

            // Level 900+ (Expert)
            { id: 'v12', level: 900, word: "scrutinize", meaning: "綿密に調べる", type: "vocab", choices: ["要約する", "拡大する", "配布する"] },
            { id: 'v26', level: 900, word: "discrepancy", meaning: "不一致、相違", type: "vocab", choices: ["裁量", "説明", "減少"] },
            { id: 'v27', level: 900, word: "fluctuate", meaning: "変動する、上下する", type: "vocab", choices: ["平らになる", "機能する", "促進する"] },
            { id: 'v28', level: 900, word: "unprecedented", meaning: "前例のない", type: "vocab", choices: ["予測できない", "準備されていない", "無防備な"] },
        ];

        const READING_DATA = [
            { 
                id: 'r1', type: 'reading',
                question: "Ms. Tanaka _______ the budget proposal before the meeting started.", 
                choices: ["reviewed", "reviewing", "reviews", "review"], 
                correct: 0, 
                explanation: "「before...」の節が過去形なので、主節も過去の話。単数主語Ms. Tanakaに対する過去形の動詞reviewedが正解。" 
            },
            { 
                id: 'r2', type: 'reading',
                question: "The new software is _______ easier to use than the old one.", 
                choices: ["significantly", "significant", "significance", "signify"], 
                correct: 0, 
                explanation: "比較級easierを修飾できるのは副詞のみ。significantly（かなり）が正解。" 
            },
            { 
                id: 'r3', type: 'reading',
                question: "Please _______ the attached document for details regarding the itinerary.", 
                choices: ["reference", "refer", "referencing", "referenced"], 
                correct: 0, 
                explanation: "命令文の動詞の原形が必要。「参照する」という意味の他動詞reference、または自動詞refer to...。ここはtoがないので他動詞用法のreferenceが自然（ただしrefer toが一般的）。選択肢の中では文法的に動詞原形が必要。" 
            },
            { 
                id: 'r4', type: 'reading',
                question: "Despite _______ hard, the team could not meet the deadline.", 
                choices: ["working", "work", "worked", "works"], 
                correct: 0, 
                explanation: "Despiteは前置詞なので、後ろには名詞相当語句が来る。動名詞workingが正解。" 
            },
            { 
                id: 'r5', type: 'reading',
                question: "The CEO announced that the merger would take place _______ next year.", 
                choices: ["sometime", "sometimes", "some time", "some times"], 
                correct: 0, 
                explanation: "「いつか」を表す副詞sometimeが適切。sometimesは「時々」。" 
            }
        ];

        const LISTENING_DATA = [
            {
                id: 'l1', type: 'listening',
                script: "Where did you put the monthly report?",
                options: ["It's on your desk.", "At 3 o'clock.", "Yes, I did."],
                correct: 0,
                explanation: "Where（場所）を聞いているので、場所（on your desk）を示しているAが正解。"
            },
            {
                id: 'l2', type: 'listening',
                script: "Why hasn't the shipment arrived yet?",
                options: ["No, I haven't.", "Because of the heavy snow.", "Usually by truck."],
                correct: 1,
                explanation: "Why（理由）を聞いているので、原因（heavy snow）を説明しているBが正解。"
            },
            {
                id: 'l3', type: 'listening',
                script: "Who is responsible for organizing the workshop?",
                options: ["Mr. Sato is.", "In Conference Room B.", "It starts at 10 AM."],
                correct: 0,
                explanation: "Who（誰）を聞いているので、人物（Mr. Sato）を答えているAが正解。"
            },
            {
                id: 'l4', type: 'listening',
                script: "Why don't we take a break for coffee?",
                options: ["I don't like tea.", "That sounds like a good idea.", "It's broken."],
                correct: 1,
                explanation: "Why don't we...? は「～しませんか」という勧誘。それに対する同意「いい考えですね」のBが正解。"
            }
        ];

        // ==========================================
        // UTILS
        // ==========================================
        const speak = (text) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                const voices = window.speechSynthesis.getVoices();
                const enVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Samantha')) || 
                                voices.find(v => v.lang === 'en-US' && v.name.includes('Google')) ||
                                voices.find(v => v.lang === 'en-US');
                if (enVoice) utterance.voice = enVoice;
                window.speechSynthesis.speak(utterance);
            }
        };

        const shuffleArray = (array) => {
            return array.map(value => ({ value, sort: Math.random() }))
                        .sort((a, b) => a.sort - b.sort)
                        .map(({ value }) => value);
        };

        // ==========================================
        // COMPONENTS
        // ==========================================

        const Icon = ({ name, size = 24, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;

        const Button = ({ children, onClick, className = "", variant = "primary", disabled = false, fullWidth = false }) => {
            const playSFX = useContext(SoundContext);
            
            const baseClass = `relative px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 btn-press no-select disabled:opacity-50 disabled:pointer-events-none ${fullWidth ? 'w-full' : ''}`;
            
            const variants = {
                primary: "bg-yellow-500 text-slate-900 shadow-lg shadow-yellow-500/20",
                secondary: "bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-600",
                glass: "glass-panel border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-white hover:bg-slate-100/50 dark:hover:bg-slate-800/50",
                ghost: "text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800",
                danger: "bg-red-500 text-white shadow-lg shadow-red-500/20"
            };

            const handleClick = (e) => {
                if (!disabled) {
                    playSFX('click');
                    if (onClick) onClick(e);
                }
            };

            return (
                <button onClick={handleClick} className={`${baseClass} ${variants[variant]} ${className}`} disabled={disabled}>
                    {children}
                </button>
            );
        };

        const Toggle = ({ checked, onChange }) => (
            <div 
                className={`w-14 h-8 flex items-center bg-gray-300 dark:bg-slate-700 rounded-full p-1 cursor-pointer transition-colors duration-300 ${checked ? 'bg-yellow-500 dark:bg-yellow-500' : ''}`}
                onClick={onChange}
            >
                <div className={`bg-white w-6 h-6 rounded-full shadow-md transform duration-300 ease-in-out ${checked ? 'translate-x-6' : ''}`}></div>
            </div>
        );

        const Header = ({ title, sub, leftIcon, onLeftClick }) => (
            <div className="flex items-center justify-between p-4 glass-panel sticky top-0 z-20 border-b border-gray-200 dark:border-slate-800 no-select transition-colors">
                <div className="flex items-center gap-3">
                    {leftIcon && (
                        <button onClick={onLeftClick} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 transition">
                            <Icon name={leftIcon} className="w-6 h-6 text-slate-600 dark:text-slate-300" />
                        </button>
                    )}
                    <div>
                        <h1 className="text-lg font-bold text-slate-800 dark:text-slate-100 leading-tight">{title}</h1>
                        {sub && <p className="text-xs text-slate-500 dark:text-slate-400">{sub}</p>}
                    </div>
                </div>
            </div>
        );

        // ==========================================
        // COURSE SELECTION SCREEN
        // ==========================================
        const CourseSelection = ({ type, onSelect, onBack }) => {
            const getCourses = () => {
                if (type === 'vocab') {
                    return [
                        { id: 'all', title: '全レベル総合', sub: 'ランダムに出題', icon: 'layers', color: 'text-blue-500', bg: 'bg-blue-100 dark:bg-blue-900/30' },
                        { id: 'weak', title: '苦手克服', sub: '未習得の単語のみ', icon: 'target', color: 'text-red-500', bg: 'bg-red-100 dark:bg-red-900/30' },
                        { id: '600', title: 'Level 600', sub: '基礎・必須レベル', icon: 'zap', color: 'text-green-500', bg: 'bg-green-100 dark:bg-green-900/30' },
                        { id: '730', title: 'Level 730', sub: 'ビジネス標準', icon: 'briefcase', color: 'text-yellow-500', bg: 'bg-yellow-100 dark:bg-yellow-900/30' },
                        { id: '860', title: 'Level 860+', sub: 'ハイスコア・難関', icon: 'award', color: 'text-purple-500', bg: 'bg-purple-100 dark:bg-purple-900/30' },
                    ];
                } else if (type === 'reading') {
                    return [
                        { id: 'all', title: 'Part 5 演習', sub: '全範囲からランダム', icon: 'book-open', color: 'text-blue-500', bg: 'bg-blue-100 dark:bg-blue-900/30' },
                    ];
                } else {
                    return [
                        { id: 'all', title: 'Part 2 応答', sub: '全範囲からランダム', icon: 'headphones', color: 'text-green-500', bg: 'bg-green-100 dark:bg-green-900/30' },
                    ];
                }
            };

            const courses = getCourses();

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-slate-900 animate-fade-in">
                    <Header title="コース選択" sub="学習モードを選んでください" leftIcon="arrow-left" onLeftClick={onBack} />
                    <div className="p-4 space-y-3 overflow-y-auto">
                        {courses.map(course => (
                            <button 
                                key={course.id}
                                onClick={() => onSelect(course.id)}
                                className="w-full bg-white dark:bg-slate-800 p-4 rounded-xl text-left border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all btn-press flex items-center gap-4"
                            >
                                <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${course.bg}`}>
                                    <Icon name={course.icon} className={course.color} />
                                </div>
                                <div>
                                    <h3 className="font-bold text-lg text-slate-800 dark:text-slate-100">{course.title}</h3>
                                    <p className="text-xs text-slate-500">{course.sub}</p>
                                </div>
                                <div className="ml-auto">
                                    <Icon name="chevron-right" className="text-slate-400" size={20} />
                                </div>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // ==========================================
        // QUIZ SESSION
        // ==========================================
        const QuizSession = ({ rawData, mode, filterId, isDrillMode, onComplete }) => {
            const playSFX = useContext(SoundContext);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [selected, setSelected] = useState(null);
            const [isCorrect, setIsCorrect] = useState(null);
            const [streak, setStreak] = useState(0);
            const [showExplanation, setShowExplanation] = useState(false);
            const [isLocked, setIsLocked] = useState(false);
            const [timeLeft, setTimeLeft] = useState(0);

            // Filter data based on selection
            const sessionData = useMemo(() => {
                let filtered = [...rawData];
                const savedProgress = JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}');

                if (mode === 'vocab') {
                    if (filterId === 'weak') {
                        filtered = filtered.filter(item => {
                            const p = savedProgress[item.id];
                            return !p || !p.mastered;
                        });
                        // If no weak items, fallback to all (with shuffle)
                        if (filtered.length === 0) filtered = [...rawData];
                    } else if (filterId === '600') {
                        filtered = filtered.filter(item => item.level === 600);
                    } else if (filterId === '730') {
                        filtered = filtered.filter(item => item.level === 730);
                    } else if (filterId === '860') {
                        filtered = filtered.filter(item => item.level >= 860);
                    }
                }
                
                // Shuffle items
                return shuffleArray(filtered).slice(0, 20); // Limit to 20 questions per session
            }, [rawData, mode, filterId]);

            const currentItem = sessionData[currentIndex];
            const maxTime = mode === 'reading' ? 20 : mode === 'listening' ? 15 : 10;

            // Initialize Timer on new question
            useEffect(() => {
                setTimeLeft(maxTime);
            }, [currentIndex, maxTime]);

            // Setup choices
            const choices = useMemo(() => {
                if (!currentItem) return [];
                if (mode === 'vocab') {
                    return shuffleArray([...currentItem.choices, currentItem.meaning]);
                } else if (mode === 'reading') {
                    return currentItem.choices;
                } else {
                    return currentItem.options;
                }
            }, [currentItem, mode]);

            // Timer Tick
            useEffect(() => {
                if (showExplanation || !currentItem) return;
                const timer = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            clearInterval(timer);
                            handleTimeUp();
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
                return () => clearInterval(timer);
            }, [currentIndex, showExplanation]);

            // Auto-speak
            useEffect(() => {
                if (mode === 'listening' && currentItem && !showExplanation) {
                    const t = setTimeout(() => speak(currentItem.script), 600);
                    return () => clearTimeout(t);
                }
            }, [currentItem, showExplanation, mode]);

            const handleTimeUp = () => {
                playSFX('wrong');
                setIsCorrect(false);
                setShowExplanation(true);
            };

            const handleAnswer = (choice, index) => {
                if (isLocked || showExplanation) return;
                setIsLocked(true);
                setSelected(index);
                
                let correct = false;
                if (mode === 'vocab') correct = choice === currentItem.meaning;
                else correct = index === currentItem.correct;

                setIsCorrect(correct);
                playSFX(correct ? 'correct' : 'wrong');

                // Update Storage
                const savedData = JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}');
                const itemData = savedData[currentItem.id] || { streak: 0, mastered: false };

                if (correct) {
                    setStreak(s => s + 1);
                    itemData.streak += 1;
                    const threshold = isDrillMode ? 2 : 1;
                    if (itemData.streak >= threshold) itemData.mastered = true;
                } else {
                    setStreak(0);
                    itemData.streak = 0;
                }
                savedData[currentItem.id] = itemData;
                localStorage.setItem('toeic_progress_v3', JSON.stringify(savedData));

                // Auto advance logic
                setTimeout(() => {
                    if (correct) {
                        if (mode === 'vocab') nextQuestion();
                        else setShowExplanation(true);
                    } else {
                        setShowExplanation(true);
                    }
                    setIsLocked(false);
                }, correct && mode === 'vocab' ? 700 : 500);
            };

            const nextQuestion = () => {
                if (currentIndex >= sessionData.length - 1) {
                    playSFX('complete');
                    onComplete(streak);
                } else {
                    setCurrentIndex(prev => prev + 1);
                    setSelected(null);
                    setIsCorrect(null);
                    setShowExplanation(false);
                    setTimeLeft(maxTime);
                    setIsLocked(false);
                }
            };

            if (!currentItem) return <div className="h-full flex items-center justify-center text-slate-500">No Data Available</div>;

            const timerColor = timeLeft <= 3 ? "bg-red-500" : "bg-blue-500";

            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-slate-900 transition-colors">
                    <Header 
                        title={mode === 'vocab' ? '単語テスト' : mode === 'listening' ? 'リスニング' : 'リーディング'} 
                        sub={`${currentIndex + 1} / ${sessionData.length} • 連続正解: ${streak}`} 
                        leftIcon="x"
                        onLeftClick={() => onComplete(streak)}
                    />

                    <div className="w-full h-1.5 bg-gray-200 dark:bg-slate-800">
                        <div className={`h-full ${timerColor} transition-all duration-1000 ease-linear`} style={{ width: `${(timeLeft / maxTime) * 100}%` }}></div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 pb-32">
                        <div className="my-6">
                            {mode === 'vocab' && (
                                <div className="text-center animate-fade-in">
                                    <span className="inline-block px-3 py-1 mb-4 text-xs font-bold text-slate-800 bg-yellow-400 rounded-full no-select">
                                        LEVEL {currentItem.level}
                                    </span>
                                    <h2 className="text-4xl font-extrabold text-slate-800 dark:text-white mb-2 tracking-wide selectable-text">
                                        {currentItem.word}
                                    </h2>
                                    {isDrillMode && (
                                        <div className="text-xs text-slate-500 mt-2 flex items-center justify-center gap-1">
                                            <Icon name="dumbbell" size={14} />
                                            <span>特訓中: {JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}')[currentItem.id]?.streak || 0}/2</span>
                                        </div>
                                    )}
                                </div>
                            )}

                            {mode === 'reading' && (
                                <div className="glass-panel p-6 rounded-2xl border border-gray-200 dark:border-slate-700 shadow-sm animate-fade-in">
                                    <p className="text-lg leading-relaxed font-medium text-slate-800 dark:text-slate-100 selectable-text">
                                        {currentItem.question}
                                    </p>
                                </div>
                            )}

                            {mode === 'listening' && (
                                <div className="flex flex-col items-center justify-center py-8 animate-fade-in">
                                    <button 
                                        onClick={() => speak(currentItem.script)}
                                        className="w-24 h-24 rounded-full bg-gray-100 dark:bg-slate-800 border-4 border-yellow-500 flex items-center justify-center shadow-[0_0_30px_rgba(234,179,8,0.3)] btn-press"
                                    >
                                        <Icon name="volume-2" className="w-10 h-10 text-yellow-600 dark:text-yellow-500" />
                                    </button>
                                    <p className="mt-4 text-sm text-slate-500">タップして再生</p>
                                </div>
                            )}
                        </div>

                        <div className="space-y-3">
                            {choices.map((choice, idx) => {
                                let btnClass = "w-full p-4 rounded-xl text-left font-medium text-lg transition-all border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 hover:bg-gray-50 dark:hover:bg-slate-700 shadow-sm";
                                if (selected !== null) {
                                    if (mode === 'vocab') {
                                        if (choice === currentItem.meaning) btnClass = "w-full p-4 rounded-xl text-left font-bold border-2 border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400";
                                        else if (idx === selected) btnClass = "w-full p-4 rounded-xl text-left border-2 border-red-500 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 animate-shake";
                                        else btnClass += " opacity-50";
                                    } else {
                                        if (idx === currentItem.correct) btnClass = "w-full p-4 rounded-xl text-left font-bold border-2 border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400";
                                        else if (idx === selected) btnClass = "w-full p-4 rounded-xl text-left border-2 border-red-500 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 animate-shake";
                                        else btnClass += " opacity-50";
                                    }
                                }
                                return (
                                    <button key={idx} onClick={() => handleAnswer(choice, idx)} disabled={selected !== null} className={`${btnClass} btn-press relative overflow-hidden`}>
                                        <div className="flex items-start">
                                            <span className="inline-flex items-center justify-center min-w-[24px] h-6 rounded bg-gray-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400 text-xs font-bold mr-3 mt-1">
                                                {String.fromCharCode(65 + idx)}
                                            </span>
                                            <span className="selectable-text text-sm md:text-base">{choice}</span>
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    {showExplanation && (
                        <div className="fixed bottom-0 left-0 w-full glass-panel bg-white/95 dark:bg-slate-800/95 border-t border-gray-200 dark:border-slate-600 p-6 z-50 animate-slide-up shadow-[0_-10px_40px_rgba(0,0,0,0.2)]">
                            <div className="max-w-md mx-auto">
                                <div className="flex items-center gap-3 mb-4">
                                    {isCorrect ? (
                                        <div className="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center shrink-0"><Icon name="check" className="text-white w-5 h-5" /></div>
                                    ) : (
                                        <div className="w-8 h-8 rounded-full bg-red-500 flex items-center justify-center shrink-0"><Icon name="x" className="text-white w-5 h-5" /></div>
                                    )}
                                    <h3 className={`text-xl font-bold ${isCorrect ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                                        {isCorrect ? '正解！' : '不正解...'}
                                    </h3>
                                </div>
                                {mode !== 'vocab' && (
                                    <div className="mb-6">
                                        <span className="block text-xs text-slate-400 uppercase font-bold mb-1 tracking-wider">解説</span>
                                        <p className="text-sm leading-relaxed text-slate-700 dark:text-slate-300 selectable-text">{currentItem.explanation}</p>
                                    </div>
                                )}
                                {mode === 'listening' && (
                                    <div className="mb-6 p-3 bg-gray-100 dark:bg-slate-900 rounded-lg text-sm text-slate-600 dark:text-slate-400 italic border border-gray-200 dark:border-slate-700">
                                        "{currentItem.script}"
                                    </div>
                                )}
                                <Button onClick={nextQuestion} className="w-full">次の問題へ <Icon name="arrow-right" size={18} /></Button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // SETTINGS SCREEN
        // ==========================================
        const Settings = ({ settings, updateSettings, onBack, resetData }) => {
            return (
                <div className="flex flex-col h-full bg-gray-50 dark:bg-slate-900 animate-fade-in">
                    <Header title="設定" leftIcon="arrow-left" onLeftClick={onBack} />
                    <div className="p-4 space-y-6">
                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-gray-200 dark:border-slate-700">
                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">表示とサウンド</h3>
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-blue-100 dark:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400"><Icon name={settings.theme === 'dark' ? 'moon' : 'sun'} /></div>
                                    <div><p className="font-bold text-slate-800 dark:text-slate-100">ダークモード</p><p className="text-xs text-slate-500">目に優しい暗色テーマ</p></div>
                                </div>
                                <Toggle checked={settings.theme === 'dark'} onChange={() => updateSettings('theme', settings.theme === 'dark' ? 'light' : 'dark')} />
                            </div>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-green-100 dark:bg-green-900/30 rounded-lg text-green-600 dark:text-green-400"><Icon name={settings.sound ? 'volume-2' : 'volume-x'} /></div>
                                    <div><p className="font-bold text-slate-800 dark:text-slate-100">効果音</p><p className="text-xs text-slate-500">操作音と正誤判定音</p></div>
                                </div>
                                <Toggle checked={settings.sound} onChange={() => updateSettings('sound', !settings.sound)} />
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-gray-200 dark:border-slate-700">
                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">学習設定</h3>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-purple-100 dark:bg-purple-900/30 rounded-lg text-purple-600 dark:text-purple-400"><Icon name="dumbbell" /></div>
                                    <div><p className="font-bold text-slate-800 dark:text-slate-100">特訓モード（スパルタ）</p><p className="text-xs text-slate-500">2回連続正解で「習得済み」</p></div>
                                </div>
                                <Toggle checked={settings.spartan} onChange={() => updateSettings('spartan', !settings.spartan)} />
                            </div>
                        </div>

                        <div className="bg-white dark:bg-slate-800 rounded-2xl p-4 shadow-sm border border-gray-200 dark:border-slate-700">
                            <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">データ管理</h3>
                            <Button variant="danger" className="w-full" onClick={resetData}>
                                <Icon name="trash-2" size={18} /> 学習データをリセット
                            </Button>
                            <p className="text-center text-xs text-slate-400 mt-2">この操作は取り消せません</p>
                        </div>
                        <div className="text-center text-xs text-slate-400 pt-8 pb-4">TOEIC 700 Booster v3.0</div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // HOME SCREEN
        // ==========================================
        const Home = ({ onStart, onSettings }) => {
            const [progress, setProgress] = useState({ mastered: 0, total: VOCAB_DATA.length });

            useEffect(() => {
                const saved = JSON.parse(localStorage.getItem('toeic_progress_v3') || '{}');
                const masteredCount = Object.values(saved).filter(i => i.mastered).length;
                setProgress({ mastered: masteredCount, total: VOCAB_DATA.length });
            }, []);

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-slate-900 text-slate-800 dark:text-white p-6 pb-24 transition-colors">
                    <div className="flex justify-between items-center mb-8 pt-2">
                        <div className="flex items-center gap-2">
                             <div className="w-8 h-8 rounded bg-gradient-to-br from-yellow-400 to-orange-600 flex items-center justify-center text-white font-bold text-xs shadow-lg">T700</div>
                             <span className="font-bold text-lg tracking-tight">Booster</span>
                        </div>
                        <button onClick={onSettings} className="p-2 rounded-full bg-white dark:bg-slate-800 shadow-sm border border-gray-200 dark:border-slate-700 btn-press">
                            <Icon name="settings" className="w-5 h-5 text-slate-600 dark:text-slate-400" />
                        </button>
                    </div>

                    <div className="flex justify-between items-end mb-6">
                        <div>
                            <p className="text-sm text-slate-500 dark:text-slate-400 mb-1">今週の目標</p>
                            <h1 className="text-3xl font-extrabold font-mono gold-text">7 DAYS</h1>
                        </div>
                        <div className="text-right">
                            <div className="inline-flex items-center gap-1 bg-yellow-100 dark:bg-yellow-900/30 px-2 py-1 rounded-md">
                                <span className="text-xs font-bold text-yellow-700 dark:text-yellow-500">TARGET</span>
                            </div>
                            <div className="flex items-baseline justify-end gap-1 mt-1">
                                <span className="text-2xl font-bold text-slate-800 dark:text-white">700</span>
                                <span className="text-xs text-slate-500">点</span>
                            </div>
                        </div>
                    </div>

                    <div className="glass-panel p-6 rounded-2xl mb-8 relative overflow-hidden border border-white dark:border-slate-700 shadow-xl bg-white/40 dark:bg-slate-800/40">
                        <div className="absolute top-0 right-0 p-4 opacity-5 dark:opacity-10 pointer-events-none">
                            <Icon name="award" size={100} className="text-yellow-500" />
                        </div>
                        <div className="relative z-10">
                            <h2 className="text-sm font-bold text-slate-600 dark:text-slate-300 mb-3 uppercase tracking-wider">単語習得率</h2>
                            <div className="flex items-end gap-2 mb-3">
                                <span className="text-5xl font-extrabold text-slate-800 dark:text-white">{Math.round((progress.mastered / progress.total) * 100)}%</span>
                                <span className="text-slate-500 dark:text-slate-400 mb-2 text-sm font-medium">{progress.mastered}/{progress.total} 語</span>
                            </div>
                            <div className="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-3 mb-2 overflow-hidden">
                                <div className="bg-gradient-to-r from-yellow-400 to-orange-500 h-3 rounded-full transition-all duration-1000" style={{ width: `${(progress.mastered / progress.total) * 100}%` }}></div>
                            </div>
                        </div>
                    </div>

                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider ml-1">トレーニング選択</h3>
                    <div className="grid grid-cols-2 gap-4">
                        <button onClick={() => onStart('vocab')} className="bg-white dark:bg-slate-800 p-5 rounded-2xl text-left border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all btn-press group">
                            <div className="bg-yellow-100 dark:bg-yellow-900/30 w-12 h-12 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                                <Icon name="book-open" className="text-yellow-600 dark:text-yellow-500" />
                            </div>
                            <h3 className="font-bold text-lg mb-1 text-slate-800 dark:text-slate-100">重要単語</h3>
                            <p className="text-xs text-slate-500">高速マスター</p>
                        </button>
                        <button onClick={() => onStart('reading')} className="bg-white dark:bg-slate-800 p-5 rounded-2xl text-left border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all btn-press group">
                            <div className="bg-blue-100 dark:bg-blue-900/30 w-12 h-12 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                                <Icon name="glasses" className="text-blue-600 dark:text-blue-500" />
                            </div>
                            <h3 className="font-bold text-lg mb-1 text-slate-800 dark:text-slate-100">リーディング</h3>
                            <p className="text-xs text-slate-500">Part 5 文法・語彙</p>
                        </button>
                        <button onClick={() => onStart('listening')} className="col-span-2 bg-white dark:bg-slate-800 p-5 rounded-2xl text-left border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-md transition-all btn-press group">
                            <div className="flex items-center justify-between">
                                <div>
                                    <div className="bg-green-100 dark:bg-green-900/30 w-12 h-12 rounded-xl flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300">
                                        <Icon name="headphones" className="text-green-600 dark:text-green-500" />
                                    </div>
                                    <h3 className="font-bold text-lg mb-1 text-slate-800 dark:text-slate-100">リスニング</h3>
                                    <p className="text-xs text-slate-500">Part 2 応答問題 (AI音声)</p>
                                </div>
                                <div className="bg-slate-100 dark:bg-slate-700 w-10 h-10 rounded-full flex items-center justify-center">
                                    <Icon name="play" className="w-5 h-5 text-slate-400 dark:text-slate-300 ml-1" />
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            );
        };

        // ==========================================
        // MAIN APP CONTAINER
        // ==========================================
        const App = () => {
            const [view, setView] = useState('home'); // home, settings, course_select_*, quiz_*
            const [activeMode, setActiveMode] = useState(null); // vocab, reading, listening
            const [courseFilter, setCourseFilter] = useState('all'); // all, weak, 600, etc.
            
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem('toeic_settings_v3');
                return saved ? JSON.parse(saved) : { theme: 'dark', sound: true, spartan: false };
            });

            useEffect(() => {
                if (settings.theme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                localStorage.setItem('toeic_settings_v3', JSON.stringify(settings));
            }, [settings]);

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });

            const updateSettings = (key, value) => setSettings(prev => ({ ...prev, [key]: value }));
            const resetData = () => {
                if(confirm("学習データをすべてリセットしますか？この操作は取り消せません。")) {
                    localStorage.removeItem('toeic_progress_v3');
                    window.location.reload();
                }
            };

            const handleStartPreSelect = (mode) => {
                setActiveMode(mode);
                setView('course_select');
            };

            const handleCourseSelect = (filterId) => {
                setCourseFilter(filterId);
                setView('quiz');
            };

            const getDataForMode = () => {
                if (activeMode === 'vocab') return VOCAB_DATA;
                if (activeMode === 'reading') return READING_DATA;
                if (activeMode === 'listening') return LISTENING_DATA;
                return [];
            };

            return (
                <SoundProvider enabled={settings.sound}>
                    <div className="max-w-md mx-auto h-full bg-gray-50 dark:bg-slate-900 shadow-2xl relative overflow-hidden">
                        {view === 'home' && <Home onStart={handleStartPreSelect} onSettings={() => setView('settings')} />}
                        
                        {view === 'settings' && (
                            <Settings settings={settings} updateSettings={updateSettings} onBack={() => setView('home')} resetData={resetData} />
                        )}

                        {view === 'course_select' && (
                            <CourseSelection type={activeMode} onSelect={handleCourseSelect} onBack={() => setView('home')} />
                        )}

                        {view === 'quiz' && (
                            <QuizSession 
                                rawData={getDataForMode()} 
                                mode={activeMode} 
                                filterId={courseFilter}
                                isDrillMode={settings.spartan} 
                                onComplete={() => setView('home')} 
                            />
                        )}
                    </div>
                </SoundProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
