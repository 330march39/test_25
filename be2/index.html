<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Master - Basic English II</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
        }
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #111827;
            }
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- Icons ---
        const Icons = {
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m9 18 6-6-6-6"/></svg>,
            BookOpen: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            CheckCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>,
            XCircle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>,
            Trophy: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Home: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            RotateCcw: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 5v7h7"/></svg>,
            ArrowLeft: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>,
            Star: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            ArrowRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        };

        // --- Quiz Data with Specific Explanations ---
        const quizData = [
            {
                id: 1,
                title: "Lesson 1",
                subtitle: "Part 5: å‹•è© (1)",
                targetTest: [
                    { 
                        id: "L1_T_1", 
                        q: "The film Out in Space received mostly positive reviews and was highly ------- for its brilliant visual effects.", 
                        o: ["praise", "praised", "praises", "praising"], 
                        a: 1,
                        explanation: "æ–‡è„ˆã‹ã‚‰å—å‹•æ…‹ã‚’ä½œã‚‹éå»åˆ†è©ãŒå¿…è¦ã§ã™ã€‚ã€Œæ˜ ç”»ã¯ï½é«˜ãè©•ä¾¡ã•ã‚ŒãŸ(was highly praised)ã€ã¨ã„ã†æ„å‘³ã«ãªã‚Šã¾ã™ã€‚" 
                    },
                    { 
                        id: "L1_T_2", 
                        q: "Warmly ------- by the employees in the Overton branch, the president felt glad he had come all the way despite his busy schedule.", 
                        o: ["welcome", "welcomed", "welcomes", "welcoming"], 
                        a: 1,
                        explanation: "åˆ†è©æ§‹æ–‡ã§ã™ã€‚ã€Œå¾“æ¥­å“¡ã«æ¸©ã‹ãè¿ãˆã‚‰ã‚Œã¦(Welcomed by...)ã€ã¨ã„ã†æ„å‘³ã«ã™ã‚‹ãŸã‚ã€éå»åˆ†è©ã‚’é¸ã³ã¾ã™ã€‚" 
                    },
                    { 
                        id: "L1_T_3", 
                        q: "Gina Carson could not give a prompt reply when ------- a managerial position at a rival company.", 
                        o: ["offer", "offered", "offering", "offers"], 
                        a: 1,
                        explanation: "ã€Œæ¥ç¶šè© + åˆ†è©ã€ã®å½¢ã§ã™ã€‚ã€Œã‚ªãƒ•ã‚¡ãƒ¼ã•ã‚ŒãŸæ™‚(when offered)ã€ã¨ã„ã†å—å‹•ã®æ„å‘³ãŒé©åˆ‡ã§ã™ã€‚" 
                    },
                    { 
                        id: "L1_T_4", 
                        q: "Three people were randomly ------- from the audience and brought up on stage to try a new computer game.", 
                        o: ["select", "selected", "selecting", "selects"], 
                        a: 1,
                        explanation: "beå‹•è©(were)ã®å¾Œã‚ã§ã€å—å‹•æ…‹ã‚’ä½œã‚‹éå»åˆ†è©(selected)ãŒæ­£è§£ã§ã™ã€‚ã€Œç„¡ä½œç‚ºã«é¸ã°ã‚ŒãŸã€ã¨ãªã‚Šã¾ã™ã€‚" 
                    },
                    { 
                        id: "L1_T_5", 
                        q: "------- project leader, Scott Thorne delegated various tasks to his team members at the meeting.", 
                        o: ["Being chosen", "Choose", "Choosing", "Chose"], 
                        a: 0,
                        explanation: "åˆ†è©æ§‹æ–‡ã§ã™ã€‚ã€Œãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ¼ãƒ€ãƒ¼ã«é¸ã°ã‚ŒãŸã®ã§(Being chosen)ã€ã¨ã„ã†ç†ç”±ã‚’è¡¨ã—ã¾ã™ã€‚" 
                    },
                    { 
                        id: "L1_T_6", 
                        q: "The lawyer argued in court that his client ------- illegally in prison and should be released right away.", 
                        o: ["held", "holds", "is being held", "is holding"], 
                        a: 2,
                        explanation: "ã€Œä»Šç¾åœ¨ã€ä¸å½“ã«æ‹˜ç•™ã•ã‚Œã¦ã„ã‚‹ã€ã¨ã„ã†é€²è¡Œä¸­ã®å—å‹•æ…‹ã‚’è¡¨ã™ãŸã‚ã€'is being held'ãŒé©åˆ‡ã§ã™ã€‚" 
                    },
                    { 
                        id: "L1_T_7", 
                        q: "The sales director proposed that the campaign materials ------- printed in English as well as in Japanese.", 
                        o: ["are", "be", "were", "would be"], 
                        a: 1,
                        explanation: "ææ¡ˆ(propose)ãªã©ã®å‹•è©ã®å¾Œã‚ã®thatç¯€å†…ã§ã¯ã€å‹•è©ã¯åŸå½¢(be)ã‚’ä½¿ã„ã¾ã™ï¼ˆä»®å®šæ³•ç¾åœ¨ï¼‰ã€‚" 
                    },
                    { 
                        id: "L1_T_8", 
                        q: "After all the applications are reviewed, qualified candidates will ------- to schedule an interview.", 
                        o: ["be called", "call", "called", "calling"], 
                        a: 0,
                        explanation: "å€™è£œè€…ã¯ã€Œé›»è©±ã•ã‚Œã‚‹ï¼ˆé€£çµ¡ã‚’å—ã‘ã‚‹ï¼‰ã€å´ãªã®ã§ã€å—å‹•æ…‹ã® 'be called' ãŒæ­£è§£ã§ã™ã€‚" 
                    }
                ],
                reviewQuiz: [
                    { 
                        id: "L1_R_1", 
                        q: "Marie Chang was ------- to accompany the president just two days before the business trip.", 
                        o: ["assign", "assigned", "assigning", "to assign"], 
                        a: 1,
                        explanation: "beå‹•è©(was)ã®å¾Œã‚ã§å—å‹•æ…‹ã‚’ä½œã‚Šã¾ã™ã€‚ã€Œä»»å‘½ã•ã‚ŒãŸ(assigned)ã€ãŒé©åˆ‡ã§ã™ã€‚" 
                    },
                    { 
                        id: "L1_R_2", 
                        q: "It is strongly suggested that smoking and drinking ------- avoided during pregnancy.", 
                        o: ["are", "be", "were", "will be"], 
                        a: 1,
                        explanation: "suggestedï¼ˆææ¡ˆï¼‰ã®å¾Œã‚ã®thatç¯€å†…ãªã®ã§ã€å‹•è©ã®åŸå½¢(be)ã‚’ä½¿ã„ã¾ã™ã€‚" 
                    },
                    { 
                        id: "L1_R_3", 
                        q: "Lea Johnson was extremely proud to have her design ------- for the new building.", 
                        o: ["choose", "choosing", "chose", "chosen"], 
                        a: 3,
                        explanation: "ã€Œhave + ç›®çš„èª + éå»åˆ†è©ã€ã§ã€Œï½ã‚’â€¦ã—ã¦ã‚‚ã‚‰ã†ã€ã®å½¢ã§ã™ã€‚ã€Œãƒ‡ã‚¶ã‚¤ãƒ³ãŒé¸ã°ã‚ŒãŸçŠ¶æ…‹ã«ã™ã‚‹ï¼é¸ã‚“ã§ã‚‚ã‚‰ã†ã€ã§ã™ã€‚" 
                    },
                    { 
                        id: "L1_R_4", 
                        q: "Due to mechanical difficulties, the FER flight was ------- by three hours.", 
                        o: ["delay", "delayed", "delaying", "delays"], 
                        a: 1,
                        explanation: "ã€Œé…å»¶ã•ã›ã‚‰ã‚ŒãŸã€ã¨ã„ã†å—å‹•æ…‹ã®æ„å‘³ã«ãªã‚‹ãŸã‚ã€éå»åˆ†è© 'delayed' ã‚’é¸ã³ã¾ã™ã€‚" 
                    }
                ]
            },
            {
                id: 2,
                title: "Lesson 2",
                subtitle: "Part 6: å‹•è© (2)",
                targetTest: [
                    { 
                        id: "L2_T_1",
                        passage: "Please be informed that effective September 1, all requests for vacation or sick leave must be filed through the company intranet site. (1) Click on 'Leave Request' to access the form you (2). All paper forms currently (3) will be collected by supervisors and managers for recycling.\n\nSocial responsibility is part of our company's mission statement, and this is one way to put into practice what we believe. Please join us in our promotion of a paperless environment in this company, a small effort (4) the global environment.",
                        q: "(1) Select the best sentence.", 
                        o: ["No vacation days will be granted until the project is finished.", "Please check on Order, then fill out the Payment information.", "There is a new category for vacation/sick leave on the home menu.", "There will be a training session about the new retirement benefits soon."], 
                        a: 2,
                        explanation: "æ–‡è„ˆåˆ¤æ–­ã§ã™ã€‚ã‚¤ãƒ³ãƒˆãƒ©ãƒãƒƒãƒˆã§ã®ä¼‘æš‡ç”³è«‹ã«ã¤ã„ã¦ã®è©±ãªã®ã§ã€ã€Œãƒ›ãƒ¼ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒã‚ã‚‹ã€ã¨ã„ã†(C)ãŒæ–‡è„ˆã«åˆã„ã¾ã™ã€‚" 
                    },
                    { 
                        id: "L2_T_2", 
                        passage: "Same passage as above.", 
                        q: "(2)", 
                        o: ["need", "needed", "needing", "needs"], 
                        a: 0,
                        explanation: "é–¢ä¿‚ä»£åè©ã®çœç•¥ã§ã™ã€‚ã€Œã‚ãªãŸãŒå¿…è¦ã¨ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ (the form [that] you need)ã€ã¨ãªã‚Šã¾ã™ã€‚" 
                    },
                    { 
                        id: "L2_T_3", 
                        passage: "Same passage as above.", 
                        q: "(3)", 
                        o: ["being used", "to be used", "use", "using"], 
                        a: 0,
                        explanation: "ã€Œç¾åœ¨ä½¿ã‚ã‚Œã¦ã„ã‚‹(currently being used)ã€ã¨ã„ã†é€²è¡Œå—å‹•ã®æ„å‘³ã‚’æŒã¤åˆ†è©å¥ãŒpaper formsã‚’ä¿®é£¾ã—ã¾ã™ã€‚" 
                    },
                    { 
                        id: "L2_T_4", 
                        passage: "Same passage as above.", 
                        q: "(4)", 
                        o: ["help", "helped", "helping", "to help"], 
                        a: 3,
                        explanation: "ã€Œï½ã™ã‚‹ãŸã‚ã®å°ã•ãªåŠªåŠ›ã€ã¨ã„ã†æ„å‘³ã§ã€ä¸å®šè©ã®å½¢å®¹è©çš„ç”¨æ³• 'to help' ãŒé©åˆ‡ã§ã™ã€‚" 
                    }
                ],
                reviewQuiz: [
                    {
                        id: "L2_R_1",
                        passage: "Jasper Enterprises (1) yesterday that as of November 18, the new chief of operations will be Veronica Holmes. Ms. Holmes comes to Jasper from Monroe Group...",
                        q: "(1)", 
                        o: ["announce", "announced", "announces", "announcing"], 
                        a: 1,
                        explanation: "æ–‡æœ«ã« 'yesterday' ãŒã‚ã‚‹ãŸã‚ã€éå»å½¢ 'announced' ã‚’é¸ã³ã¾ã™ã€‚"
                    },
                    { 
                        id: "L2_R_2", 
                        passage: "Same passage as above.", 
                        q: "(2)", 
                        o: ["free", "freed", "freeing", "frees"], 
                        a: 2,
                        explanation: "åˆ†è©æ§‹æ–‡ã§ã™ã€‚ã€Œï½ã‚’è§£æ”¾ã™ã‚‹ã“ã¨ã«ãªã‚‹(freeing up...)ã€ã¨ã€çµæœã‚„ä»˜å¸¯çŠ¶æ³ã‚’è¡¨ã—ã¾ã™ã€‚" 
                    }
                ]
            },
            {
                id: 3,
                title: "Lesson 3",
                subtitle: "Part 7: æ¦‚è¦ç†è§£å•é¡Œ",
                targetTest: [
                    {
                        id: "L3_T_1",
                        passage: "Dear Mike,\n\nIf you remember, we met at the recent Business Educators seminar and spoke briefly about my doing some classes at your college...",
                        q: "1. What is the reason Ms. Chase wrote this letter?", 
                        o: ["To change a current class she teaches", "To correct information on a course", "To enroll in a course", "To propose giving a course"], 
                        a: 3,
                        explanation: "æ‰‹ç´™ã®å†’é ­ã§ã€Œã‚ãªãŸã®å¤§å­¦ã§ã‚¯ãƒ©ã‚¹ã‚’æŒã¤ã“ã¨ã€ã«ã¤ã„ã¦è§¦ã‚Œã€ã‚³ãƒ¼ã‚¹ã®ææ¡ˆã‚’ã—ã¦ã„ã‚‹ãŸã‚ (D) ãŒæ­£è§£ã§ã™ã€‚"
                    },
                    { 
                        id: "L3_T_2", 
                        passage: "Same passage as above.", 
                        q: "2. Who does Ms. Chase target in her course?", 
                        o: ["Accountants", "Business consultants", "Business educators", "Small business owners"], 
                        a: 3,
                        explanation: "ç¬¬2æ®µè½ã« \"designed for people who ... are running their own businesses\"ï¼ˆè‡ªåˆ†ã®ãƒ“ã‚¸ãƒã‚¹ã‚’çµŒå–¶ã—ã¦ã„ã‚‹äººã€…å‘ã‘ï¼‰ã¨ã‚ã‚Šã¾ã™ã€‚" 
                    },
                    {
                        id: "L3_T_4",
                        passage: "The local business community gives annual awards for the \"Best Company to Work for in the region\" each year...",
                        q: "4. What is the article mainly about?", 
                        o: ["A local firm's change in leadership", "A recent local award winner", "A summary past years' award winners", "An important trade agreement"], 
                        a: 1,
                        explanation: "è¨˜äº‹ã®ä¸»æ—¨ã¯ã€Rightway BicyclesãŒã€ŒBest Company to Work forã€ã¨ã„ã†è³ã‚’å—è³ã—ãŸã“ã¨ã§ã™ã€‚"
                    }
                ],
                reviewQuiz: [
                    {
                        id: "L3_R_1",
                        passage: "Introducing the Zephyr 900 vacuum cleaner! This is the single most advanced vacuum cleaner ever built...",
                        q: "1. What is this advertisement for?", 
                        o: ["A detergent", "A household appliance", "A laundry service", "An electronics store"], 
                        a: 1,
                        explanation: "vacuum cleanerï¼ˆæƒé™¤æ©Ÿï¼‰ã®åºƒå‘Šãªã®ã§ã€(B)ã€Œå®¶åº­ç”¨é›»åŒ–è£½å“ã€ãŒæ­£è§£ã§ã™ã€‚"
                    }
                ]
            },
            {
                id: 4,
                title: "Lesson 4",
                subtitle: "Part 5: ä»£åè© (1)",
                targetTest: [
                    { id: "L4_T_1", q: "Mark and Sarah reviewed the financial report before submitting ------- to the supervisor.", o: ["it", "its", "themselves", "them"], a: 0, explanation: "å˜æ•°ã® 'financial report' ã‚’æŒ‡ã™ãŸã‚ã€ä»£åè© 'it' ãŒé©åˆ‡ã§ã™ã€‚" },
                    { id: "L4_T_2", q: "We usually ask for advice from people ------- trust, such as colleagues, friends, or family members.", o: ["our", "ours", "us", "we"], a: 3, explanation: "é–¢ä¿‚ä»£åè©ã®çœç•¥ãŒã‚ã‚Šã€ã€Œç§ãŸã¡ãŒä¿¡é ¼ã™ã‚‹äººã€…(people [whom] we trust)ã€ã¨ãªã‚‹ãŸã‚ã€ä¸»æ ¼ã® 'we' ãŒå…¥ã‚Šã¾ã™ã€‚" },
                    { id: "L4_T_3", q: "Research has shown that our sense of balance and movement change as we age, and ------- changes could lead to a higher risk of falling.", o: ["that", "these", "them", "this"], a: 1, explanation: "è¤‡æ•°å½¢ã®åè© 'changes' ã‚’æŒ‡ã™æŒ‡ç¤ºå½¢å®¹è©ãªã®ã§ã€'these' ãŒæ­£è§£ã§ã™ã€‚" },
                    { id: "L4_T_4", q: "Unless you are a paid subscriber of our magazine, you can only read a summary of the articles, not the actual articles -------.", o: ["it", "itself", "them", "themselves"], a: 3, explanation: "ã€Œè¨˜äº‹ãã‚Œè‡ªä½“ã€ã‚’å¼·èª¿ã™ã‚‹ãŸã‚ã®å†å¸°ä»£åè©ã§ã™ã€‚articlesï¼ˆè¤‡æ•°ï¼‰ãªã®ã§ 'themselves' ã§ã™ã€‚" }
                ],
                reviewQuiz: [
                    { id: "L4_R_1", q: "The manager spent extra time talking with the new employees to learn about ------- talents, abilities, and skills.", o: ["their", "theirs", "them", "they"], a: 0, explanation: "ã€Œå½¼ã‚‰ã®æ‰èƒ½ã€ã¨è¨€ã†ãŸã‚ã€æ‰€æœ‰æ ¼ã® 'their' ãŒå¿…è¦ã§ã™ã€‚" }
                ]
            },
            {
                id: 5,
                title: "Lesson 5",
                subtitle: "Part 6: ä»£åè© (2)",
                targetTest: [
                    {
                        id: "L5_T_1",
                        passage: "To: Cynthia Holmes <holmes@goldenyears.net>\nFrom: Shunsuke Takahashi <stakahashi@homehealth.net>\nRe: Your opinion about HomeCare 2016\n\nDear Cynthia,\n\n(1) was nice seeing you last week at the seminar...",
                        q: "(1)", 
                        o: ["I", "It", "That", "This"], 
                        a: 1,
                        explanation: "å½¢å¼ä¸»èªã®Itã§ã™ã€‚ã€Œï½ã§ãã¦ã‚ˆã‹ã£ãŸ(It was nice seeing you...)ã€ã¨ã„ã†æ…£ç”¨è¡¨ç¾ã§ã™ã€‚"
                    },
                    { 
                        id: "L5_T_2", 
                        passage: "Same passage as above.", 
                        q: "(2)", 
                        o: ["his", "my", "their", "your"], 
                        a: 1,
                        explanation: "æ›¸ãæ‰‹ï¼ˆShunsukeï¼‰è‡ªèº«ã®éƒ¨ç½²ã«ã¤ã„ã¦è©±ã—ã¦ã„ã‚‹æ–‡è„ˆãªã®ã§ã€'my' department ãŒé©åˆ‡ã§ã™ã€‚" 
                    }
                ],
                reviewQuiz: [
                    {
                        id: "L5_R_1",
                        passage: "Dear Ms. Patchett,\n\nThank you for your inquiry about (1) award-winning video series Out and About in Nature...",
                        q: "(1)", 
                        o: ["our", "ours", "us", "we"], 
                        a: 0,
                        explanation: "ã€Œå½“ç¤¾ã®ãƒ“ãƒ‡ã‚ªã‚·ãƒªãƒ¼ã‚ºã€ã¨ã„ã†æ„å‘³ã«ã™ã‚‹ãŸã‚ã€æ‰€æœ‰æ ¼ã® 'our' ãŒæ­£è§£ã§ã™ã€‚"
                    }
                ]
            },
            {
                id: 6,
                title: "Lesson 6",
                subtitle: "Part 7: æ¦‚è¦æ¨æ¸¬å•é¡Œ",
                targetTest: [
                    {
                        id: "L6_T_1",
                        passage: "Notice for all Lawn Villa Apartments residents\n\nYou may have noticed several trucks and bulldozers parked near the entrance to the apartments recently. The city is doing some renovations to the park on the east side of the building...",
                        q: "1. What is the main purpose of the notice?", 
                        o: ["To announce that there will be a new park nearby", "To apologize for the noise due to construction", "To give information about public works", "To prohibit illegal parking near the building"], 
                        a: 2,
                        explanation: "å·¥äº‹ï¼ˆå…¬å…±äº‹æ¥­ï¼‰ã«ã¤ã„ã¦ã®æƒ…å ±ã‚’æä¾›ã—ã€ä½æ°‘ã«çŸ¥ã‚‰ã›ã‚‹ã“ã¨ãŒä¸»ãªç›®çš„ã§ã™ã€‚"
                    }
                ],
                reviewQuiz: [
                    {
                        id: "L6_R_1",
                        passage: "Handy Tool Rental has everything you need for any project, big or small...",
                        q: "1. What is this advertisement for?", 
                        o: ["Car rental", "Delivery service", "Equipment rental", "Renovations"], 
                        a: 2,
                        explanation: "å·¥å…·ã‚„é‡æ©Ÿã®ãƒ¬ãƒ³ã‚¿ãƒ«ã«ã¤ã„ã¦ã®åºƒå‘Šãªã®ã§ã€(C)ã€ŒEquipment rentalã€ãŒæ­£è§£ã§ã™ã€‚"
                    }
                ]
            },
            {
                id: 7,
                title: "Lesson 7",
                subtitle: "Part 5: é–¢ä¿‚è© (1)",
                targetTest: [
                    { id: "L7_T_1", q: "According to a recent study, those ------- regularly read food labels tend to be healthier.", o: ["what", "when", "where", "who"], a: 3, explanation: "å…ˆè¡Œè©ãŒ 'those'ï¼ˆäººã€…ï¼‰ãªã®ã§ã€é–¢ä¿‚ä»£åè© 'who' ã‚’é¸ã³ã¾ã™ã€‚" },
                    { id: "L7_T_2", q: "------- today's board meeting ends, Ms. Kane will have her staff clean the conference room.", o: ["When", "Which", "Who", "Why"], a: 0, explanation: "ã€Œä¼šè­°ãŒçµ‚ã‚ã£ãŸæ™‚ã€ã¨ã„ã†æ™‚ã‚’è¡¨ã™å‰¯è©ç¯€ã‚’ä½œã‚‹ãŸã‚ã€'When' ãŒé©åˆ‡ã§ã™ã€‚" },
                    { id: "L7_T_3", q: "Ava Watson has a large collection of rare stamps, some of ------- were issued about 100 years ago.", o: ["that", "what", "which", "whom"], a: 2, explanation: "ã€Œsome of + é–¢ä¿‚ä»£åè©ã€ã®å½¢ã€‚å…ˆè¡Œè©ãŒstampsï¼ˆç‰©ï¼‰ãªã®ã§ 'which' ãŒæ­£è§£ã§ã™ã€‚" }
                ],
                reviewQuiz: [
                    { id: "L7_R_1", q: "Nobody knew ------- Theo Cain had done for a living before joining our company.", o: ["as", "that", "what", "which"], a: 2, explanation: "ã€Œå½¼ãŒä½•ã‚’ã—ã¦ã„ãŸã‹ã€ã¨ã„ã†æ„å‘³ã®é–“æ¥ç–‘å•æ–‡ã‚’ä½œã‚‹ãŸã‚ã€'what' ãŒé©åˆ‡ã§ã™ã€‚" }
                ]
            },
            {
                id: 8,
                title: "Lesson 8",
                subtitle: "Part 6: é–¢ä¿‚è© (2)",
                targetTest: [
                    {
                        id: "L8_T_1",
                        passage: "To: Conrad van Mansum\nFrom: Customer Service\nSubject: re: your query\n\nDear Mr. van Mansum,\n\nThank you for your recent query regarding our personal concierge service. I have attached a brochure with the information (1) you requested...",
                        q: "(1)", 
                        o: ["that", "what", "where", "whom"], 
                        a: 0,
                        explanation: "å…ˆè¡Œè©ãŒ 'information' ãªã®ã§ã€é–¢ä¿‚ä»£åè© 'that'ï¼ˆã¾ãŸã¯whichï¼‰ãŒé©åˆ‡ã§ã™ã€‚"
                    }
                ],
                reviewQuiz: [
                    {
                        id: "L8_R_1",
                        passage: "To all staff:\n\nAs you are aware, our offices will undergo extensive renovation next week... Cardboard boxes, (1) are available in the storeroom, can be used for this purpose.",
                        q: "(1)", 
                        o: ["how", "that", "what", "which"], 
                        a: 3,
                        explanation: "éåˆ¶é™ç”¨æ³•ã®é–¢ä¿‚ä»£åè©ã§ã™ã€‚å…ˆè¡Œè©ãŒ 'Cardboard boxes'ï¼ˆç‰©ï¼‰ãªã®ã§ã€ã‚«ãƒ³ãƒã®å¾Œã‚ã§ã¯ 'which' ã‚’ä½¿ã„ã¾ã™ï¼ˆthatã¯ä¸å¯ï¼‰ã€‚"
                    }
                ]
            },
            {
                id: 12,
                title: "Lesson 12",
                subtitle: "Part 7: è©³ç´°æ¨æ¸¬å•é¡Œ",
                targetTest: [
                    {
                        id: "L12_T_3",
                        passage: "To: Jane Hamilton <Jane@css.com>\nFrom: Mike Kipling <MK@commercenews.com>\nRe: Membership Renewal\n\nDear Ms. Hamilton,\n\nThank you for renewing your membership with Commerce News...",
                        q: "3. What is the main purpose of this e-mail?", 
                        o: ["To announce membership rate changes", "To ask a subscriber for a renewal", "To introduce a publication", "To show appreciation to a customer"], 
                        a: 3,
                        explanation: "å†’é ­ã§ã€Œæ›´æ–°ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€ã¨è¿°ã¹ã¦ãŠã‚Šã€é¡§å®¢ã¸ã®æ„Ÿè¬ã‚’ç¤ºã™ã“ã¨ãŒç›®çš„ã§ã™ã€‚"
                    }
                ],
                reviewQuiz: [
                    {
                        id: "L12_R_1",
                        passage: "Choose Foster Catering!\n\nFoster Catering has over twelve years' experience in providing corporate customers in Central Valley...",
                        q: "1. Who would most likely be interested in Foster Catering service?", 
                        o: ["A group planning a picnic for local children", "Companies arranging a business meeting", "Couples who are planning a wedding reception", "People who are having a private party"], 
                        a: 1,
                        explanation: "ã€Œcorporate customersï¼ˆæ³•äººé¡§å®¢ï¼‰ã€å‘ã‘ã¨æ˜è¨˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ“ã‚¸ãƒã‚¹ä¼šè­°ã‚’æ‰‹é…ã™ã‚‹ä¼æ¥­(B)ãŒé©åˆ‡ã§ã™ã€‚"
                    }
                ]
            },
            {
                id: 13,
                title: "Lesson 13",
                subtitle: "Part 5: èªå½™ (2)",
                targetTest: [
                    { id: "L13_T_1", q: "We may disclose your medical records to doctors, nurses or other hospital ------- who are involved in your care.", o: ["colonel", "model", "panel", "personnel"], a: 3, explanation: "ã€Œç—…é™¢è·å“¡ã€ã¨ã„ã†æ„å‘³ã«ã™ã‚‹ãŸã‚ã€'personnel' ãŒé©åˆ‡ã§ã™ã€‚" },
                    { id: "L13_T_2", q: "The Purple Dawn is a classic musical which has also made a great ------- to popular music.", o: ["adaptation", "contribution", "donation", "evolution"], a: 1, explanation: "make a contribution to...ï¼ˆï½ã«è²¢çŒ®ã™ã‚‹ï¼‰ã¨ã„ã†ã‚³ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚" }
                ],
                reviewQuiz: []
            },
            {
                id: 14,
                title: "Lesson 14",
                subtitle: "ç·å¾©ç¿’",
                targetTest: [
                    { id: "L14_T_2", q: "Under the new policy, the telecom giant, XYZ Wires will have to consult with neighboring communities ------- they build a new tower.", o: ["across", "before", "beyond", "until"], a: 1, explanation: "ã€Œæ–°ã—ã„å¡”ã‚’å»ºã¦ã‚‹ã€å‰ã«ã€å”è­°ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã€ã¨ã„ã†æ–‡è„ˆãŒè‡ªç„¶ã§ã™ã€‚" }
                ],
                reviewQuiz: [
                    {
                        id: "L14_R_5",
                        passage: "To: Heidi Wyatt <HWyatt@ProSoft.com>\nFrom: Jan Johnson <JJohnson@ProSoft.com>\nSubject: Team meeting site\n\nHeidi,\n\nYou asked me last week if I had any ideas for a location for the team meeting...",
                        q: "25. Why did Ms. Johnson write to Ms. Wyatt?", 
                        o: ["She found an error in their ad.", "She got an idea for their project.", "She had a good time at the retreat.", "She has a suggestion about a meeting."], 
                        a: 3,
                        explanation: "ãƒãƒ¼ãƒ ãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å ´æ‰€ã«ã¤ã„ã¦ææ¡ˆãŒã‚ã‚‹ãŸã‚ãƒ¡ãƒ¼ãƒ«ã‚’æ›¸ã„ã¦ã„ã¾ã™ã€‚"
                    }
                ]
            }
        ];

        // --- Components ---

        const LessonCard = ({ lesson, onSelect, index, masteredCount, totalCount }) => {
            const isCompleted = masteredCount === totalCount && totalCount > 0;
            const progress = totalCount > 0 ? (masteredCount / totalCount) * 100 : 0;

            return (
                <motion.div
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ delay: index * 0.05 }}
                    onClick={() => onSelect(lesson)}
                    className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl hover:scale-[1.02] transition-all border border-gray-100 dark:border-gray-700 relative overflow-hidden group"
                >
                    <div className="absolute top-0 right-0 w-24 h-24 bg-blue-100 dark:bg-blue-900 rounded-bl-full -mr-4 -mt-4 opacity-50 group-hover:scale-110 transition-transform"></div>
                    <div className="flex justify-between items-start relative z-10">
                        <div>
                            <h3 className="text-xl font-bold text-gray-800 dark:text-white mb-1">{lesson.title}</h3>
                            <p className="text-sm text-gray-500 dark:text-gray-400">{lesson.subtitle}</p>
                        </div>
                        {isCompleted && <div className="bg-yellow-100 text-yellow-600 p-1 rounded-full"><Icons.Star className="w-6 h-6 fill-current" /></div>}
                    </div>
                    
                    <div className="mt-4">
                        <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div className="bg-blue-600 h-2 rounded-full transition-all duration-500" style={{ width: `${progress}%` }}></div>
                        </div>
                        <p className="text-xs text-gray-400 mt-1 text-right">{masteredCount} / {totalCount} Cleared</p>
                    </div>

                    <div className="mt-2 flex items-center text-blue-600 dark:text-blue-400 font-medium relative z-10">
                        Start Lesson <Icons.ChevronRight className="w-4 h-4 ml-1" />
                    </div>
                </motion.div>
            );
        };

        const ExplanationBox = ({ isCorrect, correctAnswer, explanation, onNext }) => {
            return (
                <motion.div 
                    initial={{ opacity: 0, height: 0 }}
                    animate={{ opacity: 1, height: 'auto' }}
                    className={`mt-6 rounded-2xl overflow-hidden shadow-lg border-2 ${isCorrect ? 'border-green-100 dark:border-green-900 bg-green-50 dark:bg-green-900/10' : 'border-red-100 dark:border-red-900 bg-red-50 dark:bg-red-900/10'}`}
                >
                    <div className="p-5">
                        <div className="flex items-center gap-3 mb-3">
                            {isCorrect ? (
                                <Icons.CheckCircle className="w-8 h-8 text-green-500 flex-shrink-0" />
                            ) : (
                                <Icons.XCircle className="w-8 h-8 text-red-500 flex-shrink-0" />
                            )}
                            <div>
                                <h3 className={`text-lg font-bold ${isCorrect ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400'}`}>
                                    {isCorrect ? "æ­£è§£ï¼" : "æ®‹å¿µ..."}
                                </h3>
                                {!isCorrect && (
                                    <p className="text-sm text-gray-600 dark:text-gray-300">
                                        æ­£è§£ã¯ <span className="font-bold">{correctAnswer}</span> ã§ã™
                                    </p>
                                )}
                            </div>
                        </div>

                        {explanation && (
                            <div className="mt-3 p-4 bg-white dark:bg-gray-800 rounded-xl text-sm leading-relaxed text-gray-700 dark:text-gray-300 shadow-sm">
                                <span className="font-bold block mb-1 text-blue-600 dark:text-blue-400">ğŸ“ è§£èª¬:</span>
                                {explanation}
                            </div>
                        )}
                        
                        <button 
                            onClick={onNext}
                            className={`w-full mt-4 py-3 rounded-xl font-bold text-white transition-all shadow-md active:scale-[0.98] flex items-center justify-center gap-2 ${isCorrect ? 'bg-green-500 hover:bg-green-600 shadow-green-200 dark:shadow-none' : 'bg-red-500 hover:bg-red-600 shadow-red-200 dark:shadow-none'}`}
                        >
                            Next Question <Icons.ArrowRight className="w-4 h-4" />
                        </button>
                    </div>
                </motion.div>
            );
        };

        const QuizGame = ({ questions, lessonAdvice, onComplete, onExit, onMasterQuestion }) => {
            const [currentIndex, setCurrentIndex] = useState(0);
            const [selectedOption, setSelectedOption] = useState(null);
            const [showFeedback, setShowFeedback] = useState(false);
            const [isCorrect, setIsCorrect] = useState(false);
            const [score, setScore] = useState(0);
            const [showPassage, setShowPassage] = useState(false);
            
            // Ref to scroll to feedback
            const feedbackRef = useRef(null);

            const currentQ = questions[currentIndex];
            const hasPassage = !!currentQ.passage;

            useEffect(() => {
                // Reset state when question changes
                setSelectedOption(null);
                setShowFeedback(false);
                setIsCorrect(false);
                setShowPassage(false);
            }, [currentIndex]);

            useEffect(() => {
                if (showFeedback && feedbackRef.current) {
                    // Smooth scroll to show the feedback
                    setTimeout(() => {
                        feedbackRef.current.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                }
            }, [showFeedback]);

            if (!currentQ) return <div className="p-10 text-center text-white">Loading...</div>;

            const handleOptionClick = (optionIndex) => {
                if (selectedOption !== null) return; 

                const correct = optionIndex === currentQ.a;
                setSelectedOption(optionIndex);
                setIsCorrect(correct);
                setShowFeedback(true);
                
                if (correct) {
                    setScore(s => s + 1);
                    onMasterQuestion(currentQ.id); 
                }
            };

            const handleNext = () => {
                if (currentIndex < questions.length - 1) {
                    setCurrentIndex(c => c + 1);
                } else {
                    onComplete(score, questions.length); 
                }
            };

            const progress = ((currentIndex + 1) / questions.length) * 100;
            const correctOptionLabel = String.fromCharCode(65 + currentQ.a);
            const correctOptionText = currentQ.o[currentQ.a];
            const displayCorrectAnswer = `(${correctOptionLabel}) ${correctOptionText}`;
            
            // Use specific explanation if available, otherwise fallback to lesson advice (or generic message)
            const explanationText = currentQ.explanation || lessonAdvice || "æ–‡è„ˆã¨æ–‡æ³•ãƒ«ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚";

            return (
                <div className="h-full flex flex-col relative overflow-hidden bg-gray-50 dark:bg-gray-900">
                    {/* Header */}
                    <div className="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-800 z-20 shadow-sm">
                        <button onClick={onExit} className="p-2 -ml-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-white transition-colors">
                            <Icons.XCircle className="w-6 h-6" />
                        </button>
                        <div className="flex-1 mx-4">
                            <div className="h-2 bg-gray-100 dark:bg-gray-700 rounded-full overflow-hidden">
                                <motion.div 
                                    className="h-full bg-blue-500"
                                    initial={{ width: 0 }}
                                    animate={{ width: `${progress}%` }}
                                    transition={{ duration: 0.5 }}
                                />
                            </div>
                        </div>
                        <span className="text-sm font-bold text-gray-500 dark:text-gray-400">
                            {currentIndex + 1}/{questions.length}
                        </span>
                    </div>

                    {/* Content */}
                    <div className="flex-1 overflow-y-auto p-4 pb-24 relative scroll-smooth">
                        <AnimatePresence mode="wait">
                            <motion.div 
                                key={currentQ.id}
                                initial={{ opacity: 0, x: 20 }}
                                animate={{ opacity: 1, x: 0 }}
                                exit={{ opacity: 0, x: -20 }}
                                className="max-w-xl mx-auto pb-8"
                            >
                                {/* Passage Toggle */}
                                {hasPassage && (
                                    <div className="mb-6">
                                        <button 
                                            onClick={() => setShowPassage(!showPassage)}
                                            className="w-full flex items-center justify-between p-4 bg-white dark:bg-gray-800 text-blue-600 dark:text-blue-400 rounded-xl border border-blue-100 dark:border-gray-700 hover:bg-blue-50 dark:hover:bg-gray-700 transition-all shadow-sm"
                                        >
                                            <span className="font-bold flex items-center"><Icons.BookOpen className="w-5 h-5 mr-2" /> {showPassage ? "æœ¬æ–‡ã‚’é–‰ã˜ã‚‹" : "æœ¬æ–‡ã‚’èª­ã‚€"}</span>
                                            <Icons.ChevronRight className={`transform transition-transform duration-300 ${showPassage ? 'rotate-90' : ''}`} />
                                        </button>
                                        <AnimatePresence>
                                            {showPassage && (
                                                <motion.div
                                                    initial={{ height: 0, opacity: 0 }}
                                                    animate={{ height: 'auto', opacity: 1 }}
                                                    exit={{ height: 0, opacity: 0 }}
                                                    className="overflow-hidden"
                                                >
                                                    <div className="mt-2 p-5 bg-white dark:bg-gray-800 rounded-xl text-sm leading-relaxed text-gray-700 dark:text-gray-300 border border-gray-200 dark:border-gray-700 whitespace-pre-line shadow-inner">
                                                        {currentQ.passage}
                                                    </div>
                                                </motion.div>
                                            )}
                                        </AnimatePresence>
                                    </div>
                                )}

                                {/* Question */}
                                <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-6 leading-relaxed">
                                    {currentQ.q}
                                </h2>

                                {/* Options */}
                                <div className="space-y-3">
                                    {currentQ.o.map((option, idx) => {
                                        let optionClass = "bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:border-blue-500 dark:hover:border-blue-400";
                                        let icon = <span className="inline-block w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 text-center leading-8 text-xs mr-3 text-gray-500 dark:text-gray-300 group-hover:bg-blue-100 dark:group-hover:bg-blue-900 transition-colors">{String.fromCharCode(65 + idx)}</span>;

                                        if (selectedOption !== null) {
                                            if (idx === currentQ.a) {
                                                optionClass = "bg-green-50 dark:bg-green-900/20 border-green-500 text-green-700 dark:text-green-300 ring-1 ring-green-500";
                                                icon = <Icons.CheckCircle className="w-8 h-8 mr-3 text-green-500" />;
                                            } else if (idx === selectedOption) {
                                                optionClass = "bg-red-50 dark:bg-red-900/20 border-red-500 text-red-700 dark:text-red-300 ring-1 ring-red-500";
                                                icon = <Icons.XCircle className="w-8 h-8 mr-3 text-red-500" />;
                                            } else {
                                                optionClass = "bg-gray-50 dark:bg-gray-800/50 border-gray-100 dark:border-gray-800 opacity-60";
                                            }
                                        }

                                        return (
                                            <motion.button
                                                key={idx}
                                                onClick={() => handleOptionClick(idx)}
                                                disabled={selectedOption !== null}
                                                whileTap={{ scale: 0.99 }}
                                                className={`w-full p-4 text-left border-2 rounded-xl transition-all duration-200 flex items-center group shadow-sm ${optionClass}`}
                                            >
                                                {icon}
                                                <span className="font-medium flex-1">{option}</span>
                                            </motion.button>
                                        );
                                    })}
                                </div>

                                {/* Inline Feedback Section */}
                                <div ref={feedbackRef}>
                                    <AnimatePresence>
                                        {showFeedback && (
                                            <ExplanationBox 
                                                isCorrect={isCorrect}
                                                correctAnswer={displayCorrectAnswer}
                                                explanation={explanationText}
                                                onNext={handleNext}
                                            />
                                        )}
                                    </AnimatePresence>
                                </div>

                            </motion.div>
                        </AnimatePresence>
                    </div>
                </div>
            );
        };

        const ModeSelection = ({ onSelectMode, onBack }) => (
            <motion.div 
                initial={{ opacity: 0, x: 20 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -20 }}
                className="flex flex-col h-full justify-center space-y-6 px-4"
            >
                <button onClick={onBack} className="absolute top-4 left-4 p-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full z-20">
                    <Icons.ArrowLeft />
                </button>
                
                <h2 className="text-2xl font-bold text-center text-gray-800 dark:text-white mb-8">Select Mode</h2>
                
                <button 
                    onClick={() => onSelectMode('targetTest')}
                    className="p-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-lg text-white text-left relative overflow-hidden group hover:shadow-2xl hover:-translate-y-1 transition-all duration-300"
                >
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-bl-full -mr-8 -mt-8 group-hover:scale-110 transition-transform"></div>
                    <Icons.Trophy className="w-10 h-10 mb-4 text-indigo-200" />
                    <h3 className="text-2xl font-bold">TARGET TEST</h3>
                    <p className="text-indigo-100 mt-2">åŸºæœ¬å•é¡Œã‚’ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ã‚‡ã†ã€‚</p>
                </button>

                <button 
                    onClick={() => onSelectMode('reviewQuiz')}
                    className="p-8 bg-gradient-to-br from-teal-400 to-emerald-600 rounded-2xl shadow-lg text-white text-left relative overflow-hidden group hover:shadow-2xl hover:-translate-y-1 transition-all duration-300"
                >
                    <div className="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-bl-full -mr-8 -mt-8 group-hover:scale-110 transition-transform"></div>
                    <Icons.RotateCcw className="w-10 h-10 mb-4 text-teal-100" />
                    <h3 className="text-2xl font-bold">REVIEW QUIZ</h3>
                    <p className="text-teal-100 mt-2">å¾©ç¿’å•é¡Œã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã€‚</p>
                </button>
            </motion.div>
        );

        const ResultScreen = ({ score, total, onRestart, onHome }) => {
            const percentage = Math.round((score / total) * 100);
            
            return (
                <motion.div 
                    initial={{ opacity: 0, scale: 0.9 }}
                    animate={{ opacity: 1, scale: 1 }}
                    className="flex flex-col items-center justify-center h-full p-6 text-center"
                >
                    <div className="w-32 h-32 mb-6 rounded-full bg-gradient-to-tr from-yellow-400 to-orange-500 flex items-center justify-center shadow-lg animate-blob">
                        <Icons.Trophy className="w-16 h-16 text-white" />
                    </div>
                    
                    <h2 className="text-3xl font-bold text-gray-800 dark:text-white mb-2">Quiz Complete!</h2>
                    <p className="text-gray-500 dark:text-gray-400 mb-8">ä»Šå›ã®æˆç¸¾</p>
                    
                    <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">
                        {score}/{total}
                    </div>
                    <div className="text-sm font-medium text-gray-400 mb-12">æ­£ç­”ç‡: {percentage}%</div>
                    
                    <div className="flex gap-4 w-full max-w-sm">
                        <button 
                            onClick={onHome}
                            className="flex-1 py-3 px-6 rounded-xl bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-white font-semibold hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors flex items-center justify-center shadow-sm"
                        >
                            <Icons.Home className="w-4 h-4 mr-2" /> Home
                        </button>
                        <button 
                            onClick={onRestart}
                            className="flex-1 py-3 px-6 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/30 flex items-center justify-center"
                        >
                            <Icons.RotateCcw className="w-4 h-4 mr-2" /> Retry
                        </button>
                    </div>
                </motion.div>
            );
        };

        const AllMasteredScreen = ({ onHome }) => (
            <div className="flex flex-col items-center justify-center h-full p-6 text-center">
                <motion.div
                    initial={{ scale: 0 }}
                    animate={{ scale: 1 }}
                    transition={{ type: "spring", stiffness: 200, damping: 10 }}
                >
                    <Icons.CheckCircle className="w-24 h-24 text-green-500 mb-6" />
                </motion.div>
                <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">Awesome!</h2>
                <p className="text-gray-600 dark:text-gray-300 mb-8">
                    ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å•é¡Œã¯ã™ã¹ã¦ãƒã‚¹ã‚¿ãƒ¼ã—ã¾ã—ãŸï¼<br/>
                    æ¬¡ã®ãƒ¬ãƒƒã‚¹ãƒ³ã«é€²ã¿ã¾ã—ã‚‡ã†ã€‚
                </p>
                <button 
                    onClick={onHome}
                    className="py-3 px-8 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors shadow-lg"
                >
                    ãƒ¬ãƒƒã‚¹ãƒ³ä¸€è¦§ã¸æˆ»ã‚‹
                </button>
            </div>
        );

        function App() {
            const [currentScreen, setCurrentScreen] = useState('home'); 
            const [selectedLesson, setSelectedLesson] = useState(null);
            const [selectedMode, setSelectedMode] = useState(null);
            const [scoreData, setScoreData] = useState({ score: 0, total: 0 });
            
            // Persistent State
            const [masteredQuestions, setMasteredQuestions] = useState(() => {
                const saved = localStorage.getItem('english_master_progress_v2'); // New key for versioning
                return saved ? JSON.parse(saved) : [];
            });

            useEffect(() => {
                localStorage.setItem('english_master_progress_v2', JSON.stringify(masteredQuestions));
            }, [masteredQuestions]);

            const handleMasterQuestion = (questionId) => {
                if (!masteredQuestions.includes(questionId)) {
                    setMasteredQuestions(prev => [...prev, questionId]);
                }
            };

            const handleLessonSelect = (lesson) => {
                setSelectedLesson(lesson);
                setCurrentScreen('modeSelect');
            };

            const handleModeSelect = (mode) => {
                setSelectedMode(mode);
                setCurrentScreen('quiz');
            };

            const handleQuizComplete = (score, total) => {
                setScoreData({ score, total });
                setCurrentScreen('result');
            };

            const handleHome = () => {
                setCurrentScreen('home');
                setSelectedLesson(null);
                setSelectedMode(null);
            };

            const handleRetry = () => {
                setCurrentScreen('quiz');
            };

            // Filter questions
            const activeQuestions = useMemo(() => {
                if (!selectedLesson || !selectedMode) return [];
                const allQuestions = selectedLesson[selectedMode];
                return allQuestions.filter(q => !masteredQuestions.includes(q.id));
            }, [selectedLesson, selectedMode, masteredQuestions]);

            return (
                <div className="max-w-md mx-auto h-screen bg-white dark:bg-gray-900 shadow-2xl overflow-hidden flex flex-col relative border-x border-gray-100 dark:border-gray-800">
                    <div className="relative z-10 h-full">
                        <AnimatePresence mode="wait">
                            
                            {currentScreen === 'home' && (
                                <motion.div 
                                    key="home"
                                    initial={{ opacity: 0 }}
                                    animate={{ opacity: 1 }}
                                    exit={{ opacity: 0, x: -20 }}
                                    className="h-full flex flex-col"
                                >
                                    <div className="p-6 pt-12 pb-4 bg-white dark:bg-gray-900 z-10 sticky top-0">
                                        <h1 className="text-3xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">
                                            English Master
                                        </h1>
                                        <p className="text-gray-500 dark:text-gray-400 mt-1">Basic English II</p>
                                    </div>
                                    
                                    <div className="flex-1 overflow-y-auto px-6 pb-6 space-y-4 scrollbar-hide">
                                        {quizData.map((lesson, idx) => {
                                            const allIds = [...(lesson.targetTest || []), ...(lesson.reviewQuiz || [])].map(q => q.id);
                                            const masteredInLesson = allIds.filter(id => masteredQuestions.includes(id)).length;
                                            
                                            return (
                                                <LessonCard 
                                                    key={lesson.id} 
                                                    lesson={lesson} 
                                                    index={idx} 
                                                    onSelect={handleLessonSelect} 
                                                    masteredCount={masteredInLesson}
                                                    totalCount={allIds.length}
                                                />
                                            );
                                        })}
                                        <div className="h-12"></div>
                                    </div>
                                </motion.div>
                            )}

                            {currentScreen === 'modeSelect' && (
                                <ModeSelection 
                                    key="modeSelect"
                                    onSelectMode={handleModeSelect} 
                                    onBack={handleHome} 
                                />
                            )}

                            {currentScreen === 'quiz' && selectedLesson && selectedMode && (
                                activeQuestions.length > 0 ? (
                                    <QuizGame 
                                        key="quiz"
                                        questions={activeQuestions} 
                                        lessonAdvice={selectedLesson.advice}
                                        onComplete={handleQuizComplete}
                                        onExit={handleHome}
                                        onMasterQuestion={handleMasterQuestion}
                                    />
                                ) : (
                                    <AllMasteredScreen key="all-mastered" onHome={handleHome} />
                                )
                            )}

                            {currentScreen === 'result' && (
                                <ResultScreen 
                                    key="result"
                                    score={scoreData.score}
                                    total={scoreData.total}
                                    onRestart={handleRetry}
                                    onHome={handleHome}
                                />
                            )}

                        </AnimatePresence>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
