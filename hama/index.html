<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HAMA-STYLE OCEAN v8</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Shippori+Mincho:wght@500;700;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <style>
        :root {
            --color-navy: #002B49;
            --color-blue: #00689D;
            --color-accent: #C5A059;
            --color-red: #E60012;
            --color-bg: #F0F4F8;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--color-bg);
            color: #2c3e50;
            user-select: none;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .font-serif { font-family: 'Shippori Mincho', serif; }

        /* Scrollbar */
        .custom-scroll { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: rgba(0, 43, 73, 0.2); border-radius: 10px; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .btn-press { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-press:active { transform: scale(0.95); }

        /* Animations */
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes wave { 
            0% { transform: translateX(0) translateZ(0) scaleY(1); }
            50% { transform: translateX(-25%) translateZ(0) scaleY(0.8); }
            100% { transform: translateX(-50%) translateZ(0) scaleY(1); }
        }
        @keyframes cookingPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        @keyframes flashBorder { 0%, 100% { border-color: #C5A059; } 50% { border-color: #E60012; } }
        @keyframes kenburns { 0% { transform: scale(1); } 100% { transform: scale(1.05); } }
        /* 既存の cookingPulse を強化 */
        @keyframes cookingBgPulse {
            0% { background-color: #fff; border-color: #fed7aa; }
            50% { background-color: #fff7ed; border-color: #E60012; box-shadow: 0 0 10px rgba(230, 0, 18, 0.3); }
            100% { background-color: #fff; border-color: #fed7aa; }
        }
        .animate-cooking-card {
            animation: cookingBgPulse 2s infinite ease-in-out;
        }

        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-slide { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-cooking { animation: cookingPulse 1.5s infinite ease-in-out; }
        .animate-border { animation: flashBorder 2s infinite; }
        
        .bg-wave-pattern {
            background-color: #002B49;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='20' viewBox='0 0 100 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M21.184 20c.357-.13.72-.264 1.088-.402l1.768-.661C33.64 15.347 39.647 14 50 14c10.271 0 15.362 1.222 24.629 4.928.955.383 1.869.74 2.75 1.072h6.225c-2.51-.73-5.139-1.691-8.233-2.928C65.888 13.278 60.562 12 50 12c-10.626 0-16.855 1.397-26.66 5.063l-1.767.662c-2.475.923-4.66 1.674-6.724 2.275h6.335zm0-20C13.258 2.892 8.077 4 0 4V2c5.744 0 9.951-.574 14.85-2h6.334zM77.38 0C85.239 2.966 90.502 4 100 4V2c-6.842 0-11.386-.542-16.396-2h-6.225zM0 14c8.44 0 13.718-1.21 22.272-4.402l1.768-.661C33.64 5.347 39.647 4 50 4c10.271 0 15.362 1.222 24.629 4.928C84.112 12.722 89.438 14 100 14v-2c-10.271 0-15.362-1.222-24.629-4.928C65.888 3.278 60.562 2 50 2 39.374 2 33.145 3.397 23.34 7.063l-1.767.662C13.223 10.84 8.163 12 0 12v2z' fill='%2300689D' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .menu-grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }
        @media (min-width: 768px) {
            .menu-grid-layout { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; }
        }

        /* Screensaver */
        #slideshow-container { position: absolute; inset: 0; width: 100%; height: 100%; }
        /* スクリーンセーバー用画像スタイル */
        .slide-image {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; /* ここを cover にすることで横幅いっぱい・隙間なしになります */
            object-position: center;
            opacity: 0;
            transition: opacity 1.5s;
            background: #000;
        }
        .slide-image.active { opacity: 1; }

        /* Images */
        .img-container {
            position: relative;
            background-color: #ffffff;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .real-image {
            max-width: 100%; max-height: 100%;
            width: auto; height: auto;
            object-fit: contain;
            opacity: 0; transition: opacity 0.3s;
        }
        .real-image.loaded { opacity: 1; }
        .menu-item-hidden { display: none !important; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col bg-[#F0F4F8] overflow-hidden">

    <!-- 1. スクリーンセーバー (修正版: 絶対配置) -->
    <div id="view-screensaver" class="hidden fixed inset-0 z-[150] bg-white cursor-pointer flex flex-col h-screen w-screen" onclick="app.screensaver.stop()">
        <div class="flex-1 relative w-full overflow-hidden bg-black">
             <div id="slideshow-container" class="absolute inset-0 w-full h-full"></div>
        </div>
        
        <div class="h-auto py-8 bg-white flex items-center justify-center shrink-0 z-20 relative border-t-8 border-[#002B49]">
            <div class="flex flex-col items-center animate-bounce">
                <p class="text-[#002B49] text-3xl md:text-4xl font-black tracking-widest flex items-center gap-4">
                    <i class="fa-regular fa-hand-pointer"></i>
                    <span data-t="screensaver_text">画面をタップして注文へ</span>
                </p>
                <p class="text-[#C5A059] text-base font-bold mt-2 tracking-[0.5em]">TOUCH SCREEN</p>
            </div>
        </div>
    </div>

    <!-- 2. 待機画面 -->
    <div id="view-standby" class="absolute inset-0 z-50 bg-wave-pattern flex flex-col items-center justify-center text-white">
        <div class="absolute top-6 left-6 z-[60]">
            <img src="https://www.hama-sushi.co.jp/assets/common/img/logo_hamasushi.png" alt="logo" class="w-32 md:w-48 filter drop-shadow-md">
        </div>
        <button onclick="app.auth.open()" class="absolute top-6 right-6 text-white/10 hover:text-white p-4 z-[60] transition-colors"><i class="fa-solid fa-lock text-2xl"></i></button>

        <div class="relative w-full max-w-4xl mx-auto text-center px-4 flex flex-col items-center h-full justify-center">
            <div class="flex flex-col items-center animate-pop">
                <p class="text-3xl md:text-5xl font-serif font-bold text-white mb-10 tracking-widest" style="text-shadow: 0 4px 10px rgba(0,0,0,0.5);" data-t="welcome">いらっしゃいませ</p>
                
                <div class="mb-12 w-64 h-64 md:w-80 md:h-80 rounded-full border-[6px] border-white/20 bg-white/10 backdrop-blur-md flex flex-col items-center justify-center shadow-[0_0_50px_rgba(255,255,255,0.15)] animate-pulse-slow relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/5 to-transparent"></div>
                    <span class="text-sm md:text-lg text-[#C5A059] font-bold mb-0 tracking-[0.5em] uppercase relative z-10" data-t="table">TABLE</span>
                    <span class="text-8xl md:text-9xl font-black text-white leading-none font-sans filter drop-shadow-lg relative z-10 -mt-2">12</span>
                </div>

                <button onclick="app.customer.start()" class="group relative bg-white text-[#002B49] text-2xl md:text-4xl font-black py-6 px-24 rounded-full shadow-[0_0_50px_rgba(255,255,255,0.3)] hover:scale-105 transition-transform flex items-center gap-6 btn-press overflow-hidden">
                    <span class="relative z-10 flex items-center gap-4">
                        <span data-t="start">注文をはじめる</span>
                        <i class="fa-solid fa-circle-chevron-right text-[#E60012]"></i>
                    </span>
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/50 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000"></div>
                </button>
            </div>
        </div>
        <div class="absolute bottom-0 left-0 w-full h-32 overflow-hidden opacity-30 pointer-events-none">
             <div class="w-[200%] h-full bg-[url('https://www.hama-sushi.co.jp/assets/common/img/wave.svg')] bg-repeat-x bg-bottom animate-[wave_10s_linear_infinite]"></div>
        </div>
    </div>

    <!-- 3. 客席注文画面 -->
    <div id="view-customer" class="hidden h-full w-full flex-row bg-[#F0F4F8] overflow-hidden">
        
        <!-- 左側：メニューエリア -->
        <div class="flex-1 flex flex-col h-full min-w-0 relative z-10">
            <header class="h-16 md:h-20 bg-white border-b border-gray-100 flex items-center px-2 shrink-0 shadow-sm z-20">
                <nav class="flex-1 flex justify-start gap-2 overflow-x-auto hide-scrollbar px-2 h-full items-center w-full" id="category-nav"></nav>
            </header>
            <main class="flex-1 overflow-y-auto p-4 md:p-6 custom-scroll bg-[#F0F4F8] relative">
                <div class="absolute top-0 left-0 w-full h-64 bg-gradient-to-b from-[#E1F5FE] to-transparent -z-10 pointer-events-none"></div>
                <div id="menu-grid" class="menu-grid-layout pb-24 animate-slide"></div>
            </main>
        </div>

        <!-- 右側：サイドバー -->
        <aside class="w-[300px] md:w-[360px] bg-white flex flex-col h-full shrink-0 border-l border-gray-200 z-20 shadow-2xl">
            <div class="h-16 md:h-20 bg-[#002B49] text-white flex items-center justify-between px-3 md:px-5 shrink-0 relative overflow-hidden">
                <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/seigaiha.png')] opacity-10"></div>
                
                <div class="flex flex-col relative z-10 cursor-pointer" onclick="app.ui.switchView('standby')">
                    <span class="text-[10px] text-[#C5A059] font-bold tracking-widest" data-t="table">TABLE</span>
                    <span class="text-3xl font-black leading-none font-sans">12</span>
                </div>

                <div class="flex items-center gap-2 relative z-10">
                    <!-- 言語切り替え -->
                    <select onchange="app.ui.setLang(this.value)" class="bg-white/10 border border-white/20 text-white text-xs rounded px-1 py-2 focus:outline-none">
                        <option value="ja">日本語</option>
                        <option value="en">English</option>
                    </select>
                    <!-- 呼出 -->
                    <button onclick="app.ui.openCallModal()" id="btn-call" class="bg-white/10 border border-white/20 hover:bg-white/20 text-white px-3 py-2 rounded-lg font-bold flex items-center gap-2 btn-press transition-colors text-sm whitespace-nowrap">
                        <i class="fa-solid fa-bell"></i> <span data-t="call">呼出</span>
                    </button>
                </div>
            </div>

            <div class="bg-gray-50 px-5 py-3 border-b border-gray-100 flex justify-between items-center shrink-0">
                <span class="font-bold text-[#002B49] flex items-center gap-2 text-sm">
                    <i class="fa-solid fa-clock-rotate-left text-[#C5A059]"></i> <span data-t="history">注文履歴</span>
                </span>
            </div>

            <div class="flex-1 overflow-y-auto p-4 custom-scroll bg-white" id="sidebar-content">
                <div id="view-history-list" class="space-y-4"></div>
            </div>

            <div class="bg-gray-50 border-t border-gray-200 p-5 shrink-0 z-30">
                <div class="flex justify-between items-end mb-4 px-1">
                    <span class="text-gray-500 font-bold text-xs tracking-wider" data-t="total">合計金額 (税込)</span>
                    <span class="text-3xl md:text-4xl font-black text-[#002B49] tracking-tight font-sans">¥<span id="cart-total">0</span></span>
                </div>
                <button onclick="app.ui.showCheck()" class="w-full py-4 bg-gradient-to-r from-[#C5A059] to-[#D4AF37] text-white rounded-xl font-black text-lg shadow-lg flex items-center justify-center gap-3 btn-press hover:shadow-xl hover:brightness-110 transition-all">
                    <i class="fa-solid fa-calculator"></i> <span data-t="checkout">お会計へ進む</span>
                </button>
            </div>
        </aside>
    </div>

    <!-- 4. 詳細画面 (画像拡大 & レイアウト) -->
    <div id="modal-detail" class="fixed inset-0 z-[90] hidden items-center justify-center bg-[#002B49]/80 backdrop-blur-sm p-4 animate-fade">
        <div class="bg-white rounded-[2.5rem] w-full max-w-5xl h-auto md:h-[600px] overflow-hidden shadow-2xl animate-pop relative flex flex-col md:flex-row">
            
            <div class="w-full md:w-[50%] h-64 md:h-full bg-white relative shrink-0 img-container p-4 flex items-center justify-center">
                <img id="detail-img" src="" class="real-image w-full h-full object-contain drop-shadow-2xl" onload="this.classList.add('loaded')">
            </div>

            <div class="w-full md:w-[50%] px-8 pb-8 pt-12 flex flex-col bg-gray-50 h-full relative border-l border-gray-100">
                
                <div class="mb-auto">
                    <div class="mb-4">
                        <span id="detail-cat-badge" class="inline-block px-4 py-1.5 bg-[#C5A059] text-white text-sm font-bold rounded tracking-wider shadow-sm">CAT</span>
                    </div>

                    <h3 id="detail-name" class="text-3xl md:text-4xl font-black text-[#002B49] font-serif tracking-wide leading-tight mb-4">Item Name</h3>
                    
                    <p id="detail-warning" class="text-[#E60012] font-bold text-sm hidden bg-red-50 inline-block px-3 py-2 rounded-lg border border-red-100 mb-2">
                        <i class="fa-solid fa-clock"></i> <span data-t="fried_warning">調理にお時間をいただきます</span>
                    </p>
                </div>

                <div class="flex flex-col gap-5 mb-8 p-6 bg-white rounded-3xl shadow-[0_4px_20px_rgba(0,0,0,0.05)] border border-gray-100">
                    <div class="flex justify-between items-center border-b border-gray-100 pb-4 mb-1">
                        <span class="text-gray-400 font-bold text-sm tracking-widest" data-t="quantity">数量</span>
                        <div class="flex items-center gap-5">
                            <button onclick="app.order.adjustQty(-1)" class="w-12 h-12 rounded-full bg-gray-100 text-[#002B49] text-xl font-bold flex items-center justify-center hover:bg-gray-200 btn-press border border-gray-200 transition-colors"><i class="fa-solid fa-minus"></i></button>
                            <div class="text-4xl font-sans font-black w-16 text-center text-[#002B49]" id="detail-qty">1</div>
                            <button onclick="app.order.adjustQty(1)" class="w-12 h-12 rounded-full bg-[#002B49] text-white text-xl font-bold flex items-center justify-center hover:bg-[#003865] btn-press shadow-md transition-colors"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div class="flex justify-between items-baseline">
                        <span class="text-gray-400 font-bold text-sm tracking-widest" data-t="price">価格</span>
                        <div class="flex items-baseline gap-1">
                            <span class="text-xl text-[#E60012] font-bold">¥</span>
                            <span id="detail-price" class="text-6xl font-black text-[#E60012] font-sans tracking-tight">0</span>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 shrink-0">
                    <button onclick="app.ui.closeModal('modal-detail')" class="flex-1 py-5 bg-white border-2 border-gray-200 text-gray-500 rounded-2xl font-bold text-xl hover:bg-gray-50 hover:border-gray-300 btn-press transition-all" data-t="cancel">もどる</button>
                    <button onclick="app.order.confirm()" class="flex-[2] py-5 bg-gradient-to-r from-[#E60012] to-[#ff4d4d] text-white rounded-2xl font-black text-xl shadow-lg flex items-center justify-center gap-3 btn-press hover:shadow-xl hover:brightness-110 transition-all">
                        <span data-t="order">注文する</span> <i class="fa-solid fa-utensils"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- 5. 商品到着全画面 -->
    <div id="modal-delivery" class="fixed inset-0 z-[250] hidden bg-[#002B49] flex-col items-center justify-center animate-fade overflow-hidden">
        <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/seigaiha.png')]"></div>
        <div class="absolute -top-20 -left-20 w-96 h-96 bg-blue-500/20 rounded-full blur-3xl"></div>
        <div class="relative z-10 w-full max-w-6xl px-4 flex flex-col h-full py-8">
            <div class="text-center mb-6 shrink-0">
                <div class="inline-block animate-bounce mb-2"><i class="fa-solid fa-bell text-5xl md:text-6xl text-[#C5A059]"></i></div>
                <h2 class="text-4xl md:text-6xl font-black text-white font-serif mb-2 drop-shadow-md" data-t="arriving">商品が到着します</h2>
                <p class="text-white/80 text-xl font-bold tracking-widest" data-t="take">レーンよりお取りください</p>
            </div>
            <div class="flex-1 overflow-y-auto custom-scroll mb-6 bg-white/5 rounded-3xl border border-white/10 p-4">
                <div id="delivery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            </div>
            <button onclick="app.ui.closeDelivery()" class="w-full max-w-2xl mx-auto py-6 bg-white text-[#002B49] text-3xl font-black rounded-full shadow-[0_10px_40px_rgba(0,0,0,0.5)] hover:scale-105 transition-transform flex items-center justify-center gap-4 shrink-0 border-4 border-[#C5A059] animate-border">
                <i class="fa-solid fa-check-circle"></i> <span data-t="received">商品を受け取りました</span>
            </button>
        </div>
    </div>

    <!-- 6. Kitchen -->
    <div id="view-kitchen" class="hidden flex-col h-full bg-[#1a202c] text-white">
        <header class="h-20 bg-[#002B49] flex items-center justify-between px-8 shadow-md shrink-0 z-50">
            <div class="flex items-center gap-6">
                <h2 class="text-2xl font-bold text-[#C5A059] tracking-widest flex items-center gap-3"><i class="fa-solid fa-fire-burner"></i> KITCHEN</h2>
                <div class="bg-black/30 px-4 py-2 rounded-lg border border-white/10 flex items-center gap-4">
                    <span id="kitchen-id-display" class="font-bold text-xl tracking-widest text-white leading-none">----</span>
                    <span id="kitchen-connection-status" class="font-bold text-xl text-white leading-none"><i class="fa-solid fa-circle text-gray-500 text-sm"></i> Offline</span>
                </div>
            </div>
            <div class="flex items-center gap-6"><div class="text-3xl font-mono font-bold text-gray-400" id="kitchen-clock">00:00</div></div>
        </header>
        <div id="kitchen-alert-overlay" class="absolute inset-0 z-[150] hidden flex-col items-center justify-center bg-red-900/95 animate-fade pointer-events-auto">
            <div class="animate-bounce mb-8"><i class="fa-solid fa-bell text-9xl text-white"></i></div>
            <h1 class="text-8xl font-black text-white tracking-widest mb-12">12番 呼出</h1>
            <button onclick="app.kitchen.resolveCall()" class="px-16 py-8 bg-white text-red-900 rounded-2xl font-black text-4xl shadow-2xl hover:scale-105 transition-transform flex items-center gap-4"><i class="fa-solid fa-check-double"></i> 対応完了</button>
        </div>
        <main class="flex-1 p-6 overflow-y-auto relative bg-[#1a202c]"><div id="kitchen-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div></main>
    </div>

    <!-- Modals -->
    <div id="modal-check" class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fade">
         <div class="bg-white rounded-3xl w-full max-w-lg shadow-2xl overflow-hidden animate-pop">
            <div class="bg-gradient-to-r from-[#C5A059] to-[#D4AF37] p-6 text-center"><h3 class="text-white font-black text-2xl font-serif" data-t="payment_confirm">お会計の確認</h3></div>
            <div class="p-10 text-center">
                <p class="text-gray-500 text-lg mb-2 font-bold tracking-widest" data-t="payment_amount">お支払い総額</p>
                <p class="text-6xl font-black text-[#002B49] mb-8 tracking-tight font-sans">¥<span id="check-total">0</span></p>
                <div class="flex justify-center items-center gap-2 mb-10 text-gray-500"><span data-t="count">合計点数</span>: <span id="check-count" class="font-bold text-xl text-gray-800">0</span> <span data-t="items">点</span></div>
                <button onclick="app.customer.finishEat()" class="w-full py-5 bg-[#E60012] text-white rounded-xl font-bold text-2xl shadow-lg hover:bg-[#ff1a1a] btn-press mb-4" data-t="finish">会計を確定して退店</button>
                <button onclick="app.ui.closeModal('modal-check')" class="w-full py-4 bg-gray-100 text-gray-600 rounded-xl font-bold text-lg hover:bg-gray-200" data-t="continue">まだ注文する</button>
            </div>
        </div>
    </div>
    <div id="modal-call" class="fixed inset-0 z-[80] hidden items-center justify-center bg-black/70 backdrop-blur-sm p-4 animate-fade">
         <div class="bg-white rounded-3xl w-full max-w-sm shadow-2xl overflow-hidden animate-pop p-8 text-center border-t-8 border-[#002B49]">
            <div class="w-20 h-20 bg-[#F0F4F8] rounded-full flex items-center justify-center mx-auto mb-6 text-[#002B49]"><i class="fa-solid fa-bell text-4xl"></i></div>
            <h3 class="text-xl font-black text-[#002B49] mb-8 font-serif" data-t="call_confirm">店員をお呼びしますか？</h3>
            <div class="flex gap-4">
                <button onclick="app.ui.closeModal('modal-call')" class="flex-1 py-3 border border-gray-300 rounded-lg text-gray-600 font-bold hover:bg-gray-50" data-t="no">いいえ</button>
                <button onclick="app.order.callStaff()" class="flex-1 py-3 bg-[#002B49] text-white rounded-lg font-bold shadow hover:bg-[#003865]" data-t="yes_call">呼び出す</button>
            </div>
        </div>
    </div>
    
    <!-- Auth -->
    <div id="modal-auth" class="fixed inset-0 z-[200] hidden items-center justify-center bg-[#002B49]/90 backdrop-blur-sm p-4">
        <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div id="auth-screen" class="w-full p-6 text-center">
                <h3 class="text-[#002B49] font-bold text-xl mb-4">STAFF AUTH (9999)</h3>
                <div class="flex justify-center gap-2 mb-4"><div class="w-10 h-10 bg-gray-200 rounded" id="pin-1"></div><div class="w-10 h-10 bg-gray-200 rounded" id="pin-2"></div><div class="w-10 h-10 bg-gray-200 rounded" id="pin-3"></div><div class="w-10 h-10 bg-gray-200 rounded" id="pin-4"></div></div>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="app.auth.type(1)" class="h-12 bg-gray-100 rounded font-bold">1</button><button onclick="app.auth.type(2)" class="h-12 bg-gray-100 rounded font-bold">2</button><button onclick="app.auth.type(3)" class="h-12 bg-gray-100 rounded font-bold">3</button>
                    <button onclick="app.auth.type(4)" class="h-12 bg-gray-100 rounded font-bold">4</button><button onclick="app.auth.type(5)" class="h-12 bg-gray-100 rounded font-bold">5</button><button onclick="app.auth.type(6)" class="h-12 bg-gray-100 rounded font-bold">6</button>
                    <button onclick="app.auth.type(7)" class="h-12 bg-gray-100 rounded font-bold">7</button><button onclick="app.auth.type(8)" class="h-12 bg-gray-100 rounded font-bold">8</button><button onclick="app.auth.type(9)" class="h-12 bg-gray-100 rounded font-bold">9</button>
                    <button onclick="app.auth.clear()" class="h-12 bg-red-100 text-red-600 rounded font-bold">C</button><button onclick="app.auth.type(0)" class="h-12 bg-gray-100 rounded font-bold">0</button><button onclick="app.auth.close()" class="h-12 bg-gray-200 rounded font-bold">Back</button>
                </div>
            </div>
            <div id="mode-select" class="hidden w-full p-6 flex-col gap-4">
                <button onclick="app.kitchen.startHost()" class="w-full py-4 bg-[#002B49] text-white rounded-xl font-bold">Kitchen Mode</button>
                <button onclick="app.p2p.showConnectUI()" class="w-full py-4 border-2 border-[#002B49] text-[#002B49] rounded-xl font-bold">Client Connect</button>
            </div>
            <div id="client-connect" class="hidden w-full p-6 text-center">
                <input type="tel" id="target-id-input" class="w-full border-2 p-3 text-2xl text-center rounded mb-4" placeholder="ID">
                <button onclick="app.p2p.connectToHost()" class="w-full py-3 bg-[#002B49] text-white rounded font-bold">Connect</button>
                <p id="connect-msg" class="mt-2 text-sm font-bold"></p>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        const APP_PREFIX = "hama-ultimate-v8-"; 
        const IMG_BASE = "https://www.hama-sushi.co.jp/assets/menu/img";
        
        // --- TRANSLATIONS ---
        const TRANSLATIONS = {
            ja: {
                welcome: "いらっしゃいませ",
                table: "TABLE NO.",
                start: "注文をはじめる",
                history: "注文履歴",
                call: "呼出",
                calling: "呼出中",
                total: "合計金額 (税込)",
                checkout: "お会計へ進む",
                cancel: "キャンセル",
                order: "注文する",
                quantity: "数量",
                price: "価格(税込)",
                cooking: "調理中",
                served: "提供済",
                arriving: "商品が到着します",
                take: "レーンよりお取りください",
                received: "商品を受け取りました",
                payment_confirm: "お会計の確認",
                payment_amount: "お支払い総額",
                count: "合計点数",
                items: "点",
                finish: "会計を確定して退店",
                continue: "まだ注文する",
                call_confirm: "店員をお呼びしますか？",
                no: "いいえ",
                yes_call: "呼び出す",
                fried_warning: "ご注文を受けてから調理するためお時間をいただきます",
                screensaver_text: "画面をタップして注文へ"
            },
            en: {
                welcome: "Welcome",
                table: "TABLE NO.",
                start: "Start Ordering",
                history: "Order History",
                call: "Call Staff",
                calling: "Calling...",
                total: "Total (Tax Inc.)",
                checkout: "Checkout",
                cancel: "Cancel",
                order: "Order",
                quantity: "Qty",
                price: "Price (Tax Inc.)",
                cooking: "Cooking",
                served: "Served",
                arriving: "Your Order is Arriving",
                take: "Please take from the lane",
                received: "Received",
                payment_confirm: "Payment Confirmation",
                payment_amount: "Total Amount",
                count: "Total Items",
                items: "items",
                finish: "Confirm & Pay",
                continue: "Continue Ordering",
                call_confirm: "Call Staff?",
                no: "No",
                yes_call: "Yes",
                fried_warning: "This item is cooked to order and may take some time.",
                screensaver_text: "Tap screen to order"
            }
        };

        const CATEGORIES = [
            { id: 'limited', name: 'おすすめ', nameEn: 'Recommended', icon: 'fa-star' },
            { id: 'nigiri', name: 'にぎり', nameEn: 'Nigiri', icon: 'fa-fish' },
            { id: 'gunkan', name: '軍艦', nameEn: 'Gunkan', icon: 'fa-dharmachakra' },
            { id: 'side', name: 'サイド', nameEn: 'Side Dish', icon: 'fa-bowl-food' },
            { id: 'dessert', name: 'デザート', nameEn: 'Dessert', icon: 'fa-ice-cream' },
            { id: 'drink', name: 'ドリンク', nameEn: 'Drink', icon: 'fa-beer-mug-empty' },
        ];

        const MENU_DB = [
            { id: 101, cat: 'limited', name: '大とろ', nameEn: 'Fatty Tuna', price: 319, img: `${IMG_BASE}/nigiri/pho_ootoro.png` },
            { id: 102, cat: 'limited', name: '特大ぼたん海老', nameEn: 'Large Botan Shrimp', price: 319, img: `${IMG_BASE}/nigiri/pho_botanebi.png` },
            { id: 103, cat: 'limited', name: '生うに包み', nameEn: 'Sea Urchin Wrap', price: 319, img: `${IMG_BASE}/gunkan/pho_namauni.png` },
            { id: 104, cat: 'limited', name: 'あわび', nameEn: 'Abalone', price: 165, img: `${IMG_BASE}/nigiri/pho_awabi.png` },
            { id: 105, cat: 'limited', name: '一本穴子', nameEn: 'Whole Conger Eel', price: 528, img: `${IMG_BASE}/nigiri/pho_ni_anago.png` },
            { id: 106, cat: 'limited', name: '特製辛味噌担々麺', nameEn: 'Spicy Miso Ramen', price: 506, img: `${IMG_BASE}/fair/tokusei_karamiso_tantanmen.png` },
            { id: 107, cat: 'limited', name: '厳選まぐろ中とろ', nameEn: 'Medium Fatty Tuna', price: 165, img: `${IMG_BASE}/fair/gensen_maguro_chutoro.png` },
            { id: 108, cat: 'limited', name: '北海道産赤イカのウニ和えつつみ', nameEn: 'Squid with Urchin', price: 110, img: `${IMG_BASE}/fair/hokkaidousan_akaika_no_uniae_tsutsumi.png` },
            { id: 605, cat: 'limited', name: 'ストロベリーパフェ', nameEn: 'Strawberry Parfait', price: 418, img: `${IMG_BASE}/fair/berry_cute_na_strawberry_parfait_simple.png` },
            { id: 201, cat: 'nigiri', name: 'まぐろ', nameEn: 'Tuna', price: 110, img: `${IMG_BASE}/nigiri/pho_maguro.png` },
            { id: 202, cat: 'nigiri', name: '特製漬けまぐろ', nameEn: 'Marinated Tuna', price: 110, img: `${IMG_BASE}/nigiri/pho_dukemaguro.png` },
            { id: 203, cat: 'nigiri', name: 'サーモン', nameEn: 'Salmon', price: 110, img: `${IMG_BASE}/nigiri/pho_salmon.png` },
            { id: 204, cat: 'nigiri', name: '大とろサーモン', nameEn: 'Fatty Salmon', price: 110, img: `${IMG_BASE}/nigiri/pho_otoro_salmon.png` },
            { id: 205, cat: 'nigiri', name: 'サーモンレアステーキ', nameEn: 'Seared Salmon', price: 110, img: `${IMG_BASE}/nigiri/pho_z_toro_salmon_reasteak.png` },
            { id: 206, cat: 'nigiri', name: '活〆はまち', nameEn: 'Young Yellowtail', price: 132, img: `${IMG_BASE}/nigiri/pho_hamachi.png` },
            { id: 207, cat: 'nigiri', name: '真いか', nameEn: 'Squid', price: 110, img: `${IMG_BASE}/nigiri/pho_maika.png` },
            { id: 208, cat: 'nigiri', name: 'えび', nameEn: 'Shrimp', price: 110, img: `${IMG_BASE}/nigiri/pho_ebi.png` },
            { id: 209, cat: 'nigiri', name: '生えび', nameEn: 'Raw Shrimp', price: 110, img: `${IMG_BASE}/nigiri/pho_namaebi.png` },
            { id: 210, cat: 'nigiri', name: 'つぶ貝', nameEn: 'Whelk', price: 165, img: `${IMG_BASE}/nigiri/pho_tsubugai.png` },
            { id: 211, cat: 'nigiri', name: 'ほたて', nameEn: 'Scallop', price: 165, img: `${IMG_BASE}/nigiri/pho_hotate.png` },
            { id: 212, cat: 'nigiri', name: '旨だし卵', nameEn: 'Egg Omelet', price: 110, img: `${IMG_BASE}/nigiri/pho_umadashitamago.png` },
            { id: 213, cat: 'nigiri', name: '牛カルビ', nameEn: 'Beef Kalbi', price: 165, img: `${IMG_BASE}/nigiri/pho_gyukarubi.png` },
            { id: 301, cat: 'gunkan', name: 'いくら', nameEn: 'Salmon Roe', price: 165, img: `${IMG_BASE}/gunkan/pho_ikura.png` },
            { id: 302, cat: 'gunkan', name: 'まぐろたたき', nameEn: 'Minced Tuna', price: 110, img: `${IMG_BASE}/gunkan/pho_negitoro.png` },
            { id: 303, cat: 'gunkan', name: 'コーン', nameEn: 'Corn Mayo', price: 110, img: `${IMG_BASE}/gunkan/pho_corn.png` },
            { id: 304, cat: 'gunkan', name: 'シーフード', nameEn: 'Seafood Salad', price: 110, img: `${IMG_BASE}/gunkan/pho_seafood.png` },
            { id: 305, cat: 'gunkan', name: 'ツナサラダ', nameEn: 'Tuna Salad', price: 110, img: `${IMG_BASE}/gunkan/pho_tuna.png` },
            { id: 306, cat: 'gunkan', name: '納豆', nameEn: 'Natto', price: 110, img: `${IMG_BASE}/gunkan/pho_natto.png` },
            { id: 401, cat: 'side', name: '茶碗蒸し', nameEn: 'Steamed Egg Custard', price: 198, img: `${IMG_BASE}/side/pho_chawanmushi.png` },
            { id: 402, cat: 'side', name: 'あさり味噌汁', nameEn: 'Clam Miso Soup', price: 165, img: `${IMG_BASE}/side/pho_asarimiso.png` },
            { id: 403, cat: 'side', name: 'カリカリポテト', nameEn: 'Crispy Fries', price: 176, img: `${IMG_BASE}/side/pho_karikari_potato.png` },
            { id: 404, cat: 'side', name: 'から揚げ', nameEn: 'Fried Chicken', price: 176, img: `${IMG_BASE}/side/pho_karaage.png` },
            { id: 405, cat: 'side', name: '旨だしたこ焼き', nameEn: 'Takoyaki', price: 220, img: `${IMG_BASE}/side/pho_umadasitakoyaki.png` },
            { id: 406, cat: 'side', name: '醤油ラーメン', nameEn: 'Soy Ramen', price: 385, img: `${IMG_BASE}/side/syoyu_ramen.png` },
            { id: 407, cat: 'side', name: '厚焼き卵', nameEn: 'Thick Omelet', price: 110, img: `${IMG_BASE}/side/pho_atsuyaki_tamago.png` },
            { id: 601, cat: 'dessert', name: '大学いも', nameEn: 'Candied Sweet Potato', price: 176, img: `${IMG_BASE}/dessert/pho_daigakuimo.png` },
            { id: 602, cat: 'dessert', name: '北海道ミルクレープ', nameEn: 'Milk Crepe', price: 220, img: `${IMG_BASE}/dessert/pho_mirukurepu.png` },
            { id: 603, cat: 'dessert', name: 'チョコレートケーキ', nameEn: 'Chocolate Cake', price: 220, img: `${IMG_BASE}/dessert/pho_choco_cake.png` },
            { id: 604, cat: 'dessert', name: '三色だんご', nameEn: 'Dango', price: 110, img: `${IMG_BASE}/dessert/pho_dango.png` },
            { id: 605, cat: 'dessert', name: 'コーヒーゼリー', nameEn: 'Coffee Jelly', price: 176, img: `${IMG_BASE}/dessert/pho_coffee_jelly_icecream.png` },
            { id: 606, cat: 'dessert', name: 'はまアイス(バニラ)', nameEn: 'Vanilla Ice Cream', price: 110, img: `${IMG_BASE}/dessert/pho_hama_ice_vanilla.png` },
            { id: 501, cat: 'drink', name: '生ビール中', nameEn: 'Draft Beer (M)', price: 528, img: `${IMG_BASE}/dessert/pho_beer_mug.png` },
            { id: 502, cat: 'drink', name: 'ペプシコーラ', nameEn: 'Pepsi Cola', price: 165, img: `${IMG_BASE}/dessert/pho_pepsi.png` },
            { id: 503, cat: 'drink', name: 'オレンジ', nameEn: 'Orange Juice', price: 165, img: `${IMG_BASE}/dessert/pho_orange.png` },
            { id: 504, cat: 'drink', name: 'コーラフロート', nameEn: 'Cola Float', price: 290, img: `${IMG_BASE}/dessert/pho_cola_float.png` },
            { id: 505, cat: 'drink', name: 'コーヒー', nameEn: 'Coffee', price: 165, img: `${IMG_BASE}/dessert/pho_coffee.png` },
            { id: 307, cat: 'gunkan', name: 'かっぱ巻', nameEn: 'Cucumber Roll', price: 110, img: "https://www.hama-sushi.co.jp/assets/menu/img/gunkan/pho_kapamaki.png" },
            { id: 308, cat: 'gunkan', name: 'まぐろたたき巻', nameEn: 'Minced Tuna Roll', price: 110, img: "https://www.hama-sushi.co.jp/assets/menu/img/gunkan/pho_maguro_tekka_maki.png" },
            { id: 109, cat: 'limited', name: '三陸産 大切り銀鮭', nameEn: 'Large Silver Salmon', price: 165, img: "https://www.hama-sushi.co.jp/assets/menu/img/fair/sanrikusan_tairiku_oogiri_ginjake.png" },
            { id: 110, cat: 'limited', name: '広島県産 牡蠣のカキフライつつみ', nameEn: 'Fried Oyster Wrap', price: 110, img: "https://www.hama-sushi.co.jp/assets/menu/img/fair/hiroshimakensan_kaki_no_kakihurai_tsutsumi.png" },
            { id: 111, cat: 'limited', name: 'いわて牛五ツ星握り', nameEn: 'Iwate Beef Nigiri', price: 319, img: "https://www.hama-sushi.co.jp/assets/menu/img/fair/iwategyu_itsutsuboshi_nigiri1.png" }
        ];

        const AD_IMAGES = [
            "https://www.hama-sushi.co.jp/assets/top/img/slider/main_brand.jpg",
            "https://www.hama-sushi.co.jp/assets/top/img/slider/coffee.jpg",
            "https://www.hama-sushi.co.jp/assets/top/img/slider/fair.jpg",
            "https://www.hama-sushi.co.jp/assets/top/img/slider/hinamatsuri_2026.jpg",
            "https://www.hama-sushi.co.jp/assets/top/img/slider/senior_pass.jpg",
            "https://www.hama-sushi.co.jp/assets/top/img/slider/open_10am.jpg",
            "https://www.hama-sushi.co.jp/assets/top/img/slider/netstore_syoyu.jpg",
            "https://www.hama-sushi.co.jp/assets/top/img/slider/fair_trade.jpg"
        ];

        const app = {
            state: {
                lang: 'ja',
                history: [],
                activeCat: 'limited',
                activeItem: null,
                currentQty: 1,
                pinBuffer: '',
                peer: null,
                conn: null,
                myId: null,
                isHost: false,
                idleTime: 0,
                screensaverActive: false,
                currentSlide: 0,
                slideInterval: null,
                isCalling: false
            },

            init: () => {
                app.ui.renderCategories();
                app.ui.renderMenu('limited');
                app.ui.updateHistory();
                app.screensaver.init();
                setInterval(app.ui.updateClock, 1000);
            },

            // --- HELPER: Translate ---
            t: (key) => TRANSLATIONS[app.state.lang][key] || key,
            
            // --- Helper: Get Item Name (Lang Aware) ---
            getItemName: (item) => app.state.lang === 'en' ? (item.nameEn || item.name) : item.name,

            // --- UI HELPERS ---
            ui: {
                setLang: (lang) => {
                    app.state.lang = lang;
                    // Update Text Elements
                    document.querySelectorAll('[data-t]').forEach(el => {
                        el.innerText = app.t(el.dataset.t);
                    });
                    // Re-render components
                    app.ui.renderCategories();
                    app.ui.renderMenu(app.state.activeCat);
                    app.ui.updateHistory();
                    
                    // Update Dynamic Button Text
                    if(app.state.isCalling) {
                        document.getElementById('btn-call').innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${app.t('calling')}`;
                    } else {
                        document.getElementById('btn-call').innerHTML = `<i class="fa-solid fa-bell"></i> ${app.t('call')}`;
                    }
                },
                switchView: (id) => {
                    document.querySelectorAll('body > div[id^="view-"]').forEach(el => el.classList.add('hidden'));
                    document.querySelectorAll('body > div[id^="view-"]').forEach(el => el.classList.remove('flex'));
                    const target = document.getElementById(`view-${id}`);
                    target.classList.remove('hidden');
                    target.classList.add('flex');
                    if(id === 'customer') target.classList.add('flex-row');
                    if(id === 'standby' || id === 'kitchen') target.classList.add('flex-col');
                },
                renderCategories: () => {
                    document.getElementById('category-nav').innerHTML = CATEGORIES.map(c => `
                        <button onclick="app.ui.setCategory('${c.id}')" class="group h-10 md:h-12 px-4 md:px-5 flex items-center justify-center gap-2 font-bold text-sm md:text-base transition-all rounded-full whitespace-nowrap border border-transparent ${c.id === app.state.activeCat ? 'bg-[#002B49] text-white shadow-md' : 'bg-transparent text-gray-500 hover:bg-gray-100 hover:text-gray-700'}">
                            <i class="fa-solid ${c.icon} ${c.id === app.state.activeCat ? 'text-[#C5A059]' : 'text-gray-400'}"></i> ${app.state.lang === 'en' ? c.nameEn : c.name}
                        </button>
                    `).join('');
                },
                setCategory: (id) => {
                    app.state.activeCat = id;
                    app.ui.renderCategories();
                    app.ui.renderMenu(id);
                    app.audio.play('tap');
                },
                renderMenu: (cat) => {
                    const items = MENU_DB.filter(i => i.cat === cat);
                    document.getElementById('menu-grid').innerHTML = items.map(item => `
                        <div class="bg-white rounded-2xl shadow-sm overflow-hidden cursor-pointer flex flex-col h-full border border-gray-100 group hover:shadow-xl hover:-translate-y-1 transition-all active:scale-95 duration-200 menu-item-container" onclick="app.order.openDetail(${item.id})">
                            <div class="aspect-[4/3] w-full bg-gray-50 relative overflow-hidden img-container">
                                <img src="${item.img}" class="real-image" onload="this.classList.add('loaded')" onerror="this.closest('.menu-item-container').style.display='none'">
                            </div>
                            <div class="p-4 flex-1 flex flex-col justify-between">
                                <h3 class="font-bold text-[#002B49] text-base md:text-lg leading-tight mb-2 font-serif">${app.getItemName(item)}</h3>
                                <div class="flex items-end justify-between">
                                    <span class="text-xs text-gray-400 font-bold bg-gray-100 px-2 py-1 rounded">税込</span>
                                    <span class="text-xl md:text-2xl font-black text-[#E60012] font-sans">¥${item.price}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                },
                updateHistory: () => {
                    const total = app.state.history.reduce((s, i) => s + i.price, 0);
                    document.getElementById('cart-total').innerText = total.toLocaleString();

                    const histList = document.getElementById('view-history-list');
                    if(app.state.history.length === 0) {
                        histList.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-300"><i class="fa-solid fa-utensils text-4xl mb-3 opacity-50"></i></div>`;
                    } else {
                        const histRev = [...app.state.history].reverse();
                        histList.innerHTML = histRev.map(item => {
                            const isCooking = item.status === 'cooking';
                            // 調理中はアイコン変更 & アニメーションクラス付与
                            const statusIcon = isCooking 
                                ? '<i class="fa-solid fa-fire-burner text-[#E60012] animate-bounce"></i>' 
                                : '<i class="fa-solid fa-circle-check text-green-500"></i>';
                            const statusText = isCooking ? app.t('cooking') : app.t('served');
                            
                            // 調理中のカードデザイン変更 (animate-cooking-cardを追加)
                            const cardClass = isCooking 
                                ? 'bg-orange-50 border-orange-200 animate-cooking-card' 
                                : 'bg-gray-50 border-gray-100 opacity-60';

                            return `
                            <div class="flex gap-3 p-3 rounded-xl border ${cardClass} shadow-sm mb-2 transition-all">
                                <div class="flex flex-col w-20 shrink-0">
                                    <div class="w-full h-14 rounded-lg bg-white overflow-hidden mb-1 border border-gray-100">
                                        <img src="${item.img}" class="w-full h-full object-cover">
                                    </div>
                                    <div class="text-[10px] text-center font-bold ${isCooking ? 'text-[#E60012]' : 'text-green-600'} bg-white/80 rounded py-0.5 shadow-sm border border-gray-100">
                                        ${statusIcon} ${statusText}
                                    </div>
                                </div>
                                <div class="flex-1 flex justify-between items-center">
                                    <div class="font-bold text-[#002B49] text-sm leading-tight pr-2 flex-1">${app.getItemName(item)}</div>
                                    <div class="font-black text-lg text-gray-800 shrink-0 text-right">¥${item.price}</div>
                                </div>
                            </div>
                        `}).join('');
                    }
                },
                showCheck: () => {
                    const total = app.state.history.reduce((s, i) => s + i.price, 0);
                    document.getElementById('check-total').innerText = total.toLocaleString();
                    document.getElementById('check-count').innerText = app.state.history.length;
                    app.ui.openModal('modal-check');
                },
                openModal: (id) => {
                    document.getElementById(id).classList.remove('hidden');
                    document.getElementById(id).classList.add('flex');
                },
                openCallModal: () => {
                    app.audio.play('tap');
                    app.ui.openModal('modal-call');
                },
                closeModal: (id) => {
                    document.getElementById(id).classList.add('hidden');
                    document.getElementById(id).classList.remove('flex');
                },
                triggerDelivery: (payload) => {
                    const items = Array.isArray(payload) ? payload : [payload];
                    const grid = document.getElementById('delivery-grid');
                    const modal = document.getElementById('modal-delivery');
                    
                    const newItemsHtml = items.map(item => `
                        <div class="bg-white rounded-3xl p-4 shadow-lg flex flex-col items-center animate-pop">
                            <div class="w-full aspect-[4/3] rounded-2xl mb-4 bg-gray-100 relative overflow-hidden img-container">
                                 <img src="${item.img}" class="real-image loaded" onerror="this.classList.remove('loaded')">
                            </div>
                             <div class="text-xl md:text-2xl font-black text-[#002B49] text-center font-serif leading-tight">${app.getItemName(item)}</div>
                        </div>
                    `).join('');

                    if (modal.classList.contains('hidden')) {
                        grid.innerHTML = newItemsHtml;
                        app.ui.openModal('modal-delivery');
                    } else {
                        grid.insertAdjacentHTML('beforeend', newItemsHtml);
                        setTimeout(() => { grid.parentElement.scrollTop = grid.parentElement.scrollHeight; }, 100);
                    }

                    app.audio.play('melody');
                    setTimeout(() => { app.audio.speak(app.t('arriving')); }, 1000);
                },
                closeDelivery: () => {
                    app.ui.closeModal('modal-delivery');
                    app.audio.play('success');
                    app.audio.speak(app.t('received')); // Fixed to read correct lang
                },
                updateClock: () => {
                    const now = new Date();
                    const t = now.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'});
                    const el = document.getElementById('kitchen-clock');
                    if(el) el.innerText = t;
                }
            },

            auth: {
                open: () => {
                    app.state.pinBuffer = '';
                    app.auth.updateDisplay();
                    app.ui.openModal('modal-auth');
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('mode-select').classList.add('hidden');
                    document.getElementById('mode-select').classList.remove('flex');
                    document.getElementById('client-connect').classList.add('hidden');
                    document.getElementById('client-connect').classList.remove('flex');
                },
                close: () => { app.ui.closeModal('modal-auth'); },
                type: (n) => {
                    if(app.state.pinBuffer.length < 4) {
                        app.state.pinBuffer += n;
                        app.auth.updateDisplay();
                        if(app.state.pinBuffer.length === 4) setTimeout(app.auth.check, 200);
                    }
                },
                clear: () => { app.state.pinBuffer = ''; app.auth.updateDisplay(); },
                updateDisplay: () => {
                    for(let i=1; i<=4; i++) {
                        const el = document.getElementById(`pin-${i}`);
                        el.innerText = i <= app.state.pinBuffer.length ? '●' : '';
                        if (i <= app.state.pinBuffer.length) {
                            el.classList.remove('bg-gray-100');
                            el.classList.add('bg-[#C5A059]', 'text-white');
                        } else {
                            el.classList.add('bg-gray-100');
                            el.classList.remove('bg-[#C5A059]', 'text-white');
                        }
                    }
                },
                check: () => {
                    if(app.state.pinBuffer === '9999') {
                        app.audio.play('success');
                        document.getElementById('auth-screen').classList.add('hidden');
                        document.getElementById('mode-select').classList.remove('hidden');
                        document.getElementById('mode-select').classList.add('flex');
                    } else {
                        app.state.pinBuffer = '';
                        app.auth.updateDisplay();
                    }
                }
            },

            customer: {
                start: () => {
                    app.requestFullscreen();
                    app.audio.play('welcome');
                    app.audio.speak(app.t('welcome'));
                    app.ui.switchView('customer');
                },
                finishEat: () => {
                    const msg = app.state.lang === 'en' ? "Thank you very much." : "本日はご来店、ありがとうございました。";
                    app.audio.speak(msg);
                    app.ui.closeModal('modal-check');
                    app.state.history = [];
                    app.ui.updateHistory();
                    app.ui.switchView('standby');
                }
            },

            order: {
                openDetail: (id) => {
                    const item = MENU_DB.find(i => i.id === id);
                    app.state.activeItem = item;
                    app.state.currentQty = 1;
                    
                    const imgEl = document.getElementById('detail-img');
                    imgEl.classList.remove('loaded');
                    imgEl.src = "";
                    setTimeout(() => { imgEl.src = item.img; }, 10);

                    document.getElementById('detail-name').innerText = app.getItemName(item);
                    document.getElementById('detail-price').innerText = item.price;
                    document.getElementById('detail-qty').innerText = 1;
                    
                    const catName = app.state.lang === 'en' 
                        ? CATEGORIES.find(c=>c.id === item.cat).nameEn 
                        : CATEGORIES.find(c=>c.id === item.cat).name;
                    document.getElementById('detail-cat-badge').innerText = catName;

                    const friedIds = [403, 404, 405];
                    const warningEl = document.getElementById('detail-warning');
                    if (friedIds.includes(item.id)) {
                        warningEl.classList.remove('hidden');
                    } else {
                        warningEl.classList.add('hidden');
                    }

                    app.ui.openModal('modal-detail');
                    app.audio.play('tap');
                },
                adjustQty: (delta) => {
                    let newQty = app.state.currentQty + delta;
                    if (newQty < 1) newQty = 1;
                    if (newQty > 10) newQty = 10;
                    app.state.currentQty = newQty;
                    document.getElementById('detail-qty').innerText = newQty;
                    app.audio.play('tap');
                },
                confirm: () => {
                    const item = app.state.activeItem;
                    const qty = app.state.currentQty;
                    const itemsToSend = [];
                    for(let i=0; i<qty; i++) {
                        itemsToSend.push({ ...item, uid: Date.now() + Math.random() + i, status: 'cooking' });
                    }
                    const data = {
                        tableId: 12,
                        items: itemsToSend,
                        time: new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'})
                    };
                    app.state.history.push(...itemsToSend);
                    if(app.state.conn && app.state.conn.open) {
                        app.state.conn.send({ type: 'ORDER', payload: data });
                    }
                    app.ui.closeModal('modal-detail');
                    app.ui.updateHistory();
                    app.audio.play('success');
                    app.audio.speak(app.t('order')); 
                },
                markAsServed: (servedItems) => {
                    const items = Array.isArray(servedItems) ? servedItems : [servedItems];
                    items.forEach(sItem => {
                        const target = app.state.history.find(h => h.uid === sItem.uid);
                        if(target) target.status = 'served';
                    });
                    app.ui.updateHistory();
                },
                callStaff: () => {
                    app.ui.closeModal('modal-call');
                    if(app.state.conn && app.state.conn.open) {
                        app.state.conn.send({ type: 'CALL' });
                    }
                    app.audio.play('chime');
                    app.state.isCalling = true;
                    const btn = document.getElementById('btn-call');
                    btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${app.t('calling')}`;
                    btn.classList.remove('bg-white/10');
                    btn.classList.add('bg-[#E60012]', 'border-transparent');
                },
                resolveCall: () => {
                    app.state.isCalling = false;
                    const btn = document.getElementById('btn-call');
                    btn.innerHTML = `<i class="fa-solid fa-bell"></i> ${app.t('call')}`;
                    btn.classList.add('bg-white/10');
                    btn.classList.remove('bg-[#E60012]', 'border-transparent');
                    app.audio.play('success');
                }
            },

            // --- KITCHEN LOGIC ---
            kitchen: {
                startHost: () => {
                    app.auth.close();
                    app.p2p.initHost();
                    app.requestFullscreen();
                    app.ui.switchView('kitchen');
                },
                addOrder: (data) => {
                    app.audio.play('chime');
                    const grid = document.getElementById('kitchen-grid');
                    const card = document.createElement('div');
                    card.className = "bg-gray-800 rounded-xl p-4 shadow-lg relative overflow-hidden animate-fade border-l-4 border-[#C5A059]";
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-700">
                            <span class="text-[#C5A059] font-black text-2xl">卓番 ${data.tableId}</span>
                            <span class="text-gray-400 font-mono text-lg">${data.time}</span>
                        </div>
                        <div class="space-y-2 mb-4 text-lg max-h-[200px] overflow-y-auto">
                            ${data.items.map(i => `
                                <div class="flex justify-between items-center pb-1 border-b border-gray-700/50">
                                    <span class="font-bold">${i.name}</span>
                                    <span class="bg-gray-700 px-2 rounded text-sm">1</span>
                                </div>
                            `).join('')}
                        </div>
                        <button class="w-full bg-[#002B49] hover:bg-[#003865] text-white py-3 rounded-lg font-bold transition-all flex items-center justify-center gap-2 text-xl active:scale-95">
                            <i class="fa-solid fa-bell-concierge"></i> 調理完了
                        </button>
                    `;
                    card.querySelector('button').onclick = () => {
                        card.style.opacity = '0.5';
                        card.querySelector('button').innerText = "提供済み";
                        card.querySelector('button').disabled = true;
                        if(app.state.conn) {
                            app.state.conn.send({ type: 'COOKED', payload: data.items });
                        }
                        setTimeout(() => card.remove(), 2000);
                    };
                    grid.prepend(card);
                },
                showCallAlert: () => {
                    app.audio.play('alarm');
                    const overlay = document.getElementById('kitchen-alert-overlay');
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');
                },
                resolveCall: () => {
                    const overlay = document.getElementById('kitchen-alert-overlay');
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                    if(app.state.conn) {
                        app.state.conn.send({ type: 'CALL_RESOLVED' });
                    }
                }
            },

            // --- SCREENSAVER ---
            screensaver: {
                init: () => {
                    const container = document.getElementById('slideshow-container');
                    AD_IMAGES.forEach((src, idx) => {
                        const img = document.createElement('img');
                        img.src = src;
                        img.className = `slide-image ${idx === 0 ? 'active' : ''}`;
                        img.id = `slide-${idx}`;
                        container.appendChild(img);
                    });
                    setInterval(() => {
                        const customerView = document.getElementById('view-customer');
                        const isCustomerActive = !customerView.classList.contains('hidden');
                        const noModals = document.querySelectorAll('[id^="modal-"]:not(.hidden)').length === 0;
                        if (isCustomerActive && noModals && !app.state.screensaverActive) {
                            app.state.idleTime++;
                            if (app.state.idleTime >= 30) app.screensaver.start();
                        }
                    }, 1000);
                    ['click', 'touchstart', 'mousemove', 'scroll'].forEach(evt => {
                        document.addEventListener(evt, () => { app.state.idleTime = 0; });
                    });
                },
                start: () => {
                    app.state.screensaverActive = true;
                    document.getElementById('view-screensaver').classList.remove('hidden');
                    app.state.slideInterval = setInterval(app.screensaver.nextSlide, 5000);
                },
                stop: () => {
                    app.state.screensaverActive = false;
                    app.state.idleTime = 0;
                    document.getElementById('view-screensaver').classList.add('hidden');
                    clearInterval(app.state.slideInterval);
                },
                nextSlide: () => {
                    const next = (app.state.currentSlide + 1) % AD_IMAGES.length;
                    document.getElementById(`slide-${app.state.currentSlide}`).classList.remove('active');
                    document.getElementById(`slide-${next}`).classList.add('active');
                    app.state.currentSlide = next;
                }
            },

            // --- P2P LOGIC ---
            p2p: {
                initHost: () => {
                    const shortId = Math.floor(1000 + Math.random() * 9000).toString();
                    const fullId = APP_PREFIX + shortId;
                    app.state.peer = new Peer(fullId);
                    app.state.isHost = true;
                    app.state.peer.on('open', (id) => {
                        app.state.myId = shortId;
                        document.getElementById('kitchen-id-display').innerText = shortId;
                    });
                    app.state.peer.on('connection', (conn) => {
                        app.state.conn = conn;
                        app.p2p.setupConn(conn);
                        app.audio.play('chime');
                        const el = document.getElementById('kitchen-connection-status');
                        el.innerHTML = `<i class="fa-solid fa-circle text-green-400 text-sm animate-pulse"></i> Online`;
                    });
                },
                showConnectUI: () => {
                    document.getElementById('mode-select').classList.remove('flex');
                    document.getElementById('mode-select').classList.add('hidden');
                    document.getElementById('client-connect').classList.remove('hidden');
                    document.getElementById('client-connect').classList.add('flex');
                },
                connectToHost: () => {
                    const input = document.getElementById('target-id-input').value;
                    if(input.length !== 4) return alert("4桁の数字を入力してください");
                    const targetFullId = APP_PREFIX + input;
                    const msg = document.getElementById('connect-msg');
                    msg.innerText = "接続中...";
                    app.state.peer = new Peer();
                    app.state.peer.on('open', () => {
                        const conn = app.state.peer.connect(targetFullId);
                        app.state.conn = conn;
                        conn.on('open', () => {
                            msg.innerText = "接続成功！";
                            setTimeout(() => { app.auth.close(); }, 1000);
                            app.p2p.setupConn(conn);
                        });
                        conn.on('error', (err) => { msg.innerText = "接続失敗"; });
                        setTimeout(() => { if(!conn.open) msg.innerText = "応答なし"; }, 5000);
                    });
                },
                setupConn: (conn) => {
                    conn.on('data', (data) => {
                        if (app.state.isHost) {
                            if (data.type === 'ORDER') app.kitchen.addOrder(data.payload);
                            if (data.type === 'CALL') app.kitchen.showCallAlert();
                        } else {
                            if (data.type === 'COOKED') {
                                app.order.markAsServed(data.payload);
                                app.ui.triggerDelivery(data.payload);
                            }
                            if (data.type === 'CALL_RESOLVED') {
                                app.order.resolveCall();
                            }
                        }
                    });
                }
            },

            audio: {
                ctx: null,
                init: () => { if(!app.audio.ctx) app.audio.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
                play: (type) => {
                    app.audio.init();
                    if(app.audio.ctx.state === 'suspended') app.audio.ctx.resume();
                    const ctx = app.audio.ctx;
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    const now = ctx.currentTime;
                    if(type === 'tap') {
                        osc.frequency.setValueAtTime(800, now);
                        gain.gain.setValueAtTime(0.05, now);
                        gain.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
                        osc.start(now); osc.stop(now + 0.05);
                    } else if(type === 'chime') {
                        osc.type = 'sine';
                        osc.frequency.setValueAtTime(660, now);
                        osc.frequency.setValueAtTime(550, now+0.3);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.linearRampToValueAtTime(0, now + 1.0);
                        osc.start(now); osc.stop(now + 1.0);
                    } else if (type === 'success') {
                        osc.type = 'triangle';
                        osc.frequency.setValueAtTime(523, now);
                        osc.frequency.setValueAtTime(659, now + 0.1);
                        gain.gain.setValueAtTime(0.1, now);
                        gain.gain.linearRampToValueAtTime(0, now + 0.4);
                        osc.start(now); osc.stop(now + 0.4);
                    } else if (type === 'welcome') {
                         osc.type = 'sine';
                         osc.frequency.setValueAtTime(554, now);
                         osc.frequency.setValueAtTime(659, now + 0.2);
                         gain.gain.setValueAtTime(0.1, now);
                         gain.gain.linearRampToValueAtTime(0, now + 1.0);
                         osc.start(now); osc.stop(now + 1.0);
                    } else if (type === 'alarm') {
                         osc.type = 'sawtooth';
                         osc.frequency.setValueAtTime(800, now);
                         osc.frequency.linearRampToValueAtTime(400, now + 0.3);
                         gain.gain.setValueAtTime(0.2, now);
                         gain.gain.linearRampToValueAtTime(0, now + 0.3);
                         osc.start(now); osc.stop(now + 0.3);
                    } else if (type === 'melody') {
                        const notes = [523.25, 659.25, 783.99, 1046.50];
                        const now = ctx.currentTime;
                        notes.forEach((freq, i) => {
                            const osc = ctx.createOscillator();
                            const gain = ctx.createGain();
                            osc.connect(gain);
                            gain.connect(ctx.destination);
                            osc.type = 'sine';
                            osc.frequency.value = freq;
                            gain.gain.setValueAtTime(0, now);
                            gain.gain.linearRampToValueAtTime(0.1, now + i * 0.15);
                            gain.gain.exponentialRampToValueAtTime(0.001, now + i * 0.15 + 0.4);
                            osc.start(now + i * 0.15);
                            osc.stop(now + i * 0.15 + 0.5);
                        });
                        return;
                    }
                },
                speak: (text) => {
                    if('speechSynthesis' in window) {
                        const u = new SpeechSynthesisUtterance(text);
                        u.lang = 'ja-JP';
                        u.rate = 1.0;
                        window.speechSynthesis.speak(u);
                    }
                }
            },
            
            requestFullscreen: () => {
                const doc = document.documentElement;
                if (doc.requestFullscreen) doc.requestFullscreen().catch(() => {});
                else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen().catch(() => {});
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>
